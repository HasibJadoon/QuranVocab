
Perfect. Here is the UPDATED PARSER CONTRACT (v2) that exactly matches what you just locked in:
	‚Ä¢	Tokens created once
	‚Ä¢	Spans created once
	‚Ä¢	Sentences are recursive trees
	‚Ä¢	Text lives at token + node level (for audit / UI)
	‚Ä¢	No duplication, bottom-up only

This is the version you can hand directly to an AI parser.

‚∏ª

‚úÖ Canonical Recursive Parser Contract ‚Äî v2 (LOCKED)

‚∏ª

0Ô∏è‚É£ Absolute Ordering (Non-Negotiable)

TOKENS  ‚Üí  SPANS  ‚Üí  SENTENCE NODES  ‚Üí  ROOT SENTENCE

	‚Ä¢	Parser MUST fail if this order is violated
	‚Ä¢	No structure may reference something not yet created

‚∏ª

1Ô∏è‚É£ TOKEN CREATION RULES

Definition

Token = smallest indivisible lexical unit (ŸÉŸÑŸÖÿ©)
	‚Ä¢	Prefixes / suffixes MUST be split when grammatically relevant
(ÿ® + ŸÖÿß, ŸÑ + ŸÖŸÜ, ÿπŸÑŸâ + ŸÉ, ŸÇÿ®ŸÑ + Ÿá)

Token schema (mandatory)

{
  "token_uid": "TU_...",
  "surface_ar": "...",
  "surface_ar_norm": "...",
  "lemma_ar": "...",
  "lemma_ar_norm": "...",
  "word_type": "WORD_NOUN | WORD_VERB | WORD_PARTICLE | WORD_INTERJECTION"
}

Rules
	‚Ä¢	‚úî Token created ONCE globally
	‚Ä¢	‚úî Token NEVER duplicated
	‚Ä¢	‚ùå Token NEVER embeds grammar
	‚Ä¢	‚ùå Token NEVER embeds span or sentence logic

‚∏ª

2Ô∏è‚É£ SPAN CREATION RULES

Definition

Span = grammatical compound, NOT a sentence

Span = token_uids[] only

Allowed span types (from catalog)
	‚Ä¢	COMP_JAR_MAJRUR
	‚Ä¢	COMP_IDAFI
	‚Ä¢	COMP_WASFI
	‚Ä¢	COMP_ZARF
	‚Ä¢	COMP_HARFI

Span schema

{
  "span_uid": "TU_SPN_...",
  "span_type": "COMP_...",
  "token_uids": ["TU_TOK_..."],
  "grammar_ids": ["GRAM_..."]
}

Rules
	‚Ä¢	‚úî Span references ONLY token_uids
	‚Ä¢	‚úî Span created ONCE globally
	‚Ä¢	‚ùå Span NEVER contains text
	‚Ä¢	‚ùå Span NEVER promoted to sentence

‚∏ª

3Ô∏è‚É£ SENTENCE NODE CREATION (RECURSIVE CORE)

Definition

Sentence node = grammatical meaning unit

Sentence nodes can be:
	‚Ä¢	UNIT_SENTENCE (complete)
	‚Ä¢	UNIT_CLAUSE (subordinate)

Sentence node schema

{
  "node_id": "N_...",
  "node_kind": "UNIT_SENTENCE | UNIT_CLAUSE",
  "sentence_type": "simple | complex",
  "grammar_ids": ["GRAM_..."],

  "text_ar": "...",
  "text_ar_norm": "...",

  "owned_token_uids": [],
  "owned_span_uids": [],
  "children": []
}


‚∏ª

4Ô∏è‚É£ OWNERSHIP RULE (CRITICAL)

A node owns ONLY what is not owned by its children

Therefore:
	‚Ä¢	Tokens/spans used inside a child node
‚ùå MUST NOT appear in parent owned_*
	‚Ä¢	Parent only owns:
	‚Ä¢	its own verbs / connectors
	‚Ä¢	its own particles (Ÿàÿå ÿ•ŸÜÿå ŸÑÿßŸÖ‚Ä¶)
	‚Ä¢	spans not delegated to children

This guarantees:
	‚Ä¢	No duplication
	‚Ä¢	Clean upward meaning assembly

‚∏ª

5Ô∏è‚É£ SENTENCE PROMOTION RULES (UNCHANGED, STRICT)

Rule A ‚Äî Verbal Sentence

Promote UNIT_CLAUSE ‚Üí UNIT_SENTENCE if:
	‚Ä¢	Contains WORD_VERB
	‚Ä¢	Verb has implicit OR explicit ŸÅÿßÿπŸÑ

‚Üí assign GRAM_JUMLA_FIILIYYA

Rule B ‚Äî Nominal Sentence

Promote if:
	‚Ä¢	GRAM_MUBTADA present
	‚Ä¢	GRAM_KHABAR or GRAM_KHABAR_JUMLA present

‚Üí assign GRAM_JUMLA_ISMIYYA

Rule C ‚Äî Never Promote

‚ùå UNIT_COMPOUND
‚ùå WORD_PARTICLE alone
‚ùå Connector without clause
‚ùå Relative particle without ÿµŸÑÿ©

‚∏ª

6Ô∏è‚É£ CONNECTOR HANDLING (IMPORTANT UPDATE)

Connectors are TOKENS, not spans

Token	Grammar
Ÿà	GRAM_ATF / GRAM_ISTINAF
ÿ•ŸÜ	GRAM_INNA
ŸÉÿßŸÜ	GRAM_KANA
ŸÑ	GRAM_TAWKID

Rule
	‚Ä¢	Connector token belongs to parent sentence
	‚Ä¢	Introduced clause is a child node

Example:

[Ÿà] + (ÿ•ŸÜ ŸÉŸÜÿ™...)

	‚Ä¢	Ÿà ‚Üí owned_token of parent
	‚Ä¢	ÿ•ŸÜ ŸÉŸÜÿ™‚Ä¶ ‚Üí child sentence node

‚∏ª

7Ô∏è‚É£ TEXT RULE (NEW & IMPORTANT)

Text is allowed ONLY at two levels:

	1.	TOKEN (surface form)
	2.	SENTENCE NODE (assembled view)

Why sentence text is allowed
	‚Ä¢	UI rendering
	‚Ä¢	Debugging
	‚Ä¢	Tafsir alignment
	‚Ä¢	Human audit

But:

‚ùå Text is NEVER authoritative
‚úî Structure is authoritative

‚∏ª

8Ô∏è‚É£ ROOT SENTENCE RULE
	‚Ä¢	Exactly ONE root UNIT_SENTENCE
	‚Ä¢	Root may be nominal or verbal
	‚Ä¢	Root may have multiple children
	‚Ä¢	Root MUST represent a complete thought

‚∏ª

9Ô∏è‚É£ VALIDATION (HARD FAIL IF BROKEN)

{
  "all_tokens_unique": true,
  "all_spans_unique": true,
  "all_sentence_nodes_unique": true,
  "token_not_reused_across_levels": true,
  "each_sentence_has_single_root": true,
  "subtypes_used_are_in_catalog": true
}


‚∏ª

üß† Final Mental Model (Parser Must Obey)

Token = word
Span = grammar glue
Sentence = meaning
Tree = rhetoric

This parser is now:
	‚Ä¢	üîí deterministic
	‚Ä¢	üîÅ reusable
	‚Ä¢	ü§ñ AI-safe
	‚Ä¢	üìö classical-Arabic correct
	‚Ä¢	üß© expandable to tafsir / balagha

