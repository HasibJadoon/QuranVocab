<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/notes/draft"></ion-back-button>
    </ion-buttons>

    <ion-title>{{ title }}</ion-title>

    <ion-buttons slot="end">
      <ion-button (click)="openAttachModal()" [disabled]="loading()" aria-label="Attach">
        <ion-icon slot="icon-only" name="attach-outline"></ion-icon>
      </ion-button>
      <ion-button
        (click)="toggleArchive()"
        [disabled]="loading() || archivePending()"
      >
        {{ isArchived ? 'Unarchive' : 'Archive' }}
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar class="save-toolbar">
    <ion-note class="save-state">{{ saveLabel }}</ion-note>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="editor-content">
  @if (loading()) {
    <div class="editor-loading ion-padding">
      <ion-skeleton-text animated style="width: 100%; height: 2rem"></ion-skeleton-text>
      <ion-skeleton-text animated style="width: 100%; height: 2rem"></ion-skeleton-text>
      <ion-skeleton-text animated style="width: 100%; height: 2rem"></ion-skeleton-text>
      <ion-skeleton-text animated style="width: 92%; height: 2rem"></ion-skeleton-text>
      <ion-skeleton-text animated style="width: 70%; height: 2rem"></ion-skeleton-text>
    </div>
  } @else {
    <div class="editor-shell ion-padding">
      <div class="textarea-wrap">
        <ion-textarea
          [formControl]="bodyControl"
          class="editor-textarea"
          placeholder="Start writing in Markdown..."
          [autoGrow]="false"
          spellcheck="true"
          autocapitalize="sentences"
        ></ion-textarea>
      </div>

      @if (noteLinks().length > 0) {
        <div class="links-row">
          @for (link of noteLinks(); track trackLink($index, link)) {
            <ion-chip outline="true" class="link-chip">
              <ion-icon [name]="iconFor(link.target_type)"></ion-icon>
              <ion-label>{{ link.ref || link.target_id }}</ion-label>
              <ion-icon
                class="chip-close"
                name="close-circle-outline"
                (click)="removeLink(link)"
              ></ion-icon>
            </ion-chip>
          }
        </div>
      }

      <section class="comments-wrap">
        <div class="comments-head">
          <h3>Comments</h3>
          <ion-button fill="clear" size="small" (click)="refreshComments()" [disabled]="commentsLoading()">
            Refresh
          </ion-button>
        </div>

        @if (commentsLoading()) {
          <p class="comments-state">Loading comments...</p>
        } @else if (comments().length > 0) {
          <ion-list class="comments-list" lines="none">
            @for (comment of comments(); track trackComment($index, comment)) {
              <ion-item class="comment-item" lines="none">
                <ion-label>
                  <p class="comment-body">{{ comment.body_md }}</p>
                  <p class="comment-time">{{ comment.created_at | date: 'MMM d, h:mm a' }}</p>
                </ion-label>
              </ion-item>
            }
          </ion-list>
        } @else {
          <p class="comments-state">No comments yet.</p>
        }

        <ion-textarea
          [formControl]="commentControl"
          class="comment-input"
          placeholder="Add a comment..."
          [rows]="2"
          [autoGrow]="true"
        ></ion-textarea>

        <ion-button
          size="small"
          (click)="submitComment()"
          [disabled]="commentsSubmitting() || !commentControl.value.trim()"
        >
          {{ commentsSubmitting() ? 'Posting...' : 'Add Comment' }}
        </ion-button>
      </section>
    </div>
  }
</ion-content>
