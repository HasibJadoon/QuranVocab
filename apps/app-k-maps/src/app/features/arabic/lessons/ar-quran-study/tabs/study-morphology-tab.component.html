<section class="study-tab study-tab--morphology">
  <app-targeted-notes-panel
    *ngIf="taskTarget as target"
    class="study-targeted-notes"
    [target]="target"
    placeholder="Capture a morphology note..."
  ></app-targeted-notes-panel>

  <ion-accordion-group class="study-accordion" expand="inset">
    <ion-accordion class="study-accordion-item" value="nouns">
      <ion-item slot="header" class="study-accordion-header">
        <ion-label>Nouns</ion-label>
        <ion-note slot="end">{{ nouns.length }}</ion-note>
      </ion-item>
      <div slot="content" class="study-accordion-content">
        <p class="study-empty" *ngIf="!nouns.length">No noun morphology entries found.</p>
        <ion-grid class="study-morph-grid" *ngIf="nouns.length">
          <ion-row class="study-morph-row">
            <ion-col class="study-morph-col" size="6" *ngFor="let item of nouns">
              <div class="study-morph-tile-wrap">
                <button type="button" class="study-morph-tile" (click)="openMorphologyDetails(item)">
                  <span class="study-morph-label" dir="rtl" translate="no">
                    <strong class="study-morph-word arabic">{{ item.word }}</strong>
                    <small class="study-morph-root arabic" *ngIf="item.root">({{ item.root }})</small>
                  </span>
                </button>
                <ion-button class="study-morph-note-btn" size="small" fill="clear" (click)="toggleWordNotes($event, item)">
                  Notes
                </ion-button>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>
      </div>
    </ion-accordion>

    <ion-accordion class="study-accordion-item" value="verbs">
      <ion-item slot="header" class="study-accordion-header">
        <ion-label>Verbs</ion-label>
        <ion-note slot="end">{{ verbs.length }}</ion-note>
      </ion-item>
      <div slot="content" class="study-accordion-content">
        <p class="study-empty" *ngIf="!verbs.length">No verb morphology entries found.</p>
        <ion-grid class="study-morph-grid" *ngIf="verbs.length">
          <ion-row class="study-morph-row">
            <ion-col class="study-morph-col" size="6" *ngFor="let item of verbs">
              <div class="study-morph-tile-wrap">
                <button type="button" class="study-morph-tile" (click)="openMorphologyDetails(item)">
                  <span class="study-morph-label" dir="rtl" translate="no">
                    <strong class="study-morph-word arabic">{{ item.word }}</strong>
                    <small class="study-morph-root arabic" *ngIf="item.root">({{ item.root }})</small>
                  </span>
                </button>
                <ion-button class="study-morph-note-btn" size="small" fill="clear" (click)="toggleWordNotes($event, item)">
                  Notes
                </ion-button>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>
      </div>
    </ion-accordion>
  </ion-accordion-group>

  <app-targeted-notes-panel
    *ngIf="activeWordNoteTarget"
    class="study-targeted-notes study-targeted-notes--inline"
    [target]="activeWordNoteTarget!"
    placeholder="Add a note for this word..."
  ></app-targeted-notes-panel>

  <ion-modal class="study-morph-modal" [isOpen]="isMorphologyModalOpen" (didDismiss)="onMorphologyModalDismiss()">
    <ng-template>
      <ion-header>
        <ion-toolbar class="study-morph-modal-toolbar">
          <ion-title>Word Insight</ion-title>
          <ion-buttons slot="end">
            <ion-button fill="clear" (click)="closeMorphologyDetails()">Close</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="study-morph-modal-content ion-padding" *ngIf="selectedMorphologyItem as item">
        <section class="study-morph-modal-hero">
          <div>
            <h2 class="study-morph-modal-word arabic" dir="rtl" translate="no">{{ activeWord }}</h2>
            <p class="study-morph-modal-gloss">{{ primaryMeaning }}</p>
            <p class="study-body-text" *ngIf="activeLocation !== 'â€”'">{{ activeLocation }}</p>
          </div>
          <ion-badge class="study-morph-modal-pos" *ngIf="activePos">{{ activePos | uppercase }}</ion-badge>
        </section>

        <ng-container [ngSwitch]="activeMorphologyDetailTab">
          <section class="study-morph-modal-panel" *ngSwitchCase="'lexicon'">
            <p class="study-muted" *ngIf="isLoadingForSelection">
              Loading {{ resolvedLexiconId }} details...
            </p>
            <p class="study-empty" *ngIf="remoteError">{{ remoteError }}</p>

            <ion-list class="study-list" lines="none">
              <ion-item class="study-item study-item--sub" *ngFor="let field of lexiconInfoFields; trackBy: trackByField" lines="none">
                <ion-label>
                  <p class="study-row-key">{{ field.label }}</p>
                  <p class="study-body-text" [class.arabic]="field.arabic" [attr.dir]="field.arabic ? 'rtl' : null" translate="no">
                    {{ field.value }}
                  </p>
                </ion-label>
              </ion-item>
            </ion-list>

            <div class="study-morph-meaning-block" *ngIf="meaningList.length">
              <p class="study-row-key">Meanings</p>
              <ol class="study-morph-meaning-list">
                <li *ngFor="let meaning of meaningList">{{ meaning }}</li>
              </ol>
            </div>

            <div class="study-morph-meaning-block" *ngIf="synonymChips.length">
              <p class="study-row-key">Synonyms</p>
              <div class="study-chip-cloud">
                <ion-chip class="study-chip" *ngFor="let synonym of synonymChips; trackBy: trackByTerm">
                  <ion-label [class.arabic]="isArabicText(synonym)" [attr.dir]="isArabicText(synonym) ? 'rtl' : null">
                    {{ synonym }}
                  </ion-label>
                </ion-chip>
              </div>
            </div>
          </section>

          <section class="study-morph-modal-panel" *ngSwitchCase="'morphology'">
            <p class="study-muted" *ngIf="isLoadingForSelection">
              Fetching morphology for {{ resolvedLexiconId }}...
            </p>
            <p class="study-empty" *ngIf="remoteError">{{ remoteError }}</p>

            <div class="study-morph-profile-grid">
              <article class="study-morph-profile-card" *ngFor="let field of morphologyProfileFields; trackBy: trackByField">
                <p>{{ field.label }}</p>
                <h4 [class.arabic]="field.arabic" [attr.dir]="field.arabic ? 'rtl' : null" translate="no">
                  {{ field.value }}
                </h4>
              </article>
            </div>

            <div class="study-morph-meaning-block" *ngIf="morphologyFeatureBadges.length">
              <p class="study-row-key">Features</p>
              <div class="study-chip-cloud">
                <ion-chip class="study-chip" *ngFor="let feature of morphologyFeatureBadges; trackBy: trackByTerm">
                  <ion-label>{{ feature }}</ion-label>
                </ion-chip>
              </div>
            </div>

            <div
              class="study-morph-meaning-block"
              *ngIf="morphologySingularForm || morphologyPluralForm || morphologyPluralType || morphologyDerivedTriplet"
            >
              <p class="study-row-key">Forms</p>
              <p class="study-body-text study-morph-form-row" *ngIf="morphologySingularForm">
                <strong>Singular:</strong>
                <span class="arabic" dir="rtl" translate="no">{{ morphologySingularForm }}</span>
                <span *ngIf="morphologySingularPattern"> ({{ morphologySingularPattern }})</span>
              </p>
              <p class="study-body-text study-morph-form-row" *ngIf="morphologyPluralForm">
                <strong>Plural:</strong>
                <span class="arabic" dir="rtl" translate="no">{{ morphologyPluralForm }}</span>
                <span *ngIf="morphologyPluralPattern"> ({{ morphologyPluralPattern }})</span>
              </p>
              <p class="study-body-text study-morph-form-row" *ngIf="morphologyPluralType">
                <strong>Type:</strong>
                <span class="arabic" dir="rtl" translate="no">{{ morphologyPluralType }}</span>
              </p>
              <p class="study-body-text study-morph-form-row" *ngIf="morphologyDerivedTriplet">
                <strong>Derived From:</strong>
                <span class="arabic" dir="rtl" translate="no">{{ morphologyDerivedTriplet }}</span>
              </p>
            </div>

            <div class="study-morph-meaning-block" *ngIf="morphologyCardMeanings.length">
              <p class="study-row-key">Meanings</p>
              <ol class="study-morph-meaning-list">
                <li *ngFor="let meaning of morphologyCardMeanings">{{ meaning }}</li>
              </ol>
            </div>
          </section>

          <section class="study-morph-modal-panel" *ngSwitchCase="'evidence'">
            <p class="study-muted" *ngIf="isLoadingForSelection">
              Fetching evidence for {{ resolvedLexiconId }}...
            </p>
            <p class="study-empty" *ngIf="remoteError">{{ remoteError }}</p>

            <ion-list class="study-list" lines="none" *ngIf="evidenceDisplayRecords.length; else noMorphEvidence">
              <ion-item class="study-item study-item--sub" *ngFor="let evidence of evidenceDisplayRecords; trackBy: trackByEvidence" lines="none">
                <ion-label>
                  <p class="study-row-key">{{ evidenceGroupTitle(evidence) }}</p>
                  <p class="study-body-text">{{ evidenceExtractText(evidence) }}</p>
                  <p class="study-muted">{{ evidenceSource(evidence) }}</p>
                </ion-label>
              </ion-item>
            </ion-list>
            <ng-template #noMorphEvidence>
              <p class="study-empty">No evidence is linked to this word yet.</p>
            </ng-template>
          </section>
        </ng-container>
      </ion-content>

      <ion-footer class="study-morph-modal-footer">
        <ion-toolbar class="study-morph-modal-toolbar">
          <ion-segment class="study-morph-modal-tabs" [value]="activeMorphologyDetailTab" (ionChange)="onMorphologyDetailTabChange($event)">
            <ion-segment-button value="lexicon">
              <ion-label>Lexicon</ion-label>
            </ion-segment-button>
            <ion-segment-button value="morphology">
              <ion-label>Morphology</ion-label>
            </ion-segment-button>
            <ion-segment-button value="evidence">
              <ion-label>Evidence ({{ evidenceCount }})</ion-label>
            </ion-segment-button>
          </ion-segment>
        </ion-toolbar>
      </ion-footer>
    </ng-template>
  </ion-modal>
</section>
