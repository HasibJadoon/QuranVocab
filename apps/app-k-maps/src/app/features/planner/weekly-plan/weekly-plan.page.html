<ion-header>
  <ion-toolbar class="km-week-toolbar">
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>{{ weekPlan()?.title || ('Week Sprint â€” ' + weekLabel()) }}</ion-title>
    <ion-buttons slot="end">
      <ion-button class="km-btn" fill="outline" [routerLink]="['/planner/kanban']">Kanban</ion-button>
      <ion-button class="km-btn" fill="outline" [routerLink]="['/planner/review']">Review</ion-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar class="weekly-progress-toolbar">
    <div class="weekly-progress-wrap">
      <div class="weekly-progress-head">
        <span>{{ summary().tasks_done }} / {{ summary().tasks_total }} Tasks Done.</span>
        <span>{{ summary().minutes_spent }} / {{ weekPlan()?.metrics?.minutes_target || 0 }} min</span>
      </div>
      <ion-progress-bar [value]="progressPct() / 100"></ion-progress-bar>
    </div>
  </ion-toolbar>

  <ion-toolbar class="weekly-lane-toolbar">
    <ion-segment [value]="selectedLane()" (ionChange)="onLaneChanged($event)">
      <ion-segment-button value="lesson">
        <ion-label>Lesson</ion-label>
      </ion-segment-button>
      <ion-segment-button value="podcast">
        <ion-label>Podcast</ion-label>
      </ion-segment-button>
      <ion-segment-button value="notes">
        <ion-label>Notes</ion-label>
      </ion-segment-button>
      <ion-segment-button value="admin">
        <ion-label>Admin</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="weekly-plan-content km-shell">
  <ion-refresher slot="fixed" (ionRefresh)="onRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  @if (loading()) {
    <ion-list class="weekly-list">
      @for (row of [1,2,3,4,5,6]; track row) {
        <ion-item lines="none" class="weekly-card">
          <ion-label>
            <h3><ion-skeleton-text animated style="width: 70%"></ion-skeleton-text></h3>
            <p><ion-skeleton-text animated style="width: 45%"></ion-skeleton-text></p>
          </ion-label>
        </ion-item>
      }
    </ion-list>
  } @else {
    <ion-list class="weekly-list">
      @for (task of laneTasks(); track task.id) {
        <ion-item-sliding #sliding>
          <ion-item button="true" detail="false" class="weekly-card" (click)="openDetailModal(task)">
            <ion-label>
              <h2>{{ task.item_json.title }}</h2>
              <p class="task-meta">
                <span class="km-chip">{{ task.item_json.status | titlecase }} - {{ task.item_json.estimate_min }} min</span>
                <span class="km-chip task-priority">{{ task.item_json.priority }}</span>
              </p>
              @if (task.related_type && task.related_id) {
                <p class="task-related">{{ task.related_type }} {{ task.related_id }}</p>
              }
            </ion-label>
          </ion-item>

          <ion-item-options side="end">
            <ion-item-option color="success" (click)="completeFromSwipe(task, $event)">Complete</ion-item-option>
            <ion-item-option color="medium" (click)="openEditModal(task, sliding)">Edit</ion-item-option>
            <ion-item-option color="warning" (click)="moveLane(task, $event)">Move</ion-item-option>
          </ion-item-options>
        </ion-item-sliding>
      }
    </ion-list>

    @if (laneTasks().length === 0) {
      <div class="weekly-empty-state">
        <h3>No tasks in {{ selectedLane() | titlecase }}</h3>
        <p>Add one with the button below.</p>
      </div>
    }
  }

  <section class="weekly-composer km-glass">
    <ion-button fill="clear" class="composer-add" (click)="openCreateModal()" aria-label="Add task">+</ion-button>
    <ion-input
      class="composer-input"
      [formControl]="captureControl"
      placeholder="Take quick note..."
      (keyup.enter)="captureQuickNote()"
    ></ion-input>
    <ion-button class="km-btn" size="small" (click)="captureQuickNote()" [disabled]="saving()">Save</ion-button>
  </section>
</ion-content>
