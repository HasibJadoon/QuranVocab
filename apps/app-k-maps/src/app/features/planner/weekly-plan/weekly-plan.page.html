<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>{{ weekLabel() }}</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="openKanbanView()" aria-label="Kanban cards">
        <ion-icon [icon]="gridIcon" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button fill="clear" (click)="openCreateModal()" aria-label="Add task">
        <ion-icon [icon]="addIcon" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="onRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <ion-card>
    <ion-card-header>
      <ion-card-subtitle>Weekly Summary</ion-card-subtitle>
      <ion-card-title>{{ weekLabel() }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-chip outline>
        <ion-label>Lessons {{ lessonDone() }}/2</ion-label>
      </ion-chip>
      <ion-chip outline>
        <ion-label>Podcasts {{ podcastDone() }}/3</ion-label>
      </ion-chip>
      <ion-chip outline>
        <ion-label>Minutes {{ summary().minutes_spent }}/{{ minuteTarget() }}</ion-label>
      </ion-chip>
      <ion-item lines="none">
        <ion-label>Progress</ion-label>
        <ion-note slot="end">{{ progressPct() }}%</ion-note>
      </ion-item>
      <ion-progress-bar [value]="progressPct() / 100"></ion-progress-bar>
    </ion-card-content>
  </ion-card>

  @if (shouldPromptPlanning()) {
    <ion-item button detail="true" (click)="openPlanWeekModal()">
      <ion-icon slot="start" [icon]="sparklesIcon"></ion-icon>
      <ion-label>New week ready. Plan now.</ion-label>
    </ion-item>
  }

  <ion-segment [value]="activeStatus" (ionChange)="onStatusChanged($event.detail.value)">
    <ion-segment-button value="planned">To Do</ion-segment-button>
    <ion-segment-button value="doing">Doing</ion-segment-button>
    <ion-segment-button value="done">Done</ion-segment-button>
  </ion-segment>

  @if (loading()) {
    <ion-list>
      @for (row of [1,2,3,4,5,6]; track row) {
        <ion-item lines="none">
          <ion-label>
            <h3><ion-skeleton-text animated style="width: 70%"></ion-skeleton-text></h3>
            <p><ion-skeleton-text animated style="width: 45%"></ion-skeleton-text></p>
          </ion-label>
        </ion-item>
      }
    </ion-list>
  } @else {
    <ion-list>
      @for (lane of lanes; track lane) {
        <ion-item-divider sticky="true">
          <ion-label>{{ lane | titlecase }}</ion-label>
          <ion-badge slot="end" color="medium">{{ laneCount(lane) }}</ion-badge>
        </ion-item-divider>

        @for (task of tasksForLane(lane); track task.id) {
          <ion-item button detail="true" (click)="openDetailModal(task)">
            <ion-label>
              <h2>{{ task.item_json.title }}</h2>
              <p>
                <ion-chip outline color="primary">
                  <ion-label>{{ task.item_json.priority }}</ion-label>
                </ion-chip>
                <ion-chip outline color="medium">
                  <ion-label>{{ task.item_json.status | titlecase }}</ion-label>
                </ion-chip>
              </p>
              <p>
                <ion-note>{{ assignmentSummary(task) }}</ion-note>
              </p>
            </ion-label>
            <ion-buttons slot="end">
              <ion-button
                fill="clear"
                size="small"
                color="primary"
                (click)="moveToDoing(task); $event.stopPropagation()"
              >
                Doing
              </ion-button>
              <ion-button
                fill="clear"
                size="small"
                color="success"
                (click)="completeFromSwipe(task); $event.stopPropagation()"
              >
                Done
              </ion-button>
              <ion-button
                fill="clear"
                size="small"
                color="warning"
                (click)="markBlocked(task); $event.stopPropagation()"
              >
                Blocked
              </ion-button>
              <ion-button
                fill="clear"
                size="small"
                color="medium"
                (click)="openEditModal(task); $event.stopPropagation()"
              >
                Edit
              </ion-button>
            </ion-buttons>
          </ion-item>
        }

        @if (tasksForLane(lane).length === 0) {
          <ion-item lines="none">
            <ion-label color="medium">
              No {{ lane }} tasks in {{ activeStatus === 'planned' ? 'To Do' : (activeStatus | titlecase) }}.
            </ion-label>
          </ion-item>
        }
      }
    </ion-list>

    @if (tasks().length === 0) {
      <ion-card>
        <ion-card-content class="ion-text-center">
          <h3>No tasks this week</h3>
          <p>Add one with the button above.</p>
        </ion-card-content>
      </ion-card>
    }
  }

  <ion-card>
    <ion-item>
      <ion-input
        [formControl]="captureControl"
        placeholder="Quick capture..."
        (keyup.enter)="captureQuickNote()"
      ></ion-input>
      <ion-button slot="end" (click)="captureQuickNote()" [disabled]="saving()">Add</ion-button>
    </ion-item>
  </ion-card>
</ion-content>
