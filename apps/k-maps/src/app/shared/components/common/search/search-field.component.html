<div class="d-flex flex-row align-items-start flex-wrap">
  <div class="flex-grow-1 d-flex flex-column">
    <div class="input-group" [ngClass]="options?.size === 'small' ? 'input-group-sm' : options?.size === 'large' ? 'input-group-lg' : ''" [class.border-force]="options?.forceBorder" [class.invisible]="options?.filters?.hideSearch">
      <div class="input-group-prepend">
        <button *ngIf="options?.save?.history || options?.save?.favorite; else search" #saveButton class="btn btn-outline-secondary dropdown-toggle" type="button" tabindex="-1" (click)="doShowHistory(saveButton)">
          <i class="far fa-fw" [ngClass]="loading ? 'fa-spinner fa-pulse' : 'fa-history'" aria-hidden="true"></i>
        </button>
        <ng-template #search>
          <span class="input-group-text"><i class="far" [ngClass]="loading ? 'fa-spinner fa-pulse' : options.icon ?? 'fa-search'" aria-hidden="true"></i></span>
        </ng-template>
        <button
          *ngIf="options?.enableListSearch"
          #listButton
          class="btn btn-outline-secondary dropdown-toggle"
          type="button"
          tabindex="-1"
          (click)="doShowTextArea(listButton)"
          [disabled]="filters | filtersonly : options?.filters?.filtersConfig"
        >
          <i class="fas fa-money-check-edit" aria-hidden="true"></i>
        </button>
        <ng-content select="[input-group-prepend]"></ng-content>
      </div>

      <input
        class="form-control"
        placeholder="{{ (options?.placeholderKey ? options?.placeholderKey : 'COMMON.SEARCH') | translate }}"
        type="text"
        [(ngModel)]="searchBox"
        (ngModelChange)="fireSearch()"
        aria-label="Search"
        [disabled]="filters | filtersonly : options?.filters?.filtersConfig"
      />
      <div class="input-group-append">
        <ng-container *ngIf="!options?.condensed">
          <button
            *ngIf="
              (isMobile && options?.filters?.filtersConfig && settings?.filtersDisplayMode !== 'inline') ||
              (options?.filters?.filtersConfig && settings?.filtersDisplayMode === 'dropdown') ||
              (options?.filters?.filtersConfig && settings?.filtersDisplayMode === 'modal')
            "
            #filtersButton
            class="btn btn-outline-secondary dropdown-toggle"
            type="button"
            tabindex="-1"
            (click)="doShowFilters(filtersButton)"
          >
            <i class="fa-fw fa-filter" [ngClass]="(filters | filtersempty) ? 'far' : 'fas'" aria-hidden="true"></i>
          </button>
          <button *ngIf="options?.save?.favorite" class="btn btn-outline-secondary" type="button" tabindex="-1" (click)="doSaveFavorite()" [disabled]="!searchBox && searchTags?.length === 0 && (filters | filtersempty) && !sort">
            <i class="fa-star" [ngClass]="currentFavorite ? 'fas' : 'far'" aria-hidden="true"></i>
          </button>
          <button class="btn btn-outline-secondary" type="button" (click)="doClear()" tabindex="-1">
            <i class="far fa-times" aria-hidden="true"></i>
          </button>
        </ng-container>
        <ng-container *ngIf="options?.condensed">
          <button #menusButton class="btn btn-outline-secondary" type="button" (click)="doShowMenu(menusButton)">
            <i class="far fa-ellipsis-v" aria-hidden="true"></i>
          </button>
        </ng-container>
        <ng-content select="[input-group-append]"></ng-content>
      </div>
    </div>

    <div class="d-flex flex-row align-items-start">
      <div *ngIf="options?.showInfoText == null || options?.showInfoText; else empty">
        <small class="text-muted">{{ (options?.infoTextKey ? options?.infoTextKey : 'COMMON.3_MIN') | translate }}</small>
      </div>
      <tag-input
        #tagInput
        *ngIf="options?.tagList"
        class="form-control border-0 py-0 px-2"
        theme="search-field-theme"
        placeholder="{{ (options?.tagsPlaceholderKey ? options?.tagsPlaceholderKey : 'COMMON.SEARCH') | translate }}"
        secondaryPlaceholder="{{ (options?.tagsPlaceholderKey ? options?.tagsPlaceholderKey : 'COMMON.SEARCH') | translate }}"
        [(ngModel)]="searchTags"
        (onAdd)="fireSearch()"
        (onRemove)="fireSearch()"
        aria-label="Search"
        [onlyFromAutocomplete]="false"
        [blinkIfDupe]="true"
        [allowDupes]="false"
        [dragZone]="'tag_list'"
        [onAdding]="resolveTag.bind(this)"
      >
        <ng-template let-item="item" let-index="index">
          <div class="btn-group btn-group-sm mr-1">
            <button
              #tagButton
              class="btn rounded-left my-btn-color"
              [class.dropdown-toggle]="item | secondaryEditable : options.tagList"
              [class.rounded-right]="item.readonly"
              type="button"
              (click)="editSecondaryTags($event.currentTarget, item)"
            >
              <span>{{ item.display }}</span>
              <span *ngIf="(item | secondaryCount) > 0" class="font-weight-light ml-1">(+{{ item | secondaryCount }})</span>
            </button>
            <button *ngIf="!item.readonly" class="btn rounded-right my-btn-color" type="button" (click)="tagInput.removeItem(item, index)">
              <i class="far fa-times" aria-hidden="true"></i>
            </button>
          </div>
        </ng-template>
        <tag-input-dropdown [showDropdownIfEmpty]="true" [autocompleteItems]="availableTags" [minimumTextLength]="0" [keepOpen]="false">
          <ng-template let-item="item" let-index="index">
            <span>{{ item.display }}</span>
            <span *ngIf="(item | secondaryCount) > 0" class="font-weight-light ml-1">(+{{ item | secondaryCount }})</span>
          </ng-template>
        </tag-input-dropdown>
      </tag-input>
    </div>
    <ng-template #empty>
      <div class="mb-1"></div>
    </ng-template>
  </div>
  <ng-content></ng-content>
</div>
<div
  *ngIf="(filters && (options?.filters?.showFiltersBottom == null || options?.filters?.showFiltersBottom)) || settings?.filtersDisplayMode === 'inline' || (!isMobile && !options?.condensed && settings?.filtersDisplayMode === 'auto')"
  class="d-flex flex-row justify-content-between align-items-start"
>
  <div class="btn-toolbar">
    <ng-container *ngIf="options.filters?.filtersConfig | filtersDisable | async as enableFiltersConfig">
      <ng-container *ngFor="let id of enableFiltersConfig | keys">
        <ng-container *ngIf="enableFiltersConfig[id] as filterConfig">
          <div
            *ngIf="
              (filters && filters[id] != null) ||
              ((settings?.filtersDisplayMode === 'inline' || (!isMobile && !options?.condensed && settings?.filtersDisplayMode === 'auto')) &&
                (showAllfilters || (settings?.filters[id]?.visibility !== 'hidden' && (filterConfig.availability !== 'onlyFilters' || !searchBox))))
            "
            class="btn-group btn-group-sm mr-1 mb-1"
          >
            <button
              #filterButton
              class="btn rounded-left dropdown-toggle"
              [class.rounded-right]="!filters || filters[id] == null"
              type="button"
              mcitTooltip="{{ filterConfig.descriptionKey | translate }}"
              [ngClass]="filters && filters[id] != null && (settings?.filtersDisplayMode === 'inline' || (!isMobile && !options?.condensed && settings?.filtersDisplayMode === 'auto')) ? 'btn-dark' : 'my-btn-color'"
              [disabled]="filterConfig.availability === 'onlyFilters' && !!searchBox"
              (click)="doShowFilter(filterButton, id)"
            >
              <i *ngIf="filterConfig.availability === 'onlyFilters' && !!searchBox" class="far fa-exclamation-circle mr-1" aria-hidden="true"></i>
              <span class="font-weight-light">{{ filterConfig.nameKey | translate }}</span>
              <ng-container *ngIf="filters && filters[id] != null">
                <span class="font-weight-light">&nbsp;:&nbsp;</span>
                <span [innerHTML]="filters[id] | filtervalue : enableFiltersConfig[id] | filterscustomname : 'VEHICLE_PARK.EXISTING'"></span>
              </ng-container>
            </button>
            <button
              *ngIf="filters && filters[id] != null"
              class="btn rounded-right"
              [ngClass]="filters && filters[id] != null && (settings?.filtersDisplayMode === 'inline' || (!isMobile && !options?.condensed && settings?.filtersDisplayMode === 'auto')) ? 'btn-dark' : 'my-btn-color'"
              type="button"
              (click)="doClearFilter(id)"
            >
              <i class="far fa-times" aria-hidden="true"></i>
            </button>
          </div>
        </ng-container>
      </ng-container>
      <div
        *ngIf="(settings?.filtersDisplayMode === 'inline' || (!isMobile && !options?.condensed && settings?.filtersDisplayMode === 'auto')) && (filters | filtershidden : settings?.filters : enableFiltersConfig : searchBox)"
        class="btn-group btn-group-sm mr-1 mb-1"
      >
        <button class="btn my-btn-color" type="button" (click)="doToggleShowAllFilters()">
          <i class="far" [ngClass]="showAllfilters ? 'fa-chevron-square-left' : 'fa-chevron-square-right'" aria-hidden="true"></i>
        </button>
      </div>
    </ng-container>
  </div>
</div>
