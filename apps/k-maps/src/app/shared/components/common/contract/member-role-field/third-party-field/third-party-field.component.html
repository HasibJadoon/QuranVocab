<form [formGroup]="thirdPartyFieldForm" novalidate>
  <div class="input-group" [mcitTooltip]="showTooltip() ? getTooltipString() : ''">
    <div class="input-group-prepend">
      <span class="input-group-text">
        <i class="far fa-fw" [ngClass]="thirdPartyLoading ? 'fa-spinner fa-pulse' : 'fa-building'" aria-hidden="true"></i>
      </span>
    </div>
    <input
      #mytypeahead="bs-typeahead"
      autocorrect="off"
      autocapitalize="off"
      spellcheck="false"
      autocomplete="off"
      placeholder="{{ placeholder }}"
      class="form-control"
      formControlName="thirdParty"
      [typeahead]="thirdPartyDataSource"
      [typeaheadGroupField]="'typeTitle'"
      [optionsListTemplate]="myListTemplate"
      [typeaheadOptionField]="'name'"
      (typeaheadLoading)="doChangeThirdPartyLoading($event)"
      (typeaheadOnSelect)="doAddressSelected($event)"
      [typeaheadMinLength]="options?.favorites$ ? 0 : 1"
      [control-active]="(thirdPartyFieldForm.controls['thirdParty'].dirty && thirdPartyFieldForm.controls['thirdParty'].touched) || submitAttempt"
      [required]="required"
    />
    <div class="input-group-append">
      <button
        class="btn btn-outline-secondary"
        [class.last-child-form-control]="!options?.editable"
        type="button"
        (click)="doClearThirdParty()"
        tabindex="-1"
        [hidden]="thirdPartyFieldForm.controls['thirdParty'].value?.length === 0 || thirdPartyFieldForm.controls['thirdParty'].value === null"
        [disabled]="thirdPartyFieldForm.controls['thirdParty'].disabled"
      >
        <i class="far fa-times" aria-hidden="true"></i>
      </button>
      <button *ngIf="options?.editable" class="btn btn-outline-secondary last-child-form-control" type="button" (click)="doEditThirdParty()" tabindex="-1" [disabled]="thirdPartyFieldForm.controls['thirdParty'].disabled">
        <i class="far fa-edit" aria-hidden="true"></i>
      </button>
    </div>
    <div class="invalid-feedback">
      {{ getThirdPartyErrorMessage() | translate }}
    </div>
  </div>
</form>
<ng-template #myItemTemplate let-match="match" let-query="query" let-item="item">
  <div class="d-flex flex-row">
    <div class="d-flex flex-column justify-content-center align-items-center mr-1">
      <i *ngIf="item.type === 'FAVORITES'" class="far fa-fw fa-lg fa-star" aria-hidden="true"></i>
      <i *ngIf="item.type === 'ADDRESSES'" class="far fa-fw fa-lg fa-address-card" aria-hidden="true"></i>
      <i *ngIf="item.type === 'THIRD_PARTIES'" class="far fa-fw fa-lg fa-warehouse" aria-hidden="true"></i>
      <i *ngIf="item.type === 'PLACES'" class="fa-fw fa-lg mr-1" [ngClass]="item.types | placeicon" aria-hidden="true"></i>
    </div>
    <div class="flex-grow-1 d-flex flex-column">
      <div style="flex: 1.5" [innerHtml]="mytypeahead?._container?.highlight(match, query)"></div>
      <div *ngIf="item.type === 'FAVORITES'" class="font-weight-light" style="flex: 0.5; font-size: 80%">
        {{ [item.thirdParty?.city, item.thirdParty?.zip, item.thirdParty?.country?.name] | join : ', ' }}
      </div>
      <div *ngIf="item.type === 'ADDRESSES'" class="font-weight-light" style="flex: 0.5; font-size: 80%">
        {{ [item.city, item.zip, item.country?.name] | join : ', ' }}
      </div>
      <div *ngIf="item.type === 'PLACES'" class="font-weight-light" style="flex: 0.5; font-size: 80%">
        {{ item.structured_formatting?.secondary_text }}
      </div>
      <div *ngIf="item.type === 'THIRD_PARTIES'">
        <div class="font-weight-light" style="flex: 0.5; font-size: 60%">
          {{ [item?.gefco_code, item.city, item.zip, item.country?.name] | join : ', ' }}
        </div>
        <div class="font-weight-light" style="flex: 0.5; font-size: 60%">
          {{ [item.address1, item.address2, item.address3] | join : ', ' }}
        </div>
      </div>
    </div>
  </div>
</ng-template>
<ng-template #myListTemplate let-matches=" matches" let-query="query">
  <div class="d-lg-flex">
    <ng-template ngFor let-matchheader let-i="index" [ngForOf]="matches | getHeaderMemberRole">
      <div>
        <h6 class="dropdown-header">{{ matchheader }}</h6>
        <ng-template ngFor let-match [ngForOf]="matches | toMapMemberRole : matchheader">
          <button
            class="dropdown-item px-2 py-1 font-weight-normal"
            style="font-size: 95%"
            (click)="mytypeahead?._container?.selectMatch(match, $event)"
            (mouseenter)="mytypeahead?._container?.selectActive(match)"
            [class.active]="mytypeahead?._container?.isActive(match)"
          >
            <ng-template [ngTemplateOutlet]="myItemTemplate" [ngTemplateOutletContext]="{ item: match.item, index: i, match: match, query: query }"> </ng-template>
          </button>
        </ng-template>
      </div>
    </ng-template>
  </div>
</ng-template>
