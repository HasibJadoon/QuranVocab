<div class="container-fluid">
  <div class="row">
    <div class="col-12 mb-2">
      <mcit-search-field *ngIf="!options.table.hideSearchField" [loading]="waiting" [options]="options.table.searchOptions" [ngModel]="searchBox" (ngModelChange)="querySubject.next($event)">
        <div class="btn-group flex-grow-0 flex-lg-grow-0 d-flex flex-row justify-content-around mr-1" *ngIf="(options.crud?.export?.exportButton | basicCrudHiddenAction : true | async) === false">
          <button
            #exportButton
            type="button"
            class="btn btn-primary btn-block"
            (click)="exportElements(exportButton)"
            [disabled]="waiting || (options.crud?.export?.exportDisabled | basicCrudHiddenAction : true | async) === false"
            [mcitTooltip]="options?.crud?.export?.exportDisabledTooltip && (options.crud?.export?.exportDisabled | basicCrudHiddenAction : true | async) === false ? (options?.crud?.export?.exportDisabledTooltip | translate) : ''"
          >
            <i class="far" [ngClass]="waiting ? 'fa-spinner fa-pulse' : 'fas fa-file-export'"></i>
            {{ options.crud?.export?.exportButtonText ?? 'COMMON.EXPORT' | translate }}
          </button>
        </div>
        <div class="btn-group flex-grow-0 flex-lg-grow-0 d-flex flex-row justify-content-around mr-1" *ngIf="(options.crud?.import?.importButton | basicCrudHiddenAction : true | async) === false">
          <button #importButton type="button" class="btn btn-primary" (click)="importElements(importButton)">
            <i class="fas fa-file-import mr-2"></i>
            {{ options.crud?.import?.importButtonText ?? 'COMMON.IMPORT' | translate }}
          </button>
          <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" [mcitDropdown]="importMenuTemplate" *ngIf="options.crud?.import?.templateLink || options.crud?.import?.templateCall">
            <span class="sr-only">Toggle Dropdown</span>
          </button>
          <ng-template #importMenuTemplate let-dropdownRef="dropdownRef">
            <div class="mcit-dropdown-menu show" role="menu" aria-labelledby="button-basic">
              <a *ngIf="options.crud?.import?.templateLink" class="dropdown-item" [href]="options.crud?.import?.templateLink" (click)="dropdownRef.close()"> {{ 'COMMON.DOWNLOAD_IMPORT_TEMPLATE' | translate }}&#x2026; </a>
              <div *ngIf="!options.crud?.import?.templateLink && options.crud?.import?.templateCall" class="dropdown-item cursor-pointer" (click)="options.crud?.import?.templateCall(); dropdownRef.close()">
                {{ 'COMMON.DOWNLOAD_IMPORT_TEMPLATE' | translate }}&#x2026;
              </div>
            </div>
          </ng-template>
        </div>
        <div class="flex-grow-1 flex-lg-grow-0 d-flex flex-row justify-content-around" *ngIf="(options.crud?.upsert?.addButton | basicCrudHiddenAction : true | async) === false">
          <button class="btn btn-primary" (click)="addElement()">
            {{ 'COMMON.ADD' | translate }}
          </button>
        </div>
        <ng-content select="[afterSearch]"></ng-content>
      </mcit-search-field>
    </div>
  </div>
  <div class="row">
    <div *ngIf="options.facet" class="col-12 col-xl-3 mb-2">
      <ng-container *ngIf="categories$ | async as categories; else loading">
        <mcit-facet-field [options]="options.facet.facetOptions" [loading]="waitingCategories" [data]="categories" [ngModel]="facetBox" (ngModelChange)="facetSubject.next($event)"></mcit-facet-field>
      </ng-container>
    </div>

    <div class="col-12 mb-2" [class.col-xl-12]="!options.facet?.facetOptions" [class.col-xl-9]="!!options.facet?.facetOptions">
      <div *ngIf="container$ | async as container; else loading">
        <div class="row">
          <div class="col-12">
            <ng-container *ngIf="options.table.tableOptions; else itemsTemplate">
              <mcit-table-group
                #tableCrud
                [options]="options.table.tableOptions"
                [customTableOptionsComponent]="tableOptionsComponent"
                [pagination]="{ page: page, total: total, per_page: perPage }"
                [items]="[]"
                [groups]="groups$ | async"
                [container]="container"
                [tableMode]="'normal'"
                (perPageEvent)="doPerPage($event, container)"
              >
                <!-- Toolbar -->
                <div class="d-flex flex-row align-items-center" mcitTableToolbar>
                  <ng-container *ngIf="groupTableToolbarCustom">
                    <ng-container [ngTemplateOutlet]="groupTableToolbarCustom.templateRef" [ngTemplateOutletContext]="{ total: total }"> </ng-container>
                  </ng-container>
                  <ng-container *ngIf="openMode$ | async as openMode">
                    <div *ngIf="(groups$ | async)?.length > 0" class="align-self-center list-group list-group-horizontal mr-1">
                      <a
                        href="javascript:void(0)"
                        class="list-group-item list-group-item-action px-2 py-1"
                        [class.active]="openMode === 'first'"
                        [mcitTooltip]="'GROUPAGE_COMPONENT.OPEN_MODES.FIRST' | translate"
                        (click)="doToggleOpenMode('first')"
                      >
                        <i class="fas fa-1 fa-xs fa-fw" aria-hidden="true"></i>
                      </a>
                      <a
                        href="javascript:void(0)"
                        class="list-group-item list-group-item-action px-2 py-1"
                        [class.active]="openMode === 'all'"
                        [mcitTooltip]="'GROUPAGE_COMPONENT.OPEN_MODES.ALL' | translate"
                        (click)="doToggleOpenMode('all')"
                      >
                        <i class="fas fa-chevron-double-down fa-xs fa-fw" aria-hidden="true"></i>
                      </a>
                      <a
                        href="javascript:void(0)"
                        class="list-group-item list-group-item-action px-2 py-1"
                        [class.active]="openMode === 'close'"
                        [mcitTooltip]="'GROUPAGE_COMPONENT.OPEN_MODES.CLOSE' | translate"
                        (click)="doToggleOpenMode('close')"
                      >
                        <i class="fas fa-chevron-double-right fa-xs fa-fw" aria-hidden="true"></i>
                      </a>
                    </div>
                  </ng-container>
                  <mcit-group
                    class="ml-auto d-none d-lg-flex flex-row justify-content-end align-items-center flex-wrap mr-1"
                    [options]="options.table.groupOptions"
                    [groups$]="groups$"
                    (doAddGroupKey)="doAddGroupKey($event)"
                    (doDeleteGroupKey)="doDeleteGroupKey($event)"
                    (doToggleGroupDirection)="doToggleGroupDirection($event)"
                  >
                  </mcit-group>
                  <div class="d-flex flex-row ml-3">
                    <mcit-table-options #tableOptionsComponent [options]="options.table.tableOptions" [pagination]="{}"></mcit-table-options>
                  </div>
                </div>
                <ng-container *ngIf="rowHeaderCustom">
                  <ng-template mcitRowHeaderCustom let-item="item" let-index="index">
                    <ng-container [ngTemplateOutlet]="rowHeaderCustom.templateRef" [ngTemplateOutletContext]="{ item: item, index: index }"> </ng-container>
                  </ng-template>
                </ng-container>
                <ng-container *ngFor="let columnCustom of columnCustoms">
                  <ng-template [mcitColumnCustom]="columnCustom.elementKey" let-allArgs>
                    <ng-container [ngTemplateOutlet]="columnCustom.templateRef" [ngTemplateOutletContext]="allArgs"> </ng-container>
                  </ng-template>
                </ng-container>
                <ng-container *ngIf="rowExtensionCustom">
                  <ng-template mcitRowExtensionCustom let-allArgs>
                    <ng-container [ngTemplateOutlet]="rowExtensionCustom.templateRef" [ngTemplateOutletContext]="allArgs"> </ng-container>
                  </ng-template>
                </ng-container>
                <ng-container *ngIf="actionGroupRowCustom">
                  <ng-template mcitActionGroupRowCustom let-group="group" let-index="index">
                    <ng-container [ngTemplateOutlet]="actionGroupRowCustom.templateRef" [ngTemplateOutletContext]="{ group: group, index: index }"> </ng-container>
                  </ng-template>
                </ng-container>
              </mcit-table-group>
            </ng-container>
            <ng-template #itemsTemplate>
              <div class="d-flex flex-row align-items-baseline ng-star-inserted">
                <div class="d-flex flex-row justify-content-end align-items-baseline" [mcitTranslatedContent]="total > 1 ? 'BASIC_CRUD.NB_ITEMS_FOUND' : 'BASIC_CRUD.ONE_ITEM_FOUND'">
                  <div *mcitTranslatedElement="'num'" style="font-size: 1.5rem; font-weight: 700">
                    {{ total }}
                  </div>
                </div>
              </div>
            </ng-template>
          </div>
        </div>
        <div *ngIf="!(groups$ | async)?.length && options?.table?.tableOptions?.config?.showPagination" class="row mb-2">
          <div class="col-12">
            <mcit-pagination [options]="{ page: page, total: total, totalPages: totalPages, per_page: perPage }" (pageEvent)="doPage($event)" (perPageEvent)="doPerPage($event, container)"></mcit-pagination>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #loading>
  <div class="row">
    <div class="col-12 text-center">
      <i class="fas fa-spinner fa-pulse fa-3x" aria-hidden="true"></i>
    </div>
  </div>
</ng-template>
