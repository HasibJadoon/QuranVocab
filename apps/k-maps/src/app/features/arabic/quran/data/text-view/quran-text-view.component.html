<div class="quran-text-view">
  <app-headerbar
    [showTitle]="true"
    [title]="headerTitle"
    [showSearch]="false"
    [leadingLabel]="'Back to Surah list'"
    (leading)="goBack()"
  />

  <section class="lesson-study">
    <header class="study-header single-title">
      <div class="study-title">
        <h2>{{ headerTitle }}</h2>
        <h3 *ngIf="surah">{{ surah.meta['english_name_translation'] || '—' }}</h3>
      </div>
      <p class="study-meta" *ngIf="surah">{{ surah.ayah_count || '—' }} Ayahs</p>
    </header>

    <hr class="study-divider" />

    <div *ngIf="error" class="alert alert-danger py-2">{{ error }}</div>

    <ng-container *ngIf="surah; else loadingTpl">
      <div class="study-grid">
        <article class="study-card">
          <div class="study-card-heading">
            <h4>Text</h4>
            <div class="view-toggle">
              <button
                type="button"
                class="view-toggle-btn"
                [class.active]="viewMode === 'verse'"
                (click)="setViewMode('verse')"
              >
                <span class="toggle-icon">≡</span>
                Verse by Verse
              </button>
              <button
                type="button"
                class="view-toggle-btn"
                [class.active]="viewMode === 'reading'"
                (click)="setViewMode('reading')"
              >
                <span class="toggle-icon">▤</span>
                Reading
              </button>
            </div>
            <h4 class="study-card-mode">Surah {{ surah.surah }}</h4>
          </div>
          <hr class="study-card-divider" />

          <div class="bismillah-block" *ngIf="shouldShowBismillah">
            <div class="bismillah">{{ bismillah }}</div>
            <div class="bismillah-translation">{{ bismillahTranslation }}</div>
          </div>

          <div *ngIf="loadingAyahs" class="text-body-secondary">Loading ayahs…</div>

          <div
            *ngIf="!loadingAyahs && ayahs.length > 0; else noArabic"
            class="arabic-passage"
            [class.arabic-passage--reading]="viewMode === 'reading'"
          >
            <ng-container *ngIf="viewMode === 'reading'; else verseByVerse">
              <div *ngIf="loadingLemmaTokens" class="text-body-secondary">Loading lemma tokens…</div>
              <div *ngIf="lemmaTokensError" class="alert alert-danger py-2">{{ lemmaTokensError }}</div>
              <div *ngIf="!loadingLemmaTokens && readingText" class="reading-text text-arabic">
                {{ readingText }}
              </div>
            </ng-container>

            <ng-template #verseByVerse>
              <div *ngFor="let ayah of ayahs; trackBy: trackByAyah" class="arabic-verse-row">
                <div class="verse-meta">
                  <span class="verse-number">{{ ayah.ayah }}</span>
                </div>
                <div class="verse-content">
                  <div class="verse-text text-arabic">
                    <ng-container *ngIf="(ayah.words?.length ?? 0) > 0; else versePlainText">
                      <ng-container *ngFor="let word of ayah.words; let isLast = last; trackBy: trackByAyahWord">
                        <span
                          class="quran-word quran-word--interactive"
                          [attr.data-word-location]="word.word_location || word.location || null"
                          [attr.title]="word.word_location || word.location || null"
                        >
                          {{ getWordText(word) }}
                        </span>
                        <span *ngIf="!isLast"> </span>
                      </ng-container>
                    </ng-container>

                    <ng-template #versePlainText>{{ ayah.text_uthmani || ayah.text }}</ng-template>
                  </div>
                  <div class="verse-marker">{{ getAyahMark(ayah) }}</div>
                </div>
              </div>
            </ng-template>
          </div>

          <ng-template #noArabic>
            <p class="text-muted">Arabic text is not available for this surah yet.</p>
          </ng-template>
        </article>
      </div>
    </ng-container>
  </section>

  <ng-template #loadingTpl>
    <div *ngIf="loadingSurah" class="loading text-muted">Loading study data…</div>
  </ng-template>
</div>
