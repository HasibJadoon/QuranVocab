<div class="sentence-layout">
  <app-tabs
    class="sentence-tabs"
    [tabs]="sentenceTabs"
    [activeId]="state.sentenceSubTab"
    variant="tabs"
    ariaLabel="Sentence structure tabs"
    (tabChange)="onSentenceTabChange($event)"
  ></app-tabs>

  <div class="sentence-pane">
    <ng-container *ngIf="state.sentenceSubTab === 'verses'">
      <div class="sentence-card">
        <div class="sentence-card-head">
          <h4>Verse Preview</h4>
          <div class="action-row">
            <button type="button" class="btn btn-ghost btn-sm" (click)="extractSentenceCandidates()">Extract sentences</button>
            <button type="button" class="btn btn-ghost btn-sm" (click)="addSelectionFromPreview()">Add selection</button>
          </div>
        </div>
        <p class="note-muted">Double-click highlighted text to add it as a sentence. Right-click to open the menu.</p>
        <div class="unit-preview" *ngIf="state.sentenceLoadedAyahs.length; else noVersePreview">
          <div
            class="passage-preview"
            (contextmenu)="openContextMenu($event)"
            (dblclick)="addSelectionFromPreview()"
          >
            <p class="passage-text">
              <ng-container *ngFor="let ayah of selectedAyahs">
                <span class="passage-ayah" *ngIf="state.sentenceLoadedAyahs.includes(ayah.ayah)">
                  <span class="passage-ayah-text" (contextmenu)="openContextMenu($event, ayah)">{{ sentenceAyahText(ayah) }}</span>
                  <span class="passage-ayah-marker" (contextmenu)="openContextMenu($event, ayah)">﴿{{ ayah.ayah }}﴾</span>
                </span>
              </ng-container>
            </p>
          </div>
        </div>
        <ng-template #noVersePreview>
          <p class="text-muted">Load verses to preview.</p>
        </ng-template>
      </div>
    </ng-container>

    <ng-container *ngIf="state.sentenceSubTab === 'items'">
      <div class="sentence-card">
        <h4>Sentence Candidates</h4>
        <p class="note-muted">Add candidates to the task to resolve universal sentence IDs.</p>
        <div class="sentence-list" *ngIf="state.sentenceCandidates.length; else noCandidates">
          <div class="sentence-item" *ngFor="let candidate of state.sentenceCandidates">
            <div>
              <span class="sentence-tag">{{ candidate.source }}</span>
              <p class="sentence-text">{{ candidate.text }}</p>
            </div>
            <button
              type="button"
              class="btn btn-primary btn-sm"
              [disabled]="state.sentenceResolvingId === candidate.id"
              (click)="addSentenceCandidateToTask(candidate)"
            >
              {{ state.sentenceResolvingId === candidate.id ? 'Resolving...' : 'Add to Task' }}
            </button>
          </div>
        </div>
        <ng-template #noCandidates>
          <p class="text-muted">No sentence candidates yet.</p>
        </ng-template>
      </div>

      <div class="sentence-card">
        <div class="action-row align-items-center">
          <h4 class="mb-0">Task Sentences</h4>
          <div class="ms-auto">
            <button type="button" class="btn btn-ghost btn-sm" (click)="openCreateModal()">
              New Sentence JSON
            </button>
            <button type="button" class="btn btn-ghost btn-sm" (click)="openPasteSentenceModal()">
              Paste Sentence JSON
            </button>
          </div>
        </div>
        <div class="sentence-list" *ngIf="sentenceItems.length; else noItems">
          <div class="sentence-item" *ngFor="let item of sentenceItems; let i = index; trackBy: trackBySentenceItem">
            <div *ngIf="editingIndex !== i; else editSentence">
              <span class="sentence-tag">#{{ i + 1 }}</span>
              <p class="sentence-text">{{ item['canonical_sentence'] }}</p>
            </div>
            <ng-template #editSentence>
              <label>
                <span>Edit sentence</span>
                <textarea rows="2" [(ngModel)]="editingValue"></textarea>
              </label>
            </ng-template>
            <div class="action-row">
              <button
                type="button"
                class="btn btn-ghost btn-sm"
                *ngIf="editingIndex !== i"
                (click)="startEditSentence(item, i)"
              >
                Edit
              </button>
              <button type="button" class="btn btn-ghost btn-sm" (click)="openEditModal(item, i)">JSON</button>
              <button
                type="button"
                class="btn btn-primary btn-sm"
                *ngIf="editingIndex === i"
                (click)="saveEditSentence(i)"
              >
                Save
              </button>
              <button
                type="button"
                class="btn btn-ghost btn-sm"
                *ngIf="editingIndex === i"
                (click)="cancelEditSentence()"
              >
                Cancel
              </button>
              <button type="button" class="btn btn-ghost btn-sm" (click)="removeSentenceItem(i)">Remove</button>
            </div>
          </div>
        </div>
        <ng-template #noItems>
          <p class="text-muted">No sentences in task yet.</p>
        </ng-template>
      </div>
    </ng-container>

    <ng-container *ngIf="state.sentenceSubTab === 'json'">
      <div class="sentence-json">
        <div class="task-json-actions">
          <button type="button" class="btn btn-ghost btn-sm" (click)="validateTaskJson()">Validate JSON</button>
          <button type="button" class="btn btn-ghost btn-sm" (click)="formatTaskJson()">Format JSON</button>
        </div>
        <label>
          <span>Task JSON</span>
          <app-json-code-editor
            [value]="sentenceJson"
            (valueChange)="sentenceJson = $event"
            height="420px"
          ></app-json-code-editor>
        </label>
        <div class="action-row">
          <button
            type="button"
            class="btn btn-primary"
            [disabled]="state.taskSavingType === 'sentence_structure' || !state.lessonId || !state.passageUnitId"
            (click)="commitTask()"
          >
            {{ state.taskSavingType === 'sentence_structure' ? 'Saving...' : 'Commit Task' }}
          </button>
        </div>
      </div>
    </ng-container>
  </div>
</div>

<div
  class="sentence-context-menu"
  *ngIf="contextMenuOpen"
  [style.left.px]="contextMenuX"
  [style.top.px]="contextMenuY"
  (click)="$event.stopPropagation()"
>
  <button
    type="button"
    class="sentence-context-action"
    [disabled]="!contextMenuSelection"
    (click)="addContextSelection()"
  >
    Add selected text as sentence
  </button>
  <button
    type="button"
    class="sentence-context-action"
    [disabled]="!contextMenuAyahText"
    (click)="addContextAyah()"
  >
    Add entire ayah as sentence
  </button>
  <button type="button" class="sentence-context-action is-muted" (click)="closeContextMenu()">Close</button>
</div>

<app-json-editor-modal
  [open]="editModalOpen"
  [title]="editModalTitle"
  [value]="editModalJson"
  [placeholder]="editModalPlaceholder"
  [error]="editModalError"
  (close)="closeEditModal()"
  (save)="editModalJson = $event; submitEditModal()"
></app-json-editor-modal>
