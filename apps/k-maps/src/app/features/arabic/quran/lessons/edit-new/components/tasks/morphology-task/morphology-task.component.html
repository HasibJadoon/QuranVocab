<div class="sentence-layout">
  <app-tabs
    class="sentence-tabs"
    [tabs]="tabs"
    [activeId]="activeTabId"
    variant="tabs"
    ariaLabel="Morphology task tabs"
    (tabChange)="onTabChange($event)"
  ></app-tabs>

  <div class="sentence-pane">
    <ng-container *ngIf="activeTabId === 'items'">
      <div class="sentence-card">
        <div class="sentence-card-head">
          <h4>Morphology Items</h4>
          <div class="action-row" *ngIf="!readOnly">
            <button type="button" class="btn btn-ghost btn-sm" (click)="openCreateModal($event, 'items')">Add JSON</button>
            <button type="button" class="btn btn-ghost btn-sm" (click)="loadFromVerses()">Load from verses</button>
            <button
              type="button"
              class="btn btn-ghost btn-sm"
              [disabled]="state.taskSavingType === 'morphology'"
              (click)="saveTask()"
            >
              {{ state.taskSavingType === 'morphology' ? 'Saving...' : 'Save Task' }}
            </button>
            <button
              type="button"
              class="btn btn-primary btn-sm"
              [disabled]="state.taskSavingType === 'morphology' || !state.lessonId || !state.passageUnitId"
              (click)="commitLexicon()"
            >
              {{ state.taskSavingType === 'morphology' ? 'Committing...' : 'Push to Lexicon' }}
            </button>
          </div>
        </div>
        <p class="note-muted">Current morphology rows for this task JSON.</p>

        <div class="table-wrap table-responsive app-crud-table-shell" *ngIf="items.length; else noItems">
          <table class="table align-middle app-crud-table editor-table editor-table--morph">
            <thead>
              <tr>
                <th>#</th>
                <th>Ref</th>
                <th>Word</th>
                <th>Lemma</th>
                <th>Root</th>
                <th>POS</th>
                <th>Pattern</th>
                <th *ngIf="!readOnly"></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of items; let i = index; trackBy: trackByItem">
                <td>{{ i + 1 }}</td>
                <td>{{ item['word_location'] || (item['surah'] + ':' + item['ayah'] + ':' + item['token_index']) }}</td>
                <td class="text-arabic" dir="rtl">{{ item['surface_ar'] || '—' }}</td>
                <td>
                  <ng-container *ngIf="readOnly; else editLemma">
                    <span class="text-arabic" dir="rtl">{{ itemValue(item, 'lemma_ar') || '—' }}</span>
                  </ng-container>
                  <ng-template #editLemma>
                    <input
                      type="text"
                      class="text-arabic"
                      dir="rtl"
                      [ngModel]="itemValue(item, 'lemma_ar')"
                      (ngModelChange)="updateItem(i, 'lemma_ar', $event)"
                    />
                  </ng-template>
                </td>
                <td>
                  <ng-container *ngIf="readOnly; else editRoot">
                    <span class="text-arabic" dir="rtl">{{ itemValue(item, 'root_norm') || '—' }}</span>
                  </ng-container>
                  <ng-template #editRoot>
                    <input
                      type="text"
                      class="text-arabic"
                      dir="rtl"
                      [ngModel]="itemValue(item, 'root_norm')"
                      (ngModelChange)="updateItem(i, 'root_norm', $event)"
                    />
                  </ng-template>
                </td>
                <td>
                  <ng-container *ngIf="readOnly; else editPos">
                    <span>{{ itemValue(item, 'pos') || '—' }}</span>
                  </ng-container>
                  <ng-template #editPos>
                    <select [ngModel]="itemValue(item, 'pos')" (ngModelChange)="updatePos(i, $event)">
                      <option [ngValue]="''">—</option>
                      <option [ngValue]="'noun'">noun</option>
                      <option [ngValue]="'verb'">verb</option>
                      <option [ngValue]="'adj'">adj</option>
                      <option [ngValue]="'particle'">particle</option>
                      <option [ngValue]="'phrase'">phrase</option>
                    </select>
                  </ng-template>
                </td>
                <td>
                  <ng-container *ngIf="readOnly; else editPattern">
                    <span>{{ itemValue(item, 'morph_pattern') || '—' }}</span>
                  </ng-container>
                  <ng-template #editPattern>
                    <input
                      type="text"
                      [ngModel]="itemValue(item, 'morph_pattern')"
                      (ngModelChange)="updateItem(i, 'morph_pattern', $event)"
                    />
                  </ng-template>
                </td>
                <td *ngIf="!readOnly">
                  <button
                    type="button"
                    class="btn btn-ghost btn-sm"
                    title="Attach evidences (opens JSON modal)"
                    (click)="addEvidenceAndMorphologyFromItem($event, i)"
                  >
                    Attach Evidence
                  </button>
                  <button type="button" class="btn btn-ghost btn-sm" (click)="openEditModal($event, item, i, 'items')">
                    JSON
                  </button>
                  <button type="button" class="btn btn-ghost btn-sm" (click)="removeItem(i)">Remove</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <ng-template #noItems>
          <p class="text-muted">
            {{ readOnly ? 'No morphology items available for this lesson yet.' : 'No morphology items yet. Click “Load from verses” to populate.' }}
          </p>
        </ng-template>
      </div>
    </ng-container>

    <ng-container *ngIf="activeTabId === 'evidence'">
      <div class="sentence-card">
        <div class="sentence-card-head">
          <h4>Lexicon Evidence</h4>
          <div class="action-row" *ngIf="!readOnly">
            <button type="button" class="btn btn-ghost btn-sm" (click)="openCreateModal($event, 'evidence')">Add JSON</button>
            <button
              type="button"
              class="btn btn-ghost btn-sm"
              [disabled]="state.taskSavingType === 'morphology'"
              (click)="saveTask()"
            >
              {{ state.taskSavingType === 'morphology' ? 'Saving...' : 'Save Task' }}
            </button>
            <button
              type="button"
              class="btn btn-primary btn-sm"
              [disabled]="state.taskSavingType === 'morphology' || !state.lessonId || !state.passageUnitId"
              (click)="commitLexicon()"
            >
              {{ state.taskSavingType === 'morphology' ? 'Committing...' : 'Push to Lexicon' }}
            </button>
          </div>
        </div>
        <p class="note-muted">Rows from <code>task_json.lexicon_evidence</code> (upserted into <code>ar_u_lexicon_evidence</code> on commit).</p>

        <div class="table-wrap table-responsive app-crud-table-shell" *ngIf="evidenceItems.length; else noEvidence">
          <table class="table align-middle app-crud-table editor-table editor-table--morph">
            <thead>
              <tr>
                <th>#</th>
                <th>Lexicon</th>
                <th>Locator</th>
                <th>Source/Ref</th>
                <th>Role</th>
                <th *ngIf="!readOnly"></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of evidenceItems; let i = index; trackBy: trackByEvidence">
                <td>{{ i + 1 }}</td>
                <td class="text-arabic" dir="rtl">{{ evidenceLexiconLabel(item) }}</td>
                <td>{{ item['locator_type'] || 'chunk' }}</td>
                <td>{{ evidenceSourceLabel(item) }}</td>
                <td>
                  <span [class]="roleClass(item['link_role'], 'supports')">
                    {{ roleLabel(item['link_role'], 'supports') }}
                  </span>
                </td>
                <td *ngIf="!readOnly">
                  <button type="button" class="btn btn-ghost btn-sm" (click)="openEditModal($event, item, i, 'evidence')">
                    JSON
                  </button>
                  <button type="button" class="btn btn-ghost btn-sm" (click)="removeEvidence(i)">Remove</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <ng-template #noEvidence>
          <p class="text-muted">No evidence rows yet. Add JSON entries to link lexicon to source evidence.</p>
        </ng-template>
      </div>
    </ng-container>

    <ng-container *ngIf="activeTabId === 'links'">
      <div class="sentence-card">
        <div class="sentence-card-head">
          <h4>Lexicon Morphology Links</h4>
          <div class="action-row" *ngIf="!readOnly">
            <button type="button" class="btn btn-ghost btn-sm" (click)="openCreateModal($event, 'links')">Add JSON</button>
            <button
              type="button"
              class="btn btn-ghost btn-sm"
              [disabled]="state.taskSavingType === 'morphology'"
              (click)="saveTask()"
            >
              {{ state.taskSavingType === 'morphology' ? 'Saving...' : 'Save Task' }}
            </button>
            <button
              type="button"
              class="btn btn-primary btn-sm"
              [disabled]="state.taskSavingType === 'morphology' || !state.lessonId || !state.passageUnitId"
              (click)="commitLexicon()"
            >
              {{ state.taskSavingType === 'morphology' ? 'Committing...' : 'Push to Lexicon' }}
            </button>
          </div>
        </div>
        <p class="note-muted">Rows from <code>task_json.lexicon_morphology</code> (upserted into <code>ar_u_lexicon_morphology</code> on commit).</p>

        <div class="table-wrap table-responsive app-crud-table-shell" *ngIf="lexiconMorphologyItems.length; else noLinks">
          <table class="table align-middle app-crud-table editor-table editor-table--morph">
            <thead>
              <tr>
                <th>#</th>
                <th>Lexicon</th>
                <th>Morphology</th>
                <th>Role</th>
                <th *ngIf="!readOnly"></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of lexiconMorphologyItems; let i = index; trackBy: trackByLink">
                <td>{{ i + 1 }}</td>
                <td class="text-arabic" dir="rtl">{{ linkLexiconLabel(item) }}</td>
                <td>{{ linkMorphologyLabel(item) }}</td>
                <td>
                  <span [class]="roleClass(item['link_role'], 'primary')">
                    {{ roleLabel(item['link_role'], 'primary') }}
                  </span>
                </td>
                <td *ngIf="!readOnly">
                  <button type="button" class="btn btn-ghost btn-sm" (click)="openEditModal($event, item, i, 'links')">
                    JSON
                  </button>
                  <button type="button" class="btn btn-ghost btn-sm" (click)="removeLexiconMorphology(i)">Remove</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <ng-template #noLinks>
          <p class="text-muted">No morphology links yet. Add JSON entries to link lexicon to morphology cards.</p>
        </ng-template>
      </div>
    </ng-container>
  </div>
</div>

<app-json-editor-modal
  *ngIf="!readOnly"
  [open]="editModalOpen"
  [title]="editModalTitle"
  [value]="editModalJson"
  [placeholder]="editModalPlaceholder"
  [error]="editModalError"
  [showNavigation]="editModalIndex !== null && editModalIndex >= 0"
  [disablePrevious]="!canNavigatePrev"
  [disableNext]="!canNavigateNext"
  (close)="closeEditModal()"
  (save)="onModalSave($event)"
  (previous)="onModalPrevious($event)"
  (next)="onModalNext($event)"
></app-json-editor-modal>
