<div class="step-section">
  <div class="section-head">
    <div>
      <h3>Lesson Metadata</h3>
      <p>Wrap the Unit + Tasks into a teachable lesson object.</p>
    </div>
    <span class="lock-pill" [class.lock-pill--on]="state.lessonLocked">{{ state.lessonLocked ? 'Lesson locked' : 'Lesson open' }}</span>
  </div>

  <div class="lesson-grid">
    <div class="lesson-card">
      <h4>Lesson Meta</h4>
      <label>
        <span>Title (EN)</span>
        <input type="text" [(ngModel)]="state.lessonTitleEn" [disabled]="state.lessonLocked" placeholder="Surah Yusuf 12:1-7 - Opening" />
      </label>
      <label>
        <span>Title (AR)</span>
        <input type="text" class="input-ar" [(ngModel)]="state.lessonTitleAr" [disabled]="state.lessonLocked" placeholder="سورة يوسف ١٢:١" />
      </label>
      <div class="field-row">
        <label>
          <span>Lesson type</span>
          <input type="text" value="Qur'an" disabled />
        </label>
        <label>
          <span>Subtype</span>
          <select [(ngModel)]="state.lessonSubtype" [disabled]="state.lessonLocked">
            <option value="" disabled>Select subtype</option>
            <option value="narrative">Narrative</option>
            <option value="grammar">Grammar</option>
            <option value="thematic">Thematic</option>
            <option value="ethics">Ethics</option>
            <option value="belief">Belief</option>
            <option value="law">Law</option>
            <option value="recitation">Recitation</option>
          </select>
        </label>
      </div>
      <div class="field-row">
        <div class="difficulty-block">
          <span>Difficulty</span>
          <div class="difficulty-row">
            <button
              type="button"
              class="difficulty-chip"
              *ngFor="let level of difficultyLevels"
              [class.active]="state.lessonDifficulty === level"
              (click)="setDifficulty(level)"
              [disabled]="state.lessonLocked"
            >
              {{ level }}
            </button>
          </div>
        </div>
        <label>
          <span>Source</span>
          <input type="text" value="Qur'an" disabled />
        </label>
      </div>
    </div>

    <div class="lesson-card">
      <h4>Lesson Reference</h4>
      <div class="info-row">
        <span>Container</span>
        <strong>{{ state.referenceLocked ? 'Locked' : 'Not set' }}</strong>
      </div>
      <div class="info-row">
        <span>Unit</span>
        <strong>{{ state.referenceLocked ? 'Locked' : 'Not set' }}</strong>
      </div>
      <div class="info-row">
        <span>Surah</span>
        <strong class="arabic">{{ surahName }}</strong>
      </div>
      <div class="info-row">
        <span>Ayah range</span>
        <strong>{{ selectedRangeLabel }}</strong>
      </div>
      <div class="info-row">
        <span>Reference label</span>
        <strong>{{ referenceLabel }}</strong>
      </div>
      <p class="note-muted">IDs are hidden by policy. Reference integrity is enforced.</p>
    </div>
  </div>

  <div class="lesson-card lesson-json-card">
    <h4>Lesson JSON (Optional)</h4>
    <p class="note-muted">Paste lesson JSON here. The meta block is controlled by the fields above and will override any meta in this JSON.</p>
    <label>
      <span>Lesson JSON</span>
      <textarea
        rows="10"
        [(ngModel)]="state.lessonJsonRaw"
        [disabled]="state.savingLesson"
        placeholder='{\n  "comprehension": {\n    "reflective": []\n  }\n}'
      ></textarea>
    </label>
  </div>

  <div class="action-row">
    <button type="button" class="btn btn-primary" [disabled]="state.savingLesson" (click)="saveLessonMeta()">
      Save Lesson Metadata
    </button>
  </div>
  <p *ngIf="state.statusMessage" class="status-banner" [ngClass]="state.statusTone">
    {{ state.statusMessage }}
  </p>
</div>
