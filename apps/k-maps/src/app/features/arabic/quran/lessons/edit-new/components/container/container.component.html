<div class="step-section">
  <div class="section-head">
    <div>
      <h3>Select Qur'anic Passage</h3>
      <p>Define the canonical Qur'anic location. This locks the Container + Unit.</p>
    </div>
    <span class="lock-pill" [class.lock-pill--on]="state.referenceLocked">
      {{ state.referenceLocked ? 'Reference locked' : 'Reference open' }}
    </span>
  </div>

  <div class="container-grid">
    <div class="container-form">
      <label class="surah-search">
        <span>Surah lookup (number / Arabic name)</span>
        <input
          type="text"
          [(ngModel)]="state.surahQuery"
          (input)="onSurahQueryChange()"
          [disabled]="state.referenceLocked"
          placeholder="Type surah number or Arabic name"
        />
      </label>
      <label>
        <span>Surah</span>
        <select class="surah-select" [(ngModel)]="state.selectedSurah" (change)="onSurahChange()" [disabled]="state.referenceLocked">
          <option *ngFor="let s of filteredSurahs" [value]="s.surah">
            {{ s.surah }} - {{ s.name_ar }}
          </option>
        </select>
      </label>

      <div class="range-inputs">
        <label>
          <span>Ayah from</span>
          <input type="number" min="1" [(ngModel)]="state.rangeStart" (ngModelChange)="onRangeStartChange($event)" [disabled]="state.referenceLocked" />
        </label>
        <label>
          <span>Ayah to</span>
          <input type="number" min="1" [(ngModel)]="state.rangeEnd" (ngModelChange)="onRangeEndChange($event)" [disabled]="state.referenceLocked" />
        </label>
      </div>

      <div class="range-summary">
        <div>
          <span class="label">Selected range</span>
          <strong>{{ selectedRangeLabel }}</strong>
        </div>
        <div class="range-actions">
          <button type="button" class="btn btn-ghost" (click)="clearRange()" [disabled]="state.referenceLocked">Clear Range</button>
        </div>
      </div>
      <p class="status-banner info">No drafts. No partial saves.</p>
    </div>

    <div class="container-preview">
      <div class="preview-card">
        <span class="preview-kicker">Live preview</span>
        <strong class="preview-title">{{ surahName }}</strong>
        <span class="preview-range">{{ selectedRangeLabel }}</span>
      </div>
      <div class="preview-card muted">
        <span class="preview-kicker">Reference label</span>
        <strong class="preview-title">{{ referenceLabel }}</strong>
        <span class="preview-range">Container -> Unit auto-created</span>
      </div>
    </div>
  </div>

  <div class="ayah-list" *ngIf="!state.loadingAyahs && state.ayahs.length">
    <article
      class="ayah-card"
      *ngFor="let ayah of state.ayahs"
      [class.ayah-card--selected]="isAyahSelected(ayah)"
    >
      <div class="ayah-header">
        <div>
          <span class="ayah-index">Ayah {{ ayah.ayah }}</span>
          <span class="ayah-key">Surah {{ ayah.surah }}</span>
        </div>
        <div class="ayah-actions">
          <button type="button" class="btn btn-ghost btn-sm" (click)="setStart(ayah)" [disabled]="state.referenceLocked">
            Start
          </button>
          <button type="button" class="btn btn-ghost btn-sm" (click)="setEnd(ayah)" [disabled]="state.referenceLocked">
            End
          </button>
        </div>
      </div>
      <p class="ayah-text">{{ ayah.text }}</p>
      <div class="ayah-words" *ngIf="ayah.words?.length">
        <ng-container *ngFor="let word of ayah.words">
          <span *ngIf="wordLabel(word) as label" class="ayah-word" [title]="wordTitle(word)">
            {{ label }}
          </span>
        </ng-container>
      </div>
      <p *ngIf="!ayah.words?.length" class="ayah-words-empty">No word tokens available.</p>
    </article>
  </div>

  <div *ngIf="state.loadingAyahs" class="text-muted">Loading ayahs...</div>
  <div *ngIf="!state.loadingAyahs && !state.ayahs.length" class="text-muted">No ayahs loaded.</div>
  <div *ngIf="state.ayahError" class="error-banner">{{ state.ayahError }}</div>

  <div class="action-row">
    <button
      type="button"
      class="btn btn-primary"
      [disabled]="state.referenceLocked || state.savingContainer || !rangeValid"
      (click)="lockReference()"
    >
      Continue
    </button>
  </div>
  <p *ngIf="state.statusMessage" class="status-banner" [ngClass]="state.statusTone">
    {{ state.statusMessage }}
  </p>
</div>
