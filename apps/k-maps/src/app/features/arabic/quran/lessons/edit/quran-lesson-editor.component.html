<section *ngIf="lesson as lessonData; else loadingTpl" class="lesson-builder lesson-builder--workflow">
  <app-lesson-builder-header
    [kicker]="'K-Maps Â· Quran Lesson Builder'"
    [title]="lessonData.title"
    [intent]="activeTabIntent"
    [currentStep]="activeTabIndex + 1"
    [totalSteps]="tabs.length"
    [isSaving]="isSaving"
    [isNormalizing]="isNormalizing"
    [isNew]="isNewLesson"
    [showNormalize]="true"
    (back)="back()"
    (view)="openView()"
    (save)="save()"
    (normalize)="normalizeLessonIds()"
  />

  <div class="builder-workspace">
    <aside class="builder-workflow-rail">
      <app-lesson-builder-tabs
        [tabs]="tabs"
        [activeTabId]="activeTabId"
        [lockedTabs]="lockedTabs"
        [statuses]="tabStatuses"
        [layout]="'rail'"
        (tabChange)="selectTab($event)"
      />
    </aside>

    <section class="builder-main">
      <app-dirty-state-bar
        [currentStep]="activeTabIndex + 1"
        [totalSteps]="tabs.length"
        [canPrev]="canGoPrevTab"
        [canNext]="canGoNextTab"
        (prev)="goPrevTab()"
        (next)="goNextTab()"
      />

      <p
        class="save-status"
        *ngIf="saveStatusMessage"
        [class.save-status--loading]="isSaving && saveStatusTone === 'info'"
        [class.save-status--success]="saveStatusTone === 'success'"
        [class.save-status--error]="saveStatusTone === 'error'"
      >
        {{ saveStatusMessage }}
      </p>

      <section class="builder-panel">
        <app-tab-lock-banner [message]="activeTabLockMessage" />

        <ng-container *ngIf="!activeTabLockMessage" [ngSwitch]="activeTabId">
      <ng-container *ngSwitchCase="'meta'">
        <app-lesson-meta-form
          [lesson]="lessonData"
          [reference]="safeReference"
          (changed)="onLessonEdited()"
        />

        <label>
          <span>Comprehension (JSON)</span>
          <textarea
            rows="12"
            [ngModel]="metaComprehensionJson"
            (ngModelChange)="onMetaComprehensionJsonChange($event)"
          ></textarea>
        </label>

        <label>
          <span>Notes (JSON)</span>
          <textarea
            rows="8"
            [ngModel]="metaNotesJson"
            (ngModelChange)="onMetaNotesJsonChange($event)"
          ></textarea>
        </label>

        <p class="feedback" *ngIf="metaJsonError">{{ metaJsonError }}</p>
      </ng-container>

      <ng-container *ngSwitchCase="'verses'">
        <app-verse-range-picker
          [surahOptions]="surahOptions"
          [selection]="verseSelection"
          (apply)="applyVerseSelection()"
        />

        <app-selection-summary-card
          [containerId]="proposedContainerId"
          [passageUnitId]="proposedPassageUnitId"
        />

        <app-verse-preview-list
          [verses]="safeArabicVerses"
          (changed)="onLessonEdited()"
        />
      </ng-container>

      <ng-container *ngSwitchCase="'container'">
        <app-selection-summary-card
          [containerId]="containerForm.containerId || proposedContainerId"
          [passageUnitId]="containerForm.unitId || proposedPassageUnitId"
        />

        <app-container-builder-form [form]="containerForm" />

        <app-create-container-button-row
          (createContainer)="createContainer()"
          (linkLesson)="linkLessonContainer()"
        />

        <app-passage-unit-builder
          [unitId]="containerForm.unitId"
          (draftPassage)="createPassageUnitDraft()"
        />

        <p class="feedback" *ngIf="occurrenceFeedback">{{ occurrenceFeedback }}</p>
      </ng-container>

      <ng-container *ngSwitchCase="'units'">
        <app-bulk-actions
          (createAll)="attachAllVerseUnits()"
          (fixOrder)="fixVerseUnitOrder()"
        />

        <app-verse-units-table
          [rows]="verseUnitRows"
          (attach)="attachVerseUnit($event)"
        />

        <app-lesson-unit-link-panel
          [units]="safeUnits"
          (remove)="removeLessonUnit($event)"
        />
      </ng-container>

      <ng-container *ngSwitchCase="'tokens'">
        <div class="split-layout">
          <app-unit-navigator
            [verses]="selectedVerseNavItems"
            [selectedUnitId]="selectedVerse?.unit_id || ''"
            (select)="selectVerse($event)"
          />

          <app-center-workspace-outlet>
            <app-occ-token-grid
              [tokens]="selectedVerseTokens"
              [canLookup]="canLookupTokens"
              [lookupLoading]="lookupTokensLoading"
              [splitAffixes]="lookupSplitAffixes"
              (splitAffixesChange)="lookupSplitAffixes = $event"
              (add)="addTokenForSelectedVerse()"
              (remove)="removeTokenById($event)"
              (changed)="onLessonEdited()"
              (autoFeatures)="autoBuildTokenFeatures($event)"
              (lookup)="lookupTokensAndLemmas()"
              (tokenFeaturesInput)="onTokenFeaturesInput($event)"
            />
          </app-center-workspace-outlet>

          <app-context-right-pane class="context-pane--split">
            <app-lemma-location-panel
              [lemmas]="selectedVerseLemmas"
              (add)="addLemmaToSelectedVerse()"
              (remove)="removeSelectedVerseLemma($event)"
              (changed)="onLessonEdited()"
            />

            <app-grammar-link-panel
              [title]="'Token Grammar Links'"
              [targets]="tokenGrammarTargets"
              [selectedTargetId]="selectedGrammarTargetId.token"
              [grammarConcepts]="grammarConcepts"
              [linkMap]="grammarLinks.token"
              (selectedTargetChange)="onGrammarTargetChange('token', $event)"
              (add)="addGrammarLink('token', $event)"
              (remove)="removeGrammarLink('token', $event)"
            />
          </app-context-right-pane>
        </div>
      </ng-container>

      <ng-container *ngSwitchCase="'spans'">
        <div class="split-layout">
          <app-unit-navigator
            [verses]="selectedVerseNavItems"
            [selectedUnitId]="selectedVerse?.unit_id || ''"
            (select)="selectVerse($event)"
          />

          <app-center-workspace-outlet>
            <app-span-builder
              [spans]="selectedVerseSpans"
              (add)="addSpanForSelectedVerse()"
              (remove)="removeSpanById($event)"
              (changed)="onLessonEdited()"
              (tokenIdsInput)="onSpanTokenIdsInput($event.span, $event.value)"
            />
          </app-center-workspace-outlet>

          <app-context-right-pane>
            <app-grammar-link-panel
              [title]="'Span Grammar Links'"
              [targets]="spanGrammarTargets"
              [selectedTargetId]="selectedGrammarTargetId.span"
              [grammarConcepts]="grammarConcepts"
              [linkMap]="grammarLinks.span"
              (selectedTargetChange)="onGrammarTargetChange('span', $event)"
              (add)="addGrammarLink('span', $event)"
              (remove)="removeGrammarLink('span', $event)"
            />
          </app-context-right-pane>
        </div>
      </ng-container>

      <ng-container *ngSwitchCase="'sentences'">
        <div class="split-layout">
          <app-unit-navigator
            [verses]="selectedVerseNavItems"
            [selectedUnitId]="selectedVerse?.unit_id || ''"
            (select)="selectVerse($event)"
          />

          <app-center-workspace-outlet>
            <app-sentence-segmentation-canvas
              (add)="addSentenceForSelectedVerse()"
            />
            <app-sentence-list
              [sentences]="selectedVerseSentences"
              (remove)="removeSentenceById($event)"
              (changed)="onLessonEdited()"
            />
          </app-center-workspace-outlet>

          <app-context-right-pane>
            <app-sentence-upsert-actions
              [form]="sentenceForm"
              [feedback]="occurrenceFeedback || ''"
              (save)="submitOccurrence()"
            />

            <app-grammar-link-panel
              [title]="'Sentence Grammar Links'"
              [targets]="sentenceGrammarTargets"
              [selectedTargetId]="selectedGrammarTargetId.sentence"
              [grammarConcepts]="grammarConcepts"
              [linkMap]="grammarLinks.sentence"
              (selectedTargetChange)="onGrammarTargetChange('sentence', $event)"
              (add)="addGrammarLink('sentence', $event)"
              (remove)="removeGrammarLink('sentence', $event)"
            />
          </app-context-right-pane>
        </div>
      </ng-container>

      <ng-container *ngSwitchCase="'grammar'">
        <div class="split-layout">
          <app-unit-navigator
            [verses]="selectedVerseNavItems"
            [selectedUnitId]="selectedVerse?.unit_id || ''"
            (select)="selectVerse($event)"
          />

          <app-center-workspace-outlet>
            <div class="row-actions">
              <button
                type="button"
                class="btn"
                [class.btn-primary]="grammarFocusType === 'token'"
                (click)="selectGrammarFocus('token')"
              >
                Token Links
              </button>
              <button
                type="button"
                class="btn"
                [class.btn-primary]="grammarFocusType === 'span'"
                (click)="selectGrammarFocus('span')"
              >
                Span Links
              </button>
              <button
                type="button"
                class="btn"
                [class.btn-primary]="grammarFocusType === 'sentence'"
                (click)="selectGrammarFocus('sentence')"
              >
                Sentence Links
              </button>
            </div>

            <app-grammar-matrix [rows]="grammarMatrixRows" />
          </app-center-workspace-outlet>

          <app-context-right-pane>
            <ng-container [ngSwitch]="grammarFocusType">
              <app-grammar-link-panel
                *ngSwitchCase="'token'"
                [title]="'Token Grammar Links'"
                [targets]="tokenGrammarTargets"
                [selectedTargetId]="selectedGrammarTargetId.token"
                [grammarConcepts]="grammarConcepts"
                [linkMap]="grammarLinks.token"
                (selectedTargetChange)="onGrammarTargetChange('token', $event)"
                (add)="addGrammarLink('token', $event)"
                (remove)="removeGrammarLink('token', $event)"
              />

              <app-grammar-link-panel
                *ngSwitchCase="'span'"
                [title]="'Span Grammar Links'"
                [targets]="spanGrammarTargets"
                [selectedTargetId]="selectedGrammarTargetId.span"
                [grammarConcepts]="grammarConcepts"
                [linkMap]="grammarLinks.span"
                (selectedTargetChange)="onGrammarTargetChange('span', $event)"
                (add)="addGrammarLink('span', $event)"
                (remove)="removeGrammarLink('span', $event)"
              />

              <app-grammar-link-panel
                *ngSwitchCase="'sentence'"
                [title]="'Sentence Grammar Links'"
                [targets]="sentenceGrammarTargets"
                [selectedTargetId]="selectedGrammarTargetId.sentence"
                [grammarConcepts]="grammarConcepts"
                [linkMap]="grammarLinks.sentence"
                (selectedTargetChange)="onGrammarTargetChange('sentence', $event)"
                (add)="addGrammarLink('sentence', $event)"
                (remove)="removeGrammarLink('sentence', $event)"
              />
            </ng-container>
          </app-context-right-pane>
        </div>
      </ng-container>

      <ng-container *ngSwitchCase="'tree'">
        <div class="split-layout">
          <app-unit-navigator
            [verses]="selectedVerseNavItems"
            [selectedUnitId]="selectedVerse?.unit_id || ''"
            (select)="selectVerse($event)"
          />

          <app-center-workspace-outlet>
            <label>
              <span>Sentence target</span>
              <select [ngModel]="selectedSentenceIdForTree" (ngModelChange)="selectTreeSentence($event)">
                <option value="">Select sentence</option>
                <option *ngFor="let sentence of treeSentenceTargets" [value]="sentence.id">
                  {{ sentence.label }}
                </option>
              </select>
            </label>

            <app-sentence-tree-canvas
              [tree]="activeSentenceTree"
              (addNode)="addTreeNode()"
              (removeNode)="removeTreeNode($event)"
              (addEdge)="addTreeEdge()"
              (removeEdge)="removeTreeEdge($event)"
              (changed)="onTreeChanged()"
            />
          </app-center-workspace-outlet>

          <app-context-right-pane>
            <h3>Tree Coverage</h3>
            <p class="feedback">
              Nodes: {{ activeSentenceTree?.nodes?.length || 0 }}
            </p>
            <p class="feedback">
              Edges: {{ activeSentenceTree?.edges?.length || 0 }}
            </p>
            <p class="feedback" *ngIf="!selectedSentenceIdForTree">
              Select a sentence to start a tree.
            </p>
          </app-context-right-pane>
        </div>
      </ng-container>

      <ng-container *ngSwitchCase="'content'">
        <div class="content-grid">
          <app-mcq-editor
            [questions]="safeMcqQuestions"
            (addQuestion)="addMcqQuestion()"
            (removeQuestion)="removeMcqQuestion($event)"
            (addOption)="addMcqOption($event)"
            (removeOption)="removeMcqOption($event)"
            (changed)="onLessonEdited()"
          />

          <app-reflective-questions
            [questions]="reflectiveQuestions"
            (add)="addReflectiveQuestion()"
            (remove)="removeReflectiveQuestion($event)"
            (changed)="onLessonEdited()"
          />

          <app-analytical-questions
            [questions]="analyticalQuestions"
            (add)="addAnalyticalQuestion()"
            (remove)="removeAnalyticalQuestion($event)"
            (changed)="onLessonEdited()"
          />
        </div>
      </ng-container>

      <ng-container *ngSwitchCase="'review'">
        <div class="review-head">
          <h3>Workflow Health</h3>
          <strong>{{ completionPercent }}%</strong>
        </div>

        <app-lesson-validation-checklist [items]="reviewItems" />

        <div class="row-actions">
          <button type="button" class="btn btn-primary" [disabled]="!canPublish" (click)="publishDraft()">
            Mark Published
          </button>
          <button type="button" class="btn btn-ghost" (click)="save()">Save Now</button>
        </div>
      </ng-container>

      <ng-container *ngSwitchCase="'dev'">
        <app-selection-summary-card
          [containerId]="containerForm.containerId || proposedContainerId"
          [passageUnitId]="containerForm.unitId || proposedPassageUnitId"
        />

        <app-raw-json-editor
          [value]="lessonJson"
          [error]="jsonError"
          (apply)="lessonJson = $event; applyFullJson()"
        />
      </ng-container>
        </ng-container>
      </section>
    </section>
  </div>
</section>

<ng-template #loadingTpl>
  <section class="lesson-builder lesson-builder--loading">
    <div class="loading">Loading lesson...</div>
  </section>
</ng-template>
