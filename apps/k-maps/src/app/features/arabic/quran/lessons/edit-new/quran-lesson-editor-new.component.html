<section class="quran-edit-new">
  <header class="edit-hero">
    <div>
      <p class="hero-kicker">Qur'anic Lesson Builder</p>
      <h1>{{ state.lessonTitleEn || (state.isNew ? 'New Quran Lesson' : 'Lesson #' + state.lessonId) }}</h1>
      <p class="hero-intent">Container -> Unit -> Lesson -> Tasks. Structure first, pedagogy later.</p>
    </div>
    <div class="hero-actions">
      <button type="button" class="btn btn-ghost" (click)="clearDraft()">New Quran Lesson</button>
      <button type="button" class="btn btn-ghost" (click)="back()">Back</button>
    </div>
  </header>

  <div class="edit-grid">
    <aside class="step-rail">
      <div class="step-rail-header">
        <span>Workflow</span>
        <span class="rail-meta">Step {{ state.activeStepIndex + 1 }} / {{ state.steps.length }}</span>
      </div>
      <button
        *ngFor="let step of state.steps; let i = index"
        type="button"
        class="step-item"
        [class.step-item--active]="i === state.activeStepIndex"
        [class.step-item--locked]="isStepLocked(i)"
        [class.step-item--disabled]="i > state.unlockedStepIndex"
        (click)="selectStep(i)"
      >
        <span class="step-index">0{{ i + 1 }}</span>
        <span class="step-label">{{ step.label }}</span>
        <span class="step-status">
          {{ isStepLocked(i) ? 'Locked' : i === state.activeStepIndex ? 'Active' : i <= state.unlockedStepIndex ? 'Open' : 'Pending' }}
        </span>
      </button>
    </aside>

    <main class="edit-panel">
      <div class="panel-head">
        <div>
          <h2>{{ activeStep.label }}</h2>
          <p>{{ activeStep.intent }}</p>
        </div>
        <div class="panel-actions">
          <span class="panel-chip" [class.panel-chip--locked]="state.referenceLocked">
            {{ state.referenceLocked ? 'Reference Locked' : 'Reference Open' }}
          </span>
          <span class="panel-chip" [class.panel-chip--locked]="state.lessonLocked">
            {{ state.lessonLocked ? 'Lesson Saved' : 'Lesson Draft' }}
          </span>
        </div>
      </div>

      <div class="panel-body">
        <ng-container [ngSwitch]="activeStep.id">
          <div *ngSwitchCase="'container'" class="step-section">
            <div class="section-head">
              <div>
                <h3>Select Qur'anic Passage</h3>
                <p>Define the canonical Qur'anic location. This locks the Container + Unit.</p>
              </div>
              <span class="lock-pill" [class.lock-pill--on]="state.referenceLocked">
                {{ state.referenceLocked ? 'Reference locked' : 'Reference open' }}
              </span>
            </div>

            <div class="container-grid">
              <div class="container-form">
                <label class="surah-search">
                  <span>Surah lookup (number / Arabic name)</span>
                  <input
                    type="text"
                    [(ngModel)]="state.surahQuery"
                    (input)="onSurahQueryChange()"
                    [disabled]="state.referenceLocked"
                    placeholder="Type surah number or Arabic name"
                  />
                </label>
                <label>
                  <span>Surah</span>
                  <select class="surah-select" [(ngModel)]="state.selectedSurah" (change)="onSurahChange()" [disabled]="state.referenceLocked">
                    <option *ngFor="let s of filteredSurahs" [value]="s.surah">
                      {{ s.surah }} - {{ s.name_ar }}
                    </option>
                  </select>
                </label>

                <div class="range-inputs">
                  <label>
                    <span>Ayah from</span>
                    <input type="number" min="1" [(ngModel)]="state.rangeStart" (ngModelChange)="onRangeStartChange($event)" [disabled]="state.referenceLocked" />
                  </label>
                  <label>
                    <span>Ayah to</span>
                    <input type="number" min="1" [(ngModel)]="state.rangeEnd" (ngModelChange)="onRangeEndChange($event)" [disabled]="state.referenceLocked" />
                  </label>
                </div>

                <div class="range-summary">
                  <div>
                    <span class="label">Selected range</span>
                    <strong>{{ selectedRangeLabel }}</strong>
                  </div>
                  <div class="range-actions">
                    <button type="button" class="btn btn-ghost" (click)="clearRange()" [disabled]="state.referenceLocked">Clear Range</button>
                  </div>
                </div>
                <p class="status-banner info">No drafts. No partial saves.</p>
              </div>

              <div class="container-preview">
                <div class="preview-card">
                  <span class="preview-kicker">Live preview</span>
                  <strong class="preview-title">{{ surahName }}</strong>
                  <span class="preview-range">{{ selectedRangeLabel }}</span>
                </div>
                <div class="preview-card muted">
                  <span class="preview-kicker">Reference label</span>
                  <strong class="preview-title">{{ referenceLabel }}</strong>
                  <span class="preview-range">Container -> Unit auto-created</span>
                </div>
              </div>
            </div>

            <div class="ayah-list" *ngIf="!state.loadingAyahs && state.ayahs.length">
              <article
                class="ayah-card"
                *ngFor="let ayah of state.ayahs"
                [class.ayah-card--selected]="isAyahSelected(ayah)"
              >
                <div class="ayah-header">
                  <div>
                    <span class="ayah-index">Ayah {{ ayah.ayah }}</span>
                    <span class="ayah-key">Surah {{ ayah.surah }}</span>
                  </div>
                  <div class="ayah-actions">
                    <button type="button" class="btn btn-ghost btn-sm" (click)="setStart(ayah)" [disabled]="state.referenceLocked">
                      Start
                    </button>
                    <button type="button" class="btn btn-ghost btn-sm" (click)="setEnd(ayah)" [disabled]="state.referenceLocked">
                      End
                    </button>
                  </div>
                </div>
                <p class="ayah-text">{{ ayah.text }}</p>
                <div class="ayah-words" *ngIf="ayah.words?.length">
                  <ng-container *ngFor="let word of ayah.words">
                    <span *ngIf="wordLabel(word) as label" class="ayah-word" [title]="wordTitle(word)">
                      {{ label }}
                    </span>
                  </ng-container>
                </div>
                <p *ngIf="!ayah.words?.length" class="ayah-words-empty">No word tokens available.</p>
              </article>
            </div>

            <div *ngIf="state.loadingAyahs" class="text-muted">Loading ayahs...</div>
            <div *ngIf="!state.loadingAyahs && !state.ayahs.length" class="text-muted">No ayahs loaded.</div>
            <div *ngIf="state.ayahError" class="error-banner">{{ state.ayahError }}</div>

            <div class="action-row">
              <button
                type="button"
                class="btn btn-primary"
                [disabled]="state.referenceLocked || state.savingContainer || !rangeValid"
                (click)="lockReference()"
              >
                Continue
              </button>
            </div>
            <p *ngIf="state.statusMessage" class="status-banner" [ngClass]="state.statusTone">
              {{ state.statusMessage }}
            </p>
          </div>

          <div *ngSwitchCase="'unit'" class="step-section">
            <div class="section-head">
              <div>
                <h3>Passage Definition</h3>
                <p>A Unit is only a passage slice. No labels. No pedagogy. No shaping.</p>
              </div>
              <span class="lock-pill lock-pill--on">Unit locked</span>
            </div>

            <div class="badge-row">
              <span class="badge">Surah {{ state.selectedSurah || '--' }}</span>
              <span class="badge">Ayah {{ rangeLabelShort }}</span>
              <span class="badge">Reference {{ referenceLabel }}</span>
            </div>

            <div class="unit-notes">
              <h4>What is not here</h4>
              <div class="note-list">
                <span>No title</span>
                <span>No tags</span>
                <span>No pedagogy</span>
                <span>No intent</span>
                <span>No difficulty</span>
              </div>
              <p>The Unit exists only so Tasks can attach to it later.</p>
            </div>

            <div class="unit-preview">
              <article class="unit-ayah" *ngFor="let ayah of selectedAyahs">
                <span class="unit-ayah-index">Ayah {{ ayah.ayah }}</span>
                <p class="unit-ayah-text">{{ ayah.text }}</p>
              </article>
            </div>
            <div class="text-muted" *ngIf="!selectedAyahs.length">No passage loaded.</div>

            <div class="action-row">
              <button type="button" class="btn btn-primary" (click)="continueToLesson()" [disabled]="!state.referenceLocked">
                Continue to Lesson
              </button>
            </div>
          </div>

          <div *ngSwitchCase="'lesson'" class="step-section">
            <div class="section-head">
              <div>
                <h3>Lesson Metadata</h3>
                <p>Wrap the Unit + Tasks into a teachable lesson object.</p>
              </div>
              <span class="lock-pill" [class.lock-pill--on]="state.lessonLocked">{{ state.lessonLocked ? 'Lesson locked' : 'Lesson open' }}</span>
            </div>

            <div class="lesson-grid">
              <div class="lesson-card">
                <h4>Lesson Meta</h4>
                <label>
                  <span>Title (EN)</span>
                  <input type="text" [(ngModel)]="state.lessonTitleEn" [disabled]="state.lessonLocked" placeholder="Surah Yusuf 12:1-7 - Opening" />
                </label>
                <label>
                  <span>Title (AR)</span>
                  <input type="text" class="input-ar" [(ngModel)]="state.lessonTitleAr" [disabled]="state.lessonLocked" placeholder="سورة يوسف ١٢:١" />
                </label>
                <div class="field-row">
                  <label>
                    <span>Lesson type</span>
                    <input type="text" value="Qur'an" disabled />
                  </label>
                  <label>
                    <span>Subtype</span>
                    <select [(ngModel)]="state.lessonSubtype" [disabled]="state.lessonLocked">
                      <option value="" disabled>Select subtype</option>
                      <option value="narrative">Narrative</option>
                      <option value="grammar">Grammar</option>
                      <option value="thematic">Thematic</option>
                      <option value="ethics">Ethics</option>
                      <option value="belief">Belief</option>
                      <option value="law">Law</option>
                      <option value="recitation">Recitation</option>
                    </select>
                  </label>
                </div>
                <div class="field-row">
                  <div class="difficulty-block">
                    <span>Difficulty</span>
                    <div class="difficulty-row">
                      <button
                        type="button"
                        class="difficulty-chip"
                        *ngFor="let level of difficultyLevels"
                        [class.active]="state.lessonDifficulty === level"
                        (click)="setDifficulty(level)"
                        [disabled]="state.lessonLocked"
                      >
                        {{ level }}
                      </button>
                    </div>
                  </div>
                  <label>
                    <span>Source</span>
                    <input type="text" value="Qur'an" disabled />
                  </label>
                </div>
              </div>

              <div class="lesson-card">
                <h4>Lesson Reference</h4>
                <div class="info-row">
                  <span>Container</span>
                  <strong>{{ state.referenceLocked ? 'Locked' : 'Not set' }}</strong>
                </div>
                <div class="info-row">
                  <span>Unit</span>
                  <strong>{{ state.referenceLocked ? 'Locked' : 'Not set' }}</strong>
                </div>
                <div class="info-row">
                  <span>Surah</span>
                  <strong class="arabic">{{ surahName }}</strong>
                </div>
                <div class="info-row">
                  <span>Ayah range</span>
                  <strong>{{ selectedRangeLabel }}</strong>
                </div>
                <div class="info-row">
                  <span>Reference label</span>
                  <strong>{{ referenceLabel }}</strong>
                </div>
                <p class="note-muted">IDs are hidden by policy. Reference integrity is enforced.</p>
              </div>
            </div>

            <div class="lesson-card lesson-json-card">
              <h4>Lesson JSON (Optional)</h4>
              <p class="note-muted">Paste lesson JSON here. The meta block is controlled by the fields above and will override any meta in this JSON.</p>
              <label>
                <span>Lesson JSON</span>
                <textarea
                  rows="10"
                  [(ngModel)]="state.lessonJsonRaw"
                  [disabled]="state.savingLesson"
                  placeholder='{\n  "comprehension": {\n    "reflective": []\n  }\n}'
                ></textarea>
              </label>
            </div>

            <div class="action-row">
              <button type="button" class="btn btn-primary" [disabled]="state.savingLesson" (click)="saveLessonMeta()">
                Save Lesson Metadata
              </button>
            </div>
            <p *ngIf="state.statusMessage" class="status-banner" [ngClass]="state.statusTone">
              {{ state.statusMessage }}
            </p>
          </div>

          <div *ngSwitchCase="'tasks'" class="step-section">
            <div class="section-head">
              <div>
                <h3>Teaching Steps</h3>
                <p>All pedagogy lives here. Tasks are ordered, optional, and extensible.</p>
              </div>
              <span class="lock-pill lock-pill--on">Pedagogy zone</span>
            </div>

            <div class="rule-card">
              <span>Units never teach.</span>
              <span>Tasks always teach.</span>
              <span>Lessons only organize.</span>
              <span>Containers only locate.</span>
            </div>
            <p class="note-muted">Each tab saves as one task record for this unit.</p>

            <p class="status-banner info" *ngIf="!state.lessonId">
              Save lesson metadata before adding tasks.
            </p>

            <div class="task-tab-row">
              <button
                type="button"
                class="task-tab"
                *ngFor="let tab of state.taskTabs; trackBy: trackByTaskType"
                [class.active]="tab.type === state.activeTaskType"
                (click)="selectTaskTab(tab.type)"
              >
                {{ tab.label }}
              </button>
            </div>

            <div class="task-editor" *ngIf="activeTaskTab as tab">
              <div class="task-meta">
                <span>Linked unit: Surah {{ state.selectedSurah || '--' }} Ayah {{ rangeLabelShort }}</span>
                <span>Task type: {{ tab.label }}</span>
              </div>
              <ng-container *ngIf="tab.type === 'reading'; else editableTask">
                <p class="note-muted">Reading is locked to the Unit verse range. No edits are allowed.</p>
                <div class="unit-preview">
                  <article class="unit-ayah" *ngFor="let ayah of selectedAyahs">
                    <span class="unit-ayah-index">Ayah {{ ayah.ayah }}</span>
                    <p class="unit-ayah-text">{{ ayah.text }}</p>
                  </article>
                </div>
                <div class="text-muted" *ngIf="!selectedAyahs.length">No passage loaded.</div>
                <div class="action-row">
                  <button
                    type="button"
                    class="btn btn-primary"
                    [disabled]="state.taskSavingType === tab.type || !state.lessonId || !state.passageUnitId"
                    (click)="saveTask(tab.type)"
                  >
                    {{ state.taskSavingType === tab.type ? 'Saving...' : 'Save Reading Task' }}
                  </button>
                </div>
              </ng-container>
              <ng-template #editableTask>
                <label>
                  <span>Task JSON</span>
                  <textarea rows="12" [(ngModel)]="tab.json" placeholder='{\n  "items": []\n}'></textarea>
                </label>
                <div class="action-row">
                  <button
                    type="button"
                    class="btn btn-primary"
                    [disabled]="state.taskSavingType === tab.type || !state.lessonId || !state.passageUnitId"
                    (click)="saveTask(tab.type)"
                  >
                    {{ state.taskSavingType === tab.type ? 'Saving...' : 'Save Task' }}
                  </button>
                </div>
              </ng-template>
            </div>
            <p *ngIf="state.statusMessage" class="status-banner" [ngClass]="state.statusTone">
              {{ state.statusMessage }}
            </p>
          </div>
        </ng-container>
      </div>
    </main>
  </div>
</section>
