<section class="quran-edit-new">
  <header class="edit-hero">
    <div>
      <p class="hero-kicker">K-Maps · Quran Editor (Fresh)</p>
      <h1>{{ lessonTitle || (isNew ? 'New Quran Lesson' : 'Lesson #' + lessonId) }}</h1>
      <p class="hero-intent">{{ activeStep?.intent }}</p>
    </div>
    <div class="hero-actions">
      <button type="button" class="btn btn-ghost" (click)="clearDraft()">New Quran Lesson</button>
      <button type="button" class="btn btn-ghost" (click)="back()">Back</button>
    </div>
  </header>

  <div class="edit-grid">
    <aside class="step-rail">
      <div class="step-rail-header">
        <span>Step {{ activeStepIndex + 1 }} / {{ steps.length }}</span>
      </div>
      <button
        *ngFor="let step of steps; let i = index"
        type="button"
        class="step-item"
        [class.step-item--active]="i === activeStepIndex"
        (click)="selectStep(i)"
      >
        <span class="step-index">0{{ i + 1 }}</span>
        <span class="step-label">{{ step.label }}</span>
      </button>
    </aside>

    <main class="edit-panel">
      <div class="panel-head">
        <div>
          <h2>{{ activeStep?.label }}</h2>
          <p>{{ activeStep?.intent }}</p>
        </div>
        <div class="panel-actions">
          <button type="button" class="btn btn-ghost" [disabled]="activeStepIndex === 0" (click)="prevStep()">
            Previous
          </button>
          <button type="button" class="btn btn-primary" [disabled]="activeStepIndex === steps.length - 1" (click)="nextStep()">
            Next
          </button>
        </div>
      </div>

      <div class="panel-body">
        <ng-container [ngSwitch]="activeStep?.id">
          <div *ngSwitchCase="'meta'" class="card-stack">
            <label>
              <span>Lesson title</span>
              <input type="text" [(ngModel)]="lessonTitle" placeholder="Untitled lesson" />
            </label>
            <label>
              <span>Intent note</span>
              <textarea rows="4" [(ngModel)]="lessonNote" placeholder="Why is this lesson important?"></textarea>
            </label>
            <label>
              <span>Meta JSON</span>
              <textarea rows="6" [(ngModel)]="metaJson"></textarea>
            </label>
            <div class="meta-actions">
              <button
                type="button"
                class="btn btn-primary"
                [disabled]="savingLesson"
                (click)="isNew ? createLesson() : saveLesson()"
              >
                {{ isNew ? 'Create Lesson' : 'Save Lesson' }}
              </button>
              <button type="button" class="btn btn-ghost" (click)="selectStep(1)">
                Select Verses
              </button>
            </div>
            <p *ngIf="statusMessage" class="status-banner" [ngClass]="statusTone">
              {{ statusMessage }}
            </p>
          </div>

          <div *ngSwitchCase="'verses'" class="verse-panel">
            <div class="verse-controls">
              <label>
                <span>Surah</span>
                <select [(ngModel)]="selectedSurah" (change)="onSurahChange()">
                  <option *ngFor="let s of surahs" [value]="s.surah">
                    {{ s.surah }} · {{ s.name_en || 'Surah' }} ({{ s.name_ar }})
                  </option>
                </select>
              </label>

              <div class="range-summary">
                <div>
                  <span class="label">Selected range</span>
                  <strong>{{ selectedRangeLabel }}</strong>
                </div>
                <div class="range-actions">
                  <button type="button" class="btn btn-ghost" (click)="clearRange()">Clear Range</button>
                </div>
              </div>

              <label>
                <span>Container title</span>
                <input type="text" [(ngModel)]="containerTitle" placeholder="Surah 1 1-7" />
              </label>

              <div class="verse-actions">
                <button
                  type="button"
                  class="btn btn-primary"
                  [disabled]="savingContainer || !lessonId || rangeStart === null"
                  (click)="createContainer()"
                >
                  Create Container + Passage Unit
                </button>
                <button type="button" class="btn btn-ghost" (click)="saveLesson()" [disabled]="savingLesson || !lessonId">
                  Save Lesson
                </button>
              </div>
              <p *ngIf="statusMessage" class="status-banner" [ngClass]="statusTone">
                {{ statusMessage }}
              </p>
            </div>

            <div class="ayah-list" *ngIf="!loadingAyahs && ayahs.length">
              <article
                class="ayah-card"
                *ngFor="let ayah of ayahs"
                [class.ayah-card--selected]="isAyahSelected(ayah)"
              >
                <div class="ayah-header">
                  <div>
                    <span class="ayah-index">Ayah {{ ayah.ayah }}</span>
                    <span class="ayah-key">Surah {{ ayah.surah }}</span>
                  </div>
                  <div class="ayah-actions">
                    <button type="button" class="btn btn-ghost btn-sm" (click)="setStart(ayah)">
                      Start
                    </button>
                    <button type="button" class="btn btn-ghost btn-sm" (click)="setEnd(ayah)">
                      End
                    </button>
                  </div>
                </div>
                <p class="ayah-text">{{ ayah.text }}</p>
                <div class="ayah-words" *ngIf="ayah.words?.length">
                  <ng-container *ngFor="let word of ayah.words">
                    <span *ngIf="wordLabel(word) as label" class="ayah-word" [title]="wordTitle(word)">
                      {{ label }}
                    </span>
                  </ng-container>
                </div>
                <p *ngIf="!ayah.words?.length" class="ayah-words-empty">No word tokens available.</p>
              </article>
            </div>

            <div *ngIf="loadingAyahs" class="text-muted">Loading ayahs…</div>
            <div *ngIf="!loadingAyahs && !ayahs.length" class="text-muted">No ayahs loaded.</div>
            <div *ngIf="ayahError" class="error-banner">{{ ayahError }}</div>
          </div>

          <div *ngSwitchCase="'container'" class="card-stack">
            <div class="info-row">
              <span>Container</span>
              <strong>{{ containerId || 'Not created yet' }}</strong>
            </div>
            <div class="info-row">
              <span>Passage Unit</span>
              <strong>{{ passageUnitId || 'Not created yet' }}</strong>
            </div>
            <div class="info-row">
              <span>Title</span>
              <strong>{{ containerTitle || '—' }}</strong>
            </div>
            <button
              type="button"
              class="btn btn-primary"
              [disabled]="savingLesson || !lessonId"
              (click)="saveLesson()"
            >
              Save Lesson
            </button>
            <p *ngIf="statusMessage" class="status-banner" [ngClass]="statusTone">
              {{ statusMessage }}
            </p>
          </div>

          <div *ngSwitchDefault class="placeholder">
            <h3>Fresh canvas</h3>
            <p>This step is intentionally blank. Build the new flow here.</p>
            <div class="placeholder-grid">
              <div class="placeholder-tile">
                <span>Target</span>
                <strong>Define structure</strong>
                <p>Capture exactly what this step should collect.</p>
              </div>
              <div class="placeholder-tile">
                <span>Output</span>
                <strong>Map the data</strong>
                <p>Decide the JSON payload for this stage.</p>
              </div>
              <div class="placeholder-tile">
                <span>Flow</span>
                <strong>Keep it linear</strong>
                <p>Only advance when the core fields are ready.</p>
              </div>
            </div>
          </div>
        </ng-container>
      </div>
    </main>
  </div>
</section>
