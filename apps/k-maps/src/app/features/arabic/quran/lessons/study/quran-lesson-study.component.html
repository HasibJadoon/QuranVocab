<section
  class="quran-edit-new quran-study-shell"
  *ngIf="ready; else loadingTpl"
  [style.--app-ar-font-size]="arabicFontSize"
>
  <header class="edit-hero">
    <div>
      <p class="hero-kicker">Qur'anic Lesson Study</p>
      <h1>{{ lessonTitle }}</h1>
      <p class="hero-intent">Read-only walkthrough of all lesson tasks and concepts.</p>
    </div>
    <div class="hero-actions">
      <app-font-size-controls
        ariaLabel="Arabic font controls"
        decreaseLabel="Decrease Arabic font"
        resetLabel="Reset Arabic font"
        increaseLabel="Increase Arabic font"
        (decrease)="decreaseFont()"
        (reset)="resetFont()"
        (increase)="increaseFont()"
      ></app-font-size-controls>
      <span class="lock-pill lock-pill--on">Study Mode</span>
    </div>
  </header>

  <div class="edit-grid">
    <main class="edit-panel">
      <div class="panel-head">
        <div>
          <h2>{{ studyActiveTaskTab === 'lesson' ? 'Lesson Overview' : (activeTaskTab?.label || 'Task') }}</h2>
          <p>{{ lessonSubtitle }}</p>
        </div>
        <div class="panel-actions">
          <span class="panel-chip panel-chip--locked">Read Only</span>
          <span class="panel-chip">{{ state.taskTabs.length }} Tasks</span>
        </div>
      </div>

      <div class="panel-body">
        <ng-container *ngIf="studyActiveTaskTab === 'lesson'; else taskPane">
          <div class="task-editor">
            <div class="task-meta">
              <span>Lesson overview</span>
              <span>Surah {{ state.selectedSurah || '--' }} Ayah {{ rangeLabelShort }}</span>
            </div>

            <div class="lesson-grid">
              <article class="lesson-card">
                <h4>{{ lessonHeading }}</h4>
                <p class="note-muted">{{ lessonDetail }}</p>
                <div class="field-row">
                  <div class="rule-card">
                    <strong>Episode Intro</strong>
                    <span>{{ episodeIntro }}</span>
                  </div>
                  <div class="rule-card">
                    <strong>Scene</strong>
                    <span>{{ sceneDetail }}</span>
                  </div>
                  <div class="rule-card">
                    <strong>Aesthetic</strong>
                    <span>{{ sceneAesthetic }}</span>
                  </div>
                </div>
              </article>
            </div>
          </div>
        </ng-container>

        <ng-template #taskPane>
          <div class="task-editor" *ngIf="activeTaskTab as tab">
            <div class="task-meta">
              <span>Linked unit: Surah {{ state.selectedSurah || '--' }} Ayah {{ rangeLabelShort }}</span>
              <span>Study mode: {{ tab.label }}</span>
            </div>

            <ng-container [ngSwitch]="tab.type">
              <div class="reading-layout" *ngSwitchCase="'reading'">
                <article class="reading-summary-card">
                  <span class="reading-kicker">Reading Text</span>
                  <p
                    class="reading-text-primary text-arabic"
                    *ngIf="readingAyahWordGroups.length; else noReadingText"
                    dir="rtl"
                    translate="no"
                  >
                    <ng-container *ngFor="let ayahGroup of readingAyahWordGroups; let isLastAyah = last">
                      <ng-container *ngFor="let token of ayahGroup.words; let isLastWord = last">
                        <span
                          class="quran-word quran-word--interactive"
                          [class.quran-word--active]="isReadingWordSelected(token.location)"
                          role="button"
                          tabindex="0"
                          [attr.aria-pressed]="isReadingWordSelected(token.location)"
                          [attr.data-word-location]="token.location"
                          [attr.aria-label]="'Word ' + token.location"
                          (click)="selectReadingWord(token)"
                          (keydown)="onReadingWordKeydown($event, token)"
                        >
                          {{ token.text }}
                        </span>
                        <span *ngIf="!isLastWord"> </span>
                      </ng-container>
                      <span class="reading-ayah-mark" aria-hidden="true">{{ toArabicIndicDigits(ayahGroup.ayah) }}</span>
                      <span *ngIf="!isLastAyah"> </span>
                    </ng-container>
                  </p>
                  <ng-template #noReadingText>
                    <p class="text-muted">No reading text available.</p>
                  </ng-template>
                </article>

                <app-quran-word-inspector
                  class="reading-word-inspector"
                  [selection]="selectedReadingWord"
                  [contextLabel]="lessonSubtitle"
                  [surahLabel]="readingInspectorSurahName"
                  [morphologyItems]="morphologyItems"
                  [lexiconMorphologyItems]="lexiconMorphologyItems"
                  [evidenceItems]="morphologyEvidenceItems"
                  (close)="clearReadingWordSelection()"
                ></app-quran-word-inspector>
              </div>

              <div class="morphology-layout" *ngSwitchCase="'morphology'">
                <div class="morphology-grid">
                  <article class="morph-bucket morph-bucket--noun">
                    <div class="morph-bucket-head">
                      <h4>Nouns</h4>
                      <span class="morph-count">{{ nounMorphologyItems.length }}</span>
                    </div>

                    <app-pills
                      *ngIf="nounMorphologyPills.length; else noMorphNouns"
                      [items]="nounMorphologyPills"
                      [clickable]="true"
                      ariaLabel="Noun word and root pills"
                      (itemSelect)="onMorphologyPillSelect($event)"
                    ></app-pills>
                    <ng-template #noMorphNouns>
                      <p class="text-muted">No noun entries available.</p>
                    </ng-template>
                  </article>

                  <article class="morph-bucket morph-bucket--verb">
                    <div class="morph-bucket-head">
                      <h4>Verbs</h4>
                      <span class="morph-count">{{ verbMorphologyItems.length }}</span>
                    </div>

                    <app-pills
                      *ngIf="verbMorphologyPills.length; else noMorphVerbs"
                      [items]="verbMorphologyPills"
                      [clickable]="true"
                      ariaLabel="Verb word and root pills"
                      (itemSelect)="onMorphologyPillSelect($event)"
                    ></app-pills>
                    <ng-template #noMorphVerbs>
                      <p class="text-muted">No verb entries available.</p>
                    </ng-template>
                  </article>
                </div>

                <div
                  class="study-word-dialog-backdrop"
                  *ngIf="morphologyDialogWord as dialogWord"
                  (click)="closeMorphologyWordDialog()"
                >
                  <div
                    class="study-word-dialog"
                    role="dialog"
                    aria-modal="true"
                    aria-label="Word details"
                    (click)="$event.stopPropagation()"
                  >
                    <header class="study-word-dialog-head">
                      <div>
                        <h3 class="study-word-dialog-title">
                          {{ morphologyDialogSurahName ? 'Surah ' + morphologyDialogSurahName : 'Word Study' }}
                        </h3>
                      </div>
                      <div class="study-word-dialog-controls">
                        <div class="study-word-dialog-mode-toggle">
                          <button
                            type="button"
                            class="study-word-dialog-toggle-btn"
                            [class.study-word-dialog-toggle-btn--active]="dialogViewMode === 'context'"
                            (click)="setDialogViewMode('context')"
                          >
                            Context
                          </button>
                          <button
                            type="button"
                            class="study-word-dialog-toggle-btn"
                            [class.study-word-dialog-toggle-btn--active]="dialogViewMode === 'analysis'"
                            (click)="setDialogViewMode('analysis')"
                          >
                            Analysis
                          </button>
                        </div>
                        <button type="button" class="study-word-dialog-toggle-btn study-word-dialog-toggle-btn--wide" (click)="toggleDialogTranslation()">
                          {{ showDialogTranslation ? 'Hide Translation' : 'Show Translation' }}
                        </button>
                        <span class="study-word-dialog-ref">{{ morphologyDialogReference }}</span>
                        <button
                          type="button"
                          class="study-word-dialog-close-top"
                          aria-label="Close word details"
                          (click)="closeMorphologyWordDialog()"
                        >
                          ×
                        </button>
                      </div>
                    </header>

                    <div class="study-word-dialog-layout" [class.study-word-dialog-layout--analysis]="dialogViewMode === 'analysis'">
                      <section class="study-word-context">
                        <p class="study-word-context-bar" *ngIf="morphologyDialogContextBar">{{ morphologyDialogContextBar }}</p>
                        <div class="study-word-context-head">
                          <p>Context Verses</p>
                          <span>{{ morphologyDialogContextAyahs.length }} ayah{{ morphologyDialogContextAyahs.length === 1 ? '' : 's' }}</span>
                        </div>

                        <div class="study-word-context-list" *ngIf="morphologyDialogContextAyahs.length; else noDialogContext">
                          <article
                            class="study-word-context-ayah"
                            *ngFor="let ayah of morphologyDialogContextAyahs"
                            [class.study-word-context-ayah--focus]="ayah.isFocus"
                          >
                            <div class="study-word-context-ayah-head">
                              <span class="study-word-context-ayah-badge">{{ toArabicIndicDigits(ayah.ayah) }}</span>
                              <span>Ayah {{ ayah.ayah }}</span>
                            </div>
                            <p class="study-word-context-ar text-arabic" dir="rtl" translate="no">
                              <ng-container *ngFor="let token of ayah.words; let tokenIndex = index; let isLastToken = last">
                                <span
                                  class="study-word-context-token"
                                  [class.study-word-context-token--active]="isDialogTokenSelected(ayah.surah, ayah.ayah, tokenIndex + 1)"
                                  [attr.data-pos]="dialogTokenPos(ayah.surah, ayah.ayah, tokenIndex + 1) || null"
                                  [attr.title]="dialogTokenHint(ayah.surah, ayah.ayah, tokenIndex + 1, token)"
                                >
                                  {{ token }}
                                </span>
                                <span *ngIf="!isLastToken"> </span>
                              </ng-container>
                            </p>
                            <p class="study-word-context-translation" *ngIf="showDialogTranslation && ayah.translation">{{ ayah.translation }}</p>
                          </article>
                        </div>
                        <ng-template #noDialogContext>
                          <p class="study-word-context-empty">No verse context available for this word.</p>
                        </ng-template>
                      </section>

                      <app-quran-word-inspector
                        class="study-word-inspector-panel"
                        [selection]="dialogWord"
                        [surahLabel]="morphologyDialogSurahName"
                        [appearance]="'panel'"
                        [morphologyItems]="morphologyItems"
                        [lexiconMorphologyItems]="lexiconMorphologyItems"
                        [evidenceItems]="morphologyEvidenceItems"
                        (close)="closeMorphologyWordDialog()"
                      ></app-quran-word-inspector>
                    </div>

                    <div class="study-word-dialog-actions">
                      <button type="button" class="btn btn-ghost btn-sm" (click)="closeMorphologyWordDialog()">Close</button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="sentence-layout" *ngSwitchCase="'sentence_structure'">
                <app-tabs
                  class="sentence-tabs"
                  [tabs]="sentenceTabs"
                  [activeId]="state.sentenceSubTab"
                  variant="tabs"
                  orientation="horizontal"
                  ariaLabel="Sentence structure tabs"
                  [primaryIds]="sentencePrimaryIds"
                  overflowLabel="More"
                  (tabChange)="onSentenceTabChange($event)"
                ></app-tabs>

                <div class="sentence-pane">
                  <ng-container *ngIf="state.sentenceSubTab === 'verses'">
                    <div class="unit-preview" *ngIf="sentenceAyahsForStudy.length; else noSentenceVerses">
                      <article class="unit-ayah" *ngFor="let ayah of sentenceAyahsForStudy">
                        <span class="unit-ayah-index">Ayah {{ ayah.ayah }}</span>
                        <p class="unit-ayah-text">{{ ayah.text_uthmani || ayah.text || '—' }}</p>
                      </article>
                    </div>
                    <ng-template #noSentenceVerses>
                      <p class="text-muted">No verse preview available.</p>
                    </ng-template>
                  </ng-container>

                  <ng-container *ngIf="state.sentenceSubTab === 'items'">
                    <div class="table-wrap" *ngIf="sentenceItems.length; else noSentenceItems">
                      <table class="table align-middle app-crud-table editor-table">
                        <thead>
                          <tr>
                            <th>#</th>
                            <th>Canonical Sentence</th>
                            <th>Structure Summary</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let item of sentenceItems; let i = index">
                            <td>{{ i + 1 }}</td>
                            <td>{{ valueOf(item, ['canonical_sentence', 'text']) }}</td>
                            <td>{{ valueOf(item, ['structure_summary', 'summary', 'notes']) }}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    <ng-template #noSentenceItems>
                      <p class="text-muted">No sentence items available.</p>
                    </ng-template>
                  </ng-container>

                  <ng-container *ngIf="state.sentenceSubTab === 'json'">
                    <pre class="study-json">{{ sentenceTaskJson }}</pre>
                  </ng-container>
                </div>
              </div>

              <div *ngSwitchDefault>
                <pre class="study-json">{{ formatJson(tab.json) }}</pre>
              </div>
            </ng-container>
          </div>
        </ng-template>
      </div>
    </main>
  </div>
</section>

<ng-template #loadingTpl>
  <div class="loading text-muted">Loading study data...</div>
</ng-template>
