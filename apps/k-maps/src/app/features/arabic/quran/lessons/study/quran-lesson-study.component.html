<section
  class="quran-edit-new quran-study-shell"
  *ngIf="ready; else loadingTpl"
  [style.--app-ar-font-size]="arabicFontSize"
  [class.quran-study-shell--dialog-open]="morphologyDialogWord !== null"
>
  <header class="edit-hero">
    <div>
      <p class="hero-kicker">Qur'anic Lesson Study</p>
      <h1>{{ lessonTitle }}</h1>
      <p class="hero-intent">Read-only walkthrough of all lesson tasks and concepts.</p>
    </div>
    <div class="hero-actions">
      <app-font-size-controls
        ariaLabel="Arabic font controls"
        decreaseLabel="Decrease Arabic font"
        resetLabel="Reset Arabic font"
        increaseLabel="Increase Arabic font"
        (decrease)="decreaseFont()"
        (reset)="resetFont()"
        (increase)="increaseFont()"
      ></app-font-size-controls>
      <span class="lock-pill lock-pill--on">Study Mode</span>
    </div>
  </header>

  <div class="edit-grid">
    <main class="edit-panel">
      <div class="panel-head">
        <div>
          <h2>{{ studyActiveTaskTab === 'lesson' ? 'Lesson Overview' : (activeTaskTab?.label || 'Task') }}</h2>
          <p>{{ lessonSubtitle }}</p>
        </div>
        <div class="panel-actions">
          <span class="panel-chip panel-chip--locked">Read Only</span>
          <span class="panel-chip">{{ state.taskTabs.length }} Tasks</span>
        </div>
      </div>

      <div class="panel-body">
        <ng-container *ngIf="studyActiveTaskTab === 'lesson'; else taskPane">
          <div class="task-editor">
            <div class="task-meta">
              <span>Lesson overview</span>
              <span>Surah {{ state.selectedSurah || '--' }} Ayah {{ rangeLabelShort }}</span>
            </div>

            <div class="lesson-grid">
              <article class="lesson-card">
                <h4>{{ lessonHeading }}</h4>
                <p class="note-muted">{{ lessonDetail }}</p>
                <div class="field-row">
                  <div class="rule-card">
                    <strong>Episode Intro</strong>
                    <span>{{ episodeIntro }}</span>
                  </div>
                  <div class="rule-card">
                    <strong>Scene</strong>
                    <span>{{ sceneDetail }}</span>
                  </div>
                  <div class="rule-card">
                    <strong>Aesthetic</strong>
                    <span>{{ sceneAesthetic }}</span>
                  </div>
                </div>
              </article>
            </div>
          </div>
        </ng-container>

        <ng-template #taskPane>
          <div class="task-editor" *ngIf="activeTaskTab as tab">
            <div class="task-meta">
              <span>Linked unit: Surah {{ state.selectedSurah || '--' }} Ayah {{ rangeLabelShort }}</span>
              <span>Study mode: {{ tab.label }}</span>
            </div>

            <ng-container [ngSwitch]="tab.type">
              <div class="reading-layout" *ngSwitchCase="'reading'">
                <article class="reading-summary-card">
                  <span class="reading-kicker">Reading Text</span>
                  <p
                    class="reading-text-primary text-arabic"
                    *ngIf="readingAyahWordGroups.length; else noReadingText"
                    dir="rtl"
                    translate="no"
                  >
                    <ng-container *ngFor="let ayahGroup of readingAyahWordGroups; let isLastAyah = last">
                      <ng-container *ngFor="let token of ayahGroup.words; let isLastWord = last">
                        <span class="quran-word">
                          {{ token.text }}
                        </span>
                        <span *ngIf="!isLastWord"> </span>
                      </ng-container>
                      <span class="reading-ayah-mark" aria-hidden="true">{{ toArabicIndicDigits(ayahGroup.ayah) }}</span>
                      <span *ngIf="!isLastAyah"> </span>
                    </ng-container>
                  </p>
                  <ng-template #noReadingText>
                    <p class="text-muted">No reading text available.</p>
                  </ng-template>
                </article>
              </div>

              <div class="morphology-layout" *ngSwitchCase="'morphology'">
                <app-targeted-notes-panel
                  *ngIf="taskTarget('morphology') as target"
                  class="study-targeted-notes"
                  [target]="target"
                ></app-targeted-notes-panel>

                <div class="morphology-grid">
                  <article class="morph-bucket morph-bucket--noun">
                    <div class="morph-bucket-head">
                      <h4>Nouns</h4>
                      <span class="morph-count">{{ nounMorphologyItems.length }}</span>
                    </div>

                    <app-pills
                      *ngIf="nounMorphologyPills.length; else noMorphNouns"
                      [items]="nounMorphologyPills"
                      [clickable]="true"
                      ariaLabel="Noun word and root pills"
                      (itemSelect)="onMorphologyPillSelect($event)"
                    ></app-pills>
                    <ng-template #noMorphNouns>
                      <p class="text-muted">No noun entries available.</p>
                    </ng-template>
                  </article>

                  <article class="morph-bucket morph-bucket--verb">
                    <div class="morph-bucket-head">
                      <h4>Verbs</h4>
                      <span class="morph-count">{{ verbMorphologyItems.length }}</span>
                    </div>

                    <app-pills
                      *ngIf="verbMorphologyPills.length; else noMorphVerbs"
                      [items]="verbMorphologyPills"
                      [clickable]="true"
                      ariaLabel="Verb word and root pills"
                      (itemSelect)="onMorphologyPillSelect($event)"
                    ></app-pills>
                    <ng-template #noMorphVerbs>
                      <p class="text-muted">No verb entries available.</p>
                    </ng-template>
                  </article>
                </div>

                <div
                  class="study-word-dialog-backdrop"
                  *ngIf="morphologyDialogWord as dialogWord"
                  (click)="closeMorphologyWordDialog()"
                >
                  <div
                    class="study-word-dialog"
                    role="dialog"
                    aria-modal="true"
                    aria-label="Word details"
                    (click)="$event.stopPropagation()"
                  >
                    <header class="study-word-dialog-head">
                      <div>
                        <h3 class="study-word-dialog-title">
                          {{ morphologyDialogSurahName ? 'Surah ' + morphologyDialogSurahName : 'Word Study' }}
                        </h3>
                      </div>
                      <div class="study-word-dialog-controls">
                        <div class="study-word-dialog-mode-toggle">
                          <button
                            type="button"
                            class="study-word-dialog-toggle-btn"
                            [class.study-word-dialog-toggle-btn--active]="dialogViewMode === 'context'"
                            (click)="setDialogViewMode('context')"
                          >
                            Context
                          </button>
                          <button
                            type="button"
                            class="study-word-dialog-toggle-btn"
                            [class.study-word-dialog-toggle-btn--active]="dialogViewMode === 'analysis'"
                            (click)="setDialogViewMode('analysis')"
                          >
                            Analysis
                          </button>
                        </div>
                        <button type="button" class="study-word-dialog-toggle-btn study-word-dialog-toggle-btn--wide" (click)="toggleDialogTranslation()">
                          {{ showDialogTranslation ? 'Hide Translation' : 'Show Translation' }}
                        </button>
                        <span class="study-word-dialog-ref">{{ morphologyDialogReference }}</span>
                        <button
                          type="button"
                          class="study-word-dialog-toggle-btn study-word-dialog-toggle-btn--wide"
                          [disabled]="!morphologyWordTarget"
                          (click)="toggleMorphologyWordNotes()"
                        >
                          {{ showMorphologyWordNotes ? 'Hide Word Notes' : 'Word Notes' }}
                        </button>
                        <button
                          type="button"
                          class="study-word-dialog-close-top"
                          aria-label="Close word details"
                          (click)="closeMorphologyWordDialog()"
                        >
                          ×
                        </button>
                      </div>
                    </header>

                    <div class="study-word-note-popover" *ngIf="showMorphologyWordNotes && morphologyWordTarget as target">
                      <app-targeted-notes-panel [target]="target"></app-targeted-notes-panel>
                    </div>

                    <div class="study-word-dialog-layout" [class.study-word-dialog-layout--analysis]="dialogViewMode === 'analysis'">
                      <section class="study-word-context">
                        <p class="study-word-context-bar" *ngIf="morphologyDialogContextBar">{{ morphologyDialogContextBar }}</p>
                        <div class="study-word-context-head">
                          <p>Context Verses</p>
                          <span>{{ morphologyDialogContextAyahs.length }} ayah{{ morphologyDialogContextAyahs.length === 1 ? '' : 's' }}</span>
                        </div>

                        <div class="study-word-context-list" *ngIf="morphologyDialogContextAyahs.length; else noDialogContext">
                          <article
                            class="study-word-context-ayah"
                            *ngFor="let ayah of morphologyDialogContextAyahs"
                            [class.study-word-context-ayah--focus]="ayah.isFocus"
                          >
                            <div class="study-word-context-ayah-head">
                              <span class="study-word-context-ayah-badge">{{ toArabicIndicDigits(ayah.ayah) }}</span>
                              <span>Ayah {{ ayah.ayah }}</span>
                            </div>
                            <p class="study-word-context-ar text-arabic" dir="rtl" translate="no">
                              <ng-container *ngFor="let token of ayah.words; let tokenIndex = index; let isLastToken = last">
                                <span
                                  class="study-word-context-token"
                                  [class.study-word-context-token--active]="isDialogTokenSelected(ayah.surah, ayah.ayah, tokenIndex + 1)"
                                  [attr.data-pos]="dialogTokenPos(ayah.surah, ayah.ayah, tokenIndex + 1) || null"
                                  [attr.title]="dialogTokenHint(ayah.surah, ayah.ayah, tokenIndex + 1, token)"
                                >
                                  {{ token }}
                                </span>
                                <span *ngIf="!isLastToken"> </span>
                              </ng-container>
                            </p>
                            <p class="study-word-context-translation" *ngIf="showDialogTranslation && ayah.translation">{{ ayah.translation }}</p>
                          </article>
                        </div>
                        <ng-template #noDialogContext>
                          <p class="study-word-context-empty">No verse context available for this word.</p>
                        </ng-template>
                      </section>

                      <app-quran-word-inspector
                        class="study-word-inspector-panel"
                        [selection]="dialogWord"
                        [surahLabel]="morphologyDialogSurahName"
                        [appearance]="'panel'"
                        [morphologyItems]="morphologyItems"
                        [lexiconMorphologyItems]="lexiconMorphologyItems"
                        [evidenceItems]="morphologyEvidenceItems"
                        (close)="closeMorphologyWordDialog()"
                      ></app-quran-word-inspector>
                    </div>

                    <div class="study-word-dialog-actions">
                      <button type="button" class="btn btn-ghost btn-sm" (click)="closeMorphologyWordDialog()">Close</button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="sentence-layout" *ngSwitchCase="'sentence_structure'">
                <app-targeted-notes-panel
                  *ngIf="taskTarget('sentence_structure') as target"
                  class="study-targeted-notes"
                  [target]="target"
                ></app-targeted-notes-panel>

                <app-tabs
                  class="sentence-tabs"
                  [tabs]="sentenceTabs"
                  [activeId]="state.sentenceSubTab"
                  variant="tabs"
                  orientation="horizontal"
                  ariaLabel="Sentence structure tabs"
                  [primaryIds]="sentencePrimaryIds"
                  overflowLabel="More"
                  (tabChange)="onSentenceTabChange($event)"
                ></app-tabs>

                <div class="sentence-pane">
                  <ng-container *ngIf="state.sentenceSubTab === 'verses'">
                    <div class="unit-preview" *ngIf="sentenceAyahsForStudy.length; else noSentenceVerses">
                      <article class="unit-ayah" *ngFor="let ayah of sentenceAyahsForStudy">
                        <span class="unit-ayah-index">Ayah {{ ayah.ayah }}</span>
                        <p class="unit-ayah-text">{{ ayah.text_uthmani || ayah.text || '—' }}</p>
                      </article>
                    </div>
                    <ng-template #noSentenceVerses>
                      <p class="text-muted">No verse preview available.</p>
                    </ng-template>
                  </ng-container>

                  <ng-container *ngIf="state.sentenceSubTab === 'items'">
                    <app-quran-sentence-structure [sentences]="sentenceStructureSentences"></app-quran-sentence-structure>

                    <section class="sentence-item-notes" *ngIf="sentenceStructureSentences.length">
                      <article class="sentence-item-note-row" *ngFor="let sentence of sentenceStructureSentences">
                        <button
                          type="button"
                          class="sentence-item-note-btn"
                          (click)="toggleSentenceItemNotes(sentence)"
                        >
                          {{ activeSentenceNoteKey === ('sent_' + sentence.sentence_order) ? 'Hide' : 'Notes' }}
                          Sentence #{{ sentence.sentence_order }}
                        </button>

                        <app-targeted-notes-panel
                          *ngIf="activeSentenceNoteKey === ('sent_' + sentence.sentence_order) && activeSentenceNoteTarget"
                          class="study-targeted-notes study-targeted-notes--inline"
                          [target]="activeSentenceNoteTarget!"
                        ></app-targeted-notes-panel>
                      </article>
                    </section>
                  </ng-container>

                  <ng-container *ngIf="state.sentenceSubTab === 'json'">
                    <pre class="study-json">{{ sentenceTaskJson }}</pre>
                  </ng-container>
                </div>
              </div>

              <div class="study-comprehension-layout" *ngSwitchCase="'comprehension'">
                <header class="study-task-head">
                  <div class="study-task-head-copy">
                    <p class="study-task-kicker">Comprehension Matrix</p>
                    <h3>Structured Question Bank</h3>
                    <p>{{ comprehensionQuestionTotal }} prompts across {{ comprehensionQuestionGroups.length }} categories.</p>
                  </div>
                  <span class="study-task-ref">{{ passageReferenceBadge }}</span>
                </header>

                <app-targeted-notes-panel
                  *ngIf="taskTarget('comprehension') as target"
                  class="study-targeted-notes"
                  [target]="target"
                ></app-targeted-notes-panel>

                <section class="study-question-grid" *ngIf="comprehensionQuestionGroups.length; else noComprehensionPrompts">
                  <article
                    class="study-question-card"
                    *ngFor="let group of comprehensionQuestionGroups; let groupIndex = index"
                    [attr.data-accent]="group.accent"
                    [style.--group-index]="groupIndex"
                  >
                    <header class="study-question-card-head">
                      <h4>{{ group.title }}</h4>
                      <span class="study-question-count">{{ group.questions.length }}</span>
                    </header>

                    <ol class="study-question-list">
                      <ng-container *ngFor="let question of group.questions; let questionIndex = index">
                        <li class="study-question-item">
                          <span class="study-question-index">{{ questionIndex + 1 }}</span>
                          <p>{{ question }}</p>
                          <button
                            type="button"
                            class="study-question-note-btn"
                            (click)="toggleComprehensionItemNotes(groupIndex, questionIndex)"
                          >
                            Notes
                          </button>
                        </li>

                        <li
                          class="study-question-notes-wrap"
                          *ngIf="activeComprehensionNoteKey === comprehensionQuestionKey(groupIndex, questionIndex) && activeComprehensionNoteTarget"
                        >
                          <app-targeted-notes-panel
                            class="study-targeted-notes study-targeted-notes--inline"
                            [target]="activeComprehensionNoteTarget!"
                          ></app-targeted-notes-panel>
                        </li>
                      </ng-container>
                    </ol>
                  </article>
                </section>

                <ng-template #noComprehensionPrompts>
                  <p class="text-muted">No comprehension prompts available.</p>
                </ng-template>
              </div>

              <div class="study-expressions-layout" *ngSwitchCase="'expressions'">
                <header class="study-task-head">
                  <div class="study-task-head-copy">
                    <p class="study-task-kicker">Expressions Desk</p>
                    <h3>Scholarly Expression Set</h3>
                    <p>{{ expressionStudyCards.length }} expression entries with lexical and source metadata.</p>
                  </div>
                  <span class="study-task-ref">{{ passageReferenceBadge }}</span>
                </header>

                <section class="study-expression-grid" *ngIf="expressionStudyCards.length; else noExpressions">
                  <article
                    class="study-expression-card"
                    *ngFor="let expression of expressionStudyCards; let expressionIndex = index"
                    [attr.data-accent]="expression.accent"
                    [style.--expr-index]="expressionIndex"
                  >
                    <header class="study-expression-head">
                      <div class="study-expression-heading">
                        <h4>{{ expression.label }}</h4>
                        <p class="study-expression-ref">{{ expression.reference }}</p>
                      </div>
                      <span class="study-expression-status" *ngIf="expression.status">{{ expression.status }}</span>
                    </header>

                    <p class="study-expression-ar text-arabic" dir="rtl" translate="no" *ngIf="expression.textAr">
                      {{ expression.textAr }}
                    </p>
                    <p class="study-expression-canonical" *ngIf="expression.canonical">{{ expression.canonical }}</p>

                    <div class="study-expression-meta">
                      <span *ngIf="expression.category">{{ expression.category }}</span>
                      <span *ngIf="expression.lemma">Lemma: {{ expression.lemma }}</span>
                    </div>

                    <div class="study-expression-sequence" *ngIf="expression.sequence.length">
                      <span class="study-expression-token" *ngFor="let token of expression.sequence">
                        <strong>{{ token.text }}</strong>
                        <small *ngIf="token.type">{{ token.type }}</small>
                      </span>
                    </div>

                    <ul class="study-expression-sources" *ngIf="expression.sources.length">
                      <li *ngFor="let source of expression.sources">
                        <span>{{ source.author }}</span>
                        <em>{{ source.work }}</em>
                      </li>
                    </ul>
                  </article>
                </section>

                <ng-template #noExpressions>
                  <p class="text-muted">No expressions metadata available.</p>
                </ng-template>
              </div>

              <div class="passage-structure-layout" *ngSwitchCase="'passage_structure'">
                <header class="kmap-passage-header">
                  <div class="kmap-passage-header-copy">
                    <p class="kmap-passage-kicker">Passage Analysis</p>
                    <h3>{{ passageHeaderTitle }}</h3>
                    <p>{{ passageHeaderSubtitle }}</p>
                  </div>
                  <div class="kmap-passage-header-actions">
                    <span class="kmap-reference-badge">{{ passageReferenceBadge }}</span>
                    <button type="button" class="kmap-control-btn" [disabled]="!hasCollapsedPassageSections" (click)="expandAllPassageSections()">
                      Expand all
                    </button>
                    <button type="button" class="kmap-control-btn" [disabled]="areAllPassageSectionsCollapsed" (click)="collapseAllPassageSections()">
                      Collapse all
                    </button>
                  </div>
                </header>

                <app-targeted-notes-panel
                  *ngIf="taskTarget('passage_structure') as target"
                  class="study-targeted-notes"
                  [target]="target"
                ></app-targeted-notes-panel>

                <nav class="kmap-mini-nav" *ngIf="passageStructureSections.length > 1" aria-label="Passage section navigation">
                  <button
                    type="button"
                    class="kmap-mini-nav-btn"
                    *ngFor="let section of passageStructureSections"
                    [attr.data-accent]="section.accent"
                    (click)="scrollToPassageSection(section.id)"
                  >
                    {{ section.badge || section.title }}
                  </button>
                </nav>

                <section class="kmap-analysis-grid" aria-label="Structured passage analysis">
                  <article
                    class="kmap-analysis-card"
                    *ngFor="let section of passageStructureSections; let sectionIndex = index"
                    [attr.id]="passageSectionDomId(section.id)"
                    [attr.data-accent]="section.accent"
                    [class.kmap-analysis-card--collapsed]="isPassageSectionCollapsed(section.id)"
                    [class.kmap-analysis-card--providence]="section.key.includes('providence')"
                    [style.--card-index]="sectionIndex"
                  >
                    <button
                      type="button"
                      class="kmap-analysis-card-head"
                      [attr.aria-expanded]="!isPassageSectionCollapsed(section.id)"
                      [attr.aria-controls]="passageSectionDomId(section.id) + '-content'"
                      (click)="togglePassageSection(section.id)"
                    >
                      <span class="kmap-icon-circle" [attr.data-accent]="section.accent">
                        <svg cIcon [name]="section.iconName"></svg>
                      </span>
                      <span class="kmap-analysis-head-copy">
                        <span class="kmap-analysis-title">{{ section.title }}</span>
                        <span class="kmap-analysis-badge">{{ section.badge }}</span>
                      </span>
                      <span class="kmap-analysis-toggle" aria-hidden="true">{{ isPassageSectionCollapsed(section.id) ? '+' : '-' }}</span>
                    </button>

                    <div
                      class="kmap-analysis-card-content-wrap"
                      [attr.id]="passageSectionDomId(section.id) + '-content'"
                      [class.is-collapsed]="isPassageSectionCollapsed(section.id)"
                    >
                      <div class="kmap-analysis-card-content">
                        <p class="kmap-analysis-summary" *ngIf="section.summary">
                          <ng-container *ngFor="let segment of toPassageTextSegments(section.summary)">
                            <span [class.kmap-arabic-run]="segment.isArabic">{{ segment.text }}</span>
                          </ng-container>
                        </p>

                        <ng-container [ngSwitch]="section.renderer">
                          <div class="kmap-keyvalue-renderer" *ngSwitchCase="'keyvalue'">
                            <article class="kmap-kv-row" *ngFor="let row of section.keyValueRows">
                              <p class="kmap-kv-key">{{ row.key }}</p>
                              <div class="kmap-kv-value">
                                <p class="kmap-kv-text" *ngIf="row.text">
                                  <ng-container *ngFor="let segment of toPassageTextSegments(row.text)">
                                    <span [class.kmap-arabic-run]="segment.isArabic">{{ segment.text }}</span>
                                  </ng-container>
                                </p>
                                <div class="kmap-chip-list" *ngIf="row.chips.length">
                                  <span class="kmap-chip" *ngFor="let chip of row.chips">
                                    <ng-container *ngFor="let segment of toPassageTextSegments(chip)">
                                      <span [class.kmap-arabic-run]="segment.isArabic">{{ segment.text }}</span>
                                    </ng-container>
                                  </span>
                                </div>
                              </div>
                            </article>
                            <p class="text-muted" *ngIf="!section.keyValueRows.length">No structured values available.</p>
                          </div>

                          <div class="kmap-clusters-renderer" *ngSwitchCase="'clusters'">
                            <article class="kmap-cluster" *ngFor="let cluster of section.clusters" [attr.data-accent]="cluster.accent">
                              <h4>{{ cluster.title }}</h4>
                              <div class="kmap-cluster-tags">
                                <span class="kmap-cluster-tag" *ngFor="let item of cluster.items" [attr.data-accent]="cluster.accent">
                                  <ng-container *ngFor="let segment of toPassageTextSegments(item)">
                                    <span [class.kmap-arabic-run]="segment.isArabic">{{ segment.text }}</span>
                                  </ng-container>
                                </span>
                              </div>
                            </article>
                            <p class="text-muted" *ngIf="!section.clusters.length">No lexical clusters available.</p>
                          </div>

                          <div class="kmap-chiasm-renderer" *ngSwitchCase="'chiasm'">
                            <ng-container *ngIf="section.chiasm as chiasm; else emptyChiasm">
                              <div class="kmap-chiasm-frame kmap-chiasm-frame--outer">
                                <ng-container *ngFor="let segment of toPassageTextSegments(chiasm.outerTop)">
                                  <span [class.kmap-arabic-run]="segment.isArabic">{{ segment.text }}</span>
                                </ng-container>
                              </div>
                              <div class="kmap-chiasm-track">
                                <div class="kmap-chiasm-node">
                                  <ng-container *ngFor="let segment of toPassageTextSegments(chiasm.innerLeft)">
                                    <span [class.kmap-arabic-run]="segment.isArabic">{{ segment.text }}</span>
                                  </ng-container>
                                </div>
                                <div class="kmap-chiasm-connector" aria-hidden="true"></div>
                                <div class="kmap-chiasm-node">
                                  <ng-container *ngFor="let segment of toPassageTextSegments(chiasm.innerRight)">
                                    <span [class.kmap-arabic-run]="segment.isArabic">{{ segment.text }}</span>
                                  </ng-container>
                                </div>
                              </div>
                              <div class="kmap-chiasm-axis">
                                <ng-container *ngFor="let segment of toPassageTextSegments(chiasm.axis)">
                                  <span [class.kmap-arabic-run]="segment.isArabic">{{ segment.text }}</span>
                                </ng-container>
                              </div>
                              <div class="kmap-chiasm-frame kmap-chiasm-frame--outer">
                                <ng-container *ngFor="let segment of toPassageTextSegments(chiasm.outerBottom)">
                                  <span [class.kmap-arabic-run]="segment.isArabic">{{ segment.text }}</span>
                                </ng-container>
                              </div>
                              <p class="kmap-chiasm-interpretation" *ngIf="chiasm.interpretation">
                                <ng-container *ngFor="let segment of toPassageTextSegments(chiasm.interpretation)">
                                  <span [class.kmap-arabic-run]="segment.isArabic">{{ segment.text }}</span>
                                </ng-container>
                              </p>
                            </ng-container>
                            <ng-template #emptyChiasm>
                              <p class="text-muted">No chiastic pattern found.</p>
                            </ng-template>
                          </div>

                          <div class="kmap-timeline-renderer" *ngSwitchCase="'timeline'">
                            <ol class="kmap-timeline" *ngIf="section.timeline.length; else emptyTimeline">
                              <li class="kmap-timeline-step" *ngFor="let step of section.timeline; let stepIndex = index" [style.--step-index]="stepIndex">
                                <span class="kmap-timeline-bullet" aria-hidden="true"></span>
                                <div class="kmap-timeline-copy">
                                  <h4>
                                    <ng-container *ngFor="let segment of toPassageTextSegments(step.title)">
                                      <span [class.kmap-arabic-run]="segment.isArabic">{{ segment.text }}</span>
                                    </ng-container>
                                  </h4>
                                  <p>
                                    <ng-container *ngFor="let segment of toPassageTextSegments(step.text)">
                                      <span [class.kmap-arabic-run]="segment.isArabic">{{ segment.text }}</span>
                                    </ng-container>
                                  </p>
                                </div>
                              </li>
                            </ol>
                            <ng-template #emptyTimeline>
                              <p class="text-muted">No timeline steps available.</p>
                            </ng-template>
                          </div>
                        </ng-container>
                      </div>
                    </div>
                  </article>
                </section>
              </div>

              <div *ngSwitchDefault>
                <pre class="study-json">{{ formatJson(tab.json) }}</pre>
              </div>
            </ng-container>
          </div>
        </ng-template>
      </div>
    </main>
  </div>
</section>

<ng-template #loadingTpl>
  <div class="loading text-muted">Loading study data...</div>
</ng-template>
