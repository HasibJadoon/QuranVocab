<section class="sentence-structure" *ngIf="hasSentences; else emptyTpl">
  <header class="sentence-toolbar">
    <button type="button" class="sentence-nav-btn" [disabled]="!canGoPrev" (click)="prevSentence()">Previous</button>
    <p class="sentence-toolbar-label">
      <span>Sentence #{{ currentSentence?.sentence_order }}</span>
      <span>{{ activeSentenceIndex + 1 }} / {{ sentences.length }}</span>
    </p>
    <button type="button" class="sentence-nav-btn" [disabled]="!canGoNext" (click)="nextSentence()">Next</button>
  </header>

  <div class="sentence-grid">
    <section class="sentence-stage">
      <p class="sentence-full-text text-arabic" *ngIf="currentSentence?.structure_summary?.full_text as fullText" dir="rtl" translate="no">
        {{ fullText }}
      </p>

      <div class="sentence-segments" #sentenceRegion>
        <ng-container *ngIf="currentSentenceSegments.length; else emptySegmentsTpl">
          <span
            *ngFor="let segment of currentSentenceSegments; let i = index; trackBy: trackBySegment"
            class="sentence-segment"
            [class.sentence-segment--active]="activeSegmentIndex === i"
            role="button"
            tabindex="0"
            [attr.aria-label]="'Select sentence segment ' + (segment.component || i + 1)"
            [attr.aria-pressed]="activeSegmentIndex === i"
            (click)="toggleSegment(i)"
            (keydown)="onSegmentKeydown($event, i)"
          >
            {{ segment.text || segment.component || '—' }}
          </span>
        </ng-container>
      </div>
      <p class="sentence-hint">Click a segment to inspect it. Click the same segment again to deselect.</p>
    </section>

    <aside class="segment-panel" *ngIf="activeSegment as segment; else panelHintTpl">
      <h3>{{ segment.component || 'Component' }}</h3>

      <div class="segment-detail">
        <span>Text</span>
        <p class="text-arabic" dir="rtl" translate="no">{{ segment.text || '—' }}</p>
      </div>

      <div class="segment-detail">
        <span>Pattern</span>
        <p>{{ segment.pattern || '—' }}</p>
      </div>

      <div class="segment-detail">
        <span>Role</span>
        <p>{{ segment.role || '—' }}</p>
      </div>

      <div class="segment-detail">
        <span>Grammar</span>
        <div class="grammar-chip-row" *ngIf="segment.grammar.length; else noGrammarTpl">
          <span class="grammar-chip" *ngFor="let item of segment.grammar; let i = index; trackBy: trackByGrammar">{{ item }}</span>
        </div>
      </div>
    </aside>
  </div>
</section>

<ng-template #panelHintTpl>
  <aside class="segment-panel segment-panel--empty">
    <p>Select a sentence segment to view its structure details.</p>
  </aside>
</ng-template>

<ng-template #noGrammarTpl>
  <p class="detail-fallback">No grammar tags</p>
</ng-template>

<ng-template #emptySegmentsTpl>
  <p class="detail-fallback">No main components defined for this sentence.</p>
</ng-template>

<ng-template #emptyTpl>
  <div class="sentence-empty">
    <p>No sentence structure items available.</p>
  </div>
</ng-template>
