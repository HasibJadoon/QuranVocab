<section *ngIf="lesson; else loadingTpl" class="lesson-editor">
  <header class="lesson-editor-header">
    <div>
      <p class="lesson-editor-subtitle">
        {{ lesson.reference?.ref_label || 'Quran Lesson' }}
      </p>
      <h1>Arabic Lesson Editor</h1>
    </div>
    <div class="lesson-editor-actions">
      <button type="button" class="btn btn-ghost" (click)="back()">Back</button>
      <button type="button" class="btn btn-primary" (click)="save()">Save</button>
    </div>
  </header>

  <div class="editor-meta-panel glow-card">
    <div class="meta-row">
      <label>Title</label>
      <input
        class="meta-input"
        [(ngModel)]="lesson.title"
        name="lessonTitle"
        placeholder="Lesson title"
      />
    </div>
    <div class="meta-grid">
      <div class="meta-row">
        <label>Type</label>
        <input class="meta-input" [value]="lesson.lesson_type" disabled />
      </div>
      <div class="meta-row">
        <label>Status</label>
        <input
          class="meta-input"
          [(ngModel)]="lesson.status"
          name="lessonStatus"
          placeholder="draft"
        />
      </div>
      <div class="meta-row">
        <label>Subtype</label>
        <input
          class="meta-input"
          [(ngModel)]="referenceLabel"
          name="lessonSubtype"
          placeholder="narrative"
        />
      </div>
      <div class="meta-row">
        <label>Source</label>
        <input
          class="arabic-input"
          [(ngModel)]="referenceLabel"
          name="lessonSource"
          placeholder="Surah Yusuf 12:19–29"
        />
      </div>
    </div>
  </div>

  <div class="lesson-editor-tabs">
    <button
      type="button"
      class="tab-btn"
      [class.active]="activeTab === 'arabic'"
      (click)="activeTab = 'arabic'"
    >
      Arabic Text
    </button>
    <button
      type="button"
      class="tab-btn"
      [class.active]="activeTab === 'sentences'"
      (click)="activeTab = 'sentences'"
    >
      Sentences
    </button>
    <button
      type="button"
      class="tab-btn"
      [class.active]="activeTab === 'mcq'"
      (click)="activeTab = 'mcq'"
    >
      MCQs
    </button>
    <button
      type="button"
      class="tab-btn"
      [class.active]="activeTab === 'comprehension'"
      (click)="activeTab = 'comprehension'"
    >
      Comprehension
    </button>
    <button
      type="button"
      class="tab-btn"
      [class.active]="activeTab === 'json'"
      (click)="activeTab = 'json'"
    >
      JSON
    </button>
  </div>

  <div class="lesson-editor-tabs-panel">
    <ng-container [ngSwitch]="activeTab">
      <article *ngSwitchCase="'arabic'" class="study-card">
        <div class="study-card-heading">
          <h4>Arabic Text (editable)</h4>
          <h4 class="study-card-mode">{{ safeArabicVerses.length }} verses</h4>
        </div>
        <hr class="study-card-divider" />
        <div *ngIf="safeArabicVerses.length; else noArabic">
          <div
            class="arabic-text-row"
            *ngFor="let verse of safeArabicVerses; let index = index"
          >
            <label class="json-label">Verse {{ index + 1 }}</label>
            <textarea
              class="editable-field  arabic-text"
              rows="2"
              [(ngModel)]="verse.arabic"
              (ngModelChange)="onLessonEdited()"
            ></textarea>
          </div>
        </div>
        <ng-template #noArabic>
          <p class="text-muted">Arabic text is not available yet.</p>
        </ng-template>
      </article>

      <article *ngSwitchCase="'sentences'" class="study-card">
        <div class="study-card-heading">
          <h4>Sentences (editable)</h4>
          <h4 class="study-card-mode">{{ safeSentences.length }} segments</h4>
        </div>
        <hr class="study-card-divider" />
        <div *ngIf="safeSentences.length; else noSentences">
          <div class="arabic-text-row" *ngFor="let sentence of safeSentences; let index = index">
            <label class="json-label">Sentence {{ index + 1 }}</label>
            <textarea
              class="editable-field  arabic-text"
              rows="2"
              [(ngModel)]="sentence.arabic"
              (ngModelChange)="onLessonEdited()"
            ></textarea>
            <textarea
              class="editable-field"
              rows="2"
              [(ngModel)]="sentence.translation"
              (ngModelChange)="onLessonEdited()"
              placeholder="Translation"
            ></textarea>
          </div>
        </div>
        <ng-template #noSentences>
          <p class="text-muted">Sentence segmentation is not available yet.</p>
        </ng-template>
        <div class="lesson-editor-section mt-3">
          <h5>Authoring helpers</h5>
          <div class="grid-gap">
            <div class="block">
              <label>Surah</label>
              <input type="number" [(ngModel)]="containerForm.surah" />
            </div>
            <div class="block">
              <label>Ayah from</label>
              <input type="number" [(ngModel)]="containerForm.ayahFrom" />
            </div>
            <div class="block">
              <label>Ayah to</label>
              <input type="number" [(ngModel)]="containerForm.ayahTo" />
            </div>
          </div>
          <div class="grid-gap mt-2">
            <div class="block">
              <label>Container ID</label>
              <input [(ngModel)]="containerForm.containerId" placeholder="C:QURAN:12" />
            </div>
            <div class="block">
              <label>Passage Unit ID</label>
              <input [(ngModel)]="containerForm.unitId" placeholder="U:C:QURAN:12:1-7" />
            </div>
          </div>
          <button class="btn btn-outline" type="button" (click)="createContainer()">
            Create container + units
          </button>
        </div>
        <div class="lesson-editor-section mt-3">
          <h5>New sentence</h5>
          <textarea
            [(ngModel)]="sentenceForm.text"
            placeholder="Sentence Arabic text"
            rows="2"
          ></textarea>
          <textarea
            [(ngModel)]="sentenceForm.translation"
            placeholder="Translation (optional)"
            rows="2"
          ></textarea>
          <input
            [(ngModel)]="sentenceForm.tokens"
            placeholder="Tokens (format: surface|lexiconId, ...)"
          />
          <input
            [(ngModel)]="sentenceForm.spans"
            placeholder="Spans (text|start-end; ...)"
          />
          <input
            [(ngModel)]="sentenceForm.grammarIds"
            placeholder="Grammar IDs (comma separated)"
          />
          <button class="btn btn-primary" type="button" (click)="submitOccurrence()">
            Save occurrence
          </button>
          <p class="text-muted" *ngIf="occurrenceFeedback">{{ occurrenceFeedback }}</p>
        </div>
      </article>

      <article *ngSwitchCase="'mcq'" class="study-card study-card--mcq">
        <div class="study-card-heading">
          <h4>Comprehension MCQs (editable)</h4>
          <h4 class="study-card-mode">{{ safeMcqQuestions.length }} questions</h4>
        </div>
        <hr class="study-card-divider" />
        <div *ngIf="safeMcqQuestions.length; else noMcqs">
          <section class="mcq-question-card" *ngFor="let mcq of safeMcqQuestions; let qIndex = index">
            <label class="json-label">Question {{ qIndex + 1 }}</label>
            <textarea
              class="editable-field"
              rows="2"
              [(ngModel)]="mcq.question"
              (ngModelChange)="onLessonEdited()"
            ></textarea>
            <div class="mcq-options">
              <div
                class="mcq-option"
                *ngFor="let option of mcq.options; let optionIndex = index"
              >
                <input
                  type="checkbox"
                  [(ngModel)]="option.is_correct"
                  (ngModelChange)="onLessonEdited()"
                  class="me-2"
                />
                <textarea
                  class="editable-field"
                  rows="1"
                  [(ngModel)]="option.option"
                  (ngModelChange)="onLessonEdited()"
                ></textarea>
              </div>
            </div>
          </section>
        </div>
        <ng-template #noMcqs>
          <p class="text-muted">Comprehension MCQs are not available for this lesson yet.</p>
        </ng-template>
      </article>

      <article *ngSwitchCase="'comprehension'" class="study-card comprehension-card">
        <div class="study-card-heading">
          <h4>Comprehension questions (editable)</h4>
          <h4 class="study-card-mode">
            {{ reflectiveQuestions.length + analyticalQuestions.length }} questions
          </h4>
        </div>
        <hr class="study-card-divider" />
        <ng-container *ngIf="reflectiveQuestions.length">
          <div class="comp-section-heading">
            <span>Reflective</span>
            <small>Spend time thinking through the passage.</small>
          </div>
          <article class="comp-item" *ngFor="let question of reflectiveQuestions">
            <textarea
              class="editable-field"
              rows="2"
              [(ngModel)]="question.question"
              (ngModelChange)="onLessonEdited()"
            ></textarea>
            <textarea
              class="editable-field"
              rows="1"
              [(ngModel)]="question.answer_hint"
              (ngModelChange)="onLessonEdited()"
              placeholder="Hint (optional)"
            ></textarea>
          </article>
        </ng-container>
        <ng-container *ngIf="analyticalQuestions.length">
          <div class="comp-section-heading">
            <span>Analytical</span>
            <small>Trace how the story is constructed.</small>
          </div>
          <article class="comp-item" *ngFor="let question of analyticalQuestions">
            <textarea
              class="editable-field"
              rows="2"
              [(ngModel)]="question.question"
              (ngModelChange)="onLessonEdited()"
            ></textarea>
            <textarea
              class="editable-field"
              rows="1"
              [(ngModel)]="question.answer_hint"
              (ngModelChange)="onLessonEdited()"
              placeholder="Hint (optional)"
            ></textarea>
          </article>
        </ng-container>
      </article>

      <article *ngSwitchCase="'json'" class="study-card">
        <div class="study-card-heading">
          <h4>Lesson JSON</h4>
          <h4 class="study-card-mode">Editable JSON</h4>
        </div>
        <hr class="study-card-divider" />
        <label class="json-label">Entire lesson JSON</label>
        <textarea
          class="json-editor"
          [(ngModel)]="lessonJson"
          name="lessonJsonEditor"
          rows="24"
        ></textarea>
      </article>
    </ng-container>
  </div>
</section>

<ng-template #loadingTpl>
  <div class="loading text-muted">Loading lesson…</div>
</ng-template>
