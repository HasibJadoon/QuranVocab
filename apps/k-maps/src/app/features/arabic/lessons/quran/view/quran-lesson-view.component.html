<section class="quran-lesson-view" *ngIf="lesson as lessonData; else loadingTpl">
  <app-quran-lesson-toolbar />

  <header class="view-hero">
    <div>
      <h1 class="view-title">{{ lessonData.title }}</h1>
      <p class="view-subtitle" *ngIf="lessonData.title_ar">{{ lessonData.title_ar }}</p>
      <p class="view-ref" *ngIf="lessonData.reference?.ref_label">{{ lessonData.reference?.ref_label }}</p>
    </div>
    <div class="hero-chip-grid">
      <span class="hero-chip">{{ lessonData.status ?? 'draft' }}</span>
      <span class="hero-chip">Ref {{ referenceRangeLabel }}</span>
      <span class="hero-chip">Mode {{ modeLabel }}</span>
      <span class="hero-chip">Ayat {{ ayahCount }}</span>
      <span class="hero-chip">Sentences {{ sentenceCount }}</span>
      <span class="hero-chip">Tokens {{ lessonTokens.length }}</span>
    </div>
  </header>

  <div class="overview-grid">
    <article class="panel">
      <h2 class="panel-title">Lesson Metadata</h2>
      <dl class="meta-grid">
        <div>
          <dt>Lesson ID</dt>
          <dd>{{ lessonData.id }}</dd>
        </div>
        <div>
          <dt>Type</dt>
          <dd>{{ lessonData.lesson_type }}</dd>
        </div>
        <div>
          <dt>Subtype</dt>
          <dd>{{ lessonData.subtype ?? '—' }}</dd>
        </div>
        <div>
          <dt>Difficulty</dt>
          <dd>{{ lessonData.difficulty ?? '—' }}</dd>
        </div>
        <div>
          <dt>Source</dt>
          <dd>{{ sourceLabel }}</dd>
        </div>
        <div>
          <dt>Units</dt>
          <dd>{{ unitCount }}</dd>
        </div>
        <div>
          <dt>Created</dt>
          <dd>{{ lessonData.created_at ? (lessonData.created_at | date:'medium') : '—' }}</dd>
        </div>
        <div>
          <dt>Updated</dt>
          <dd>{{ lessonData.updated_at ? (lessonData.updated_at | date:'medium') : '—' }}</dd>
        </div>
      </dl>
    </article>

    <article class="panel" *ngIf="lessonData.units?.length">
      <h2 class="panel-title">Container Units</h2>
      <div class="table-wrap">
        <table class="mini-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Type</th>
              <th>Ayah Range</th>
              <th>Ref</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let unit of lessonData.units; let idx = index; trackBy: trackByUnit">
              <td>{{ idx + 1 }}</td>
              <td>{{ unit.unit_type ?? '—' }}</td>
              <td>{{ unit.ayah_from ?? '—' }} - {{ unit.ayah_to ?? '—' }}</td>
              <td>{{ unit.start_ref ?? unit.end_ref ?? '—' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </article>
  </div>

  <article class="panel">
    <h2 class="panel-title">
      {{ activeViewTab === 'translation' ? 'Translation View' : 'Arabic Text View' }}
    </h2>
    <div class="ayah-list" *ngIf="lessonData.text.arabic_full.length; else noAyatTpl">
      <article class="ayah-card" *ngFor="let ayah of lessonData.text.arabic_full; trackBy: trackByAyah">
        <div class="ayah-head">
          <span class="ayah-ref">{{ ayah.surah }}:{{ ayah.ayah }}</span>
          <span class="ayah-unit">Unit {{ ayah.unit_id }}</span>
          <span class="ayah-lemmas" *ngIf="ayah.lemmas?.length">{{ ayah.lemmas?.length }} lemmas</span>
        </div>
        <p class="ayah-ar" *ngIf="activeViewTab === 'arabic'">{{ ayah.arabic_diacritics ?? ayah.arabic }}</p>
        <p class="ayah-en" *ngIf="activeViewTab === 'translation'">
          {{ ayah.translation ?? 'No translation available' }}
        </p>
        <p class="ayah-note" *ngIf="ayah.notes">{{ ayah.notes }}</p>
      </article>
    </div>
  </article>

  <div class="overview-grid">
    <article class="panel" *ngIf="lessonData.sentences.length">
      <h2 class="panel-title">Sentence Layer</h2>
      <div class="sentence-list">
        <article class="sentence-card" *ngFor="let sentence of lessonData.sentences; trackBy: trackBySentence">
          <div class="sentence-head">
            <span>{{ sentence.unit_id }}</span>
            <span>#{{ sentence.sentence_order ?? '—' }}</span>
            <span *ngIf="sentence.roots?.length">Roots: {{ sentence.roots?.join(', ') }}</span>
          </div>
          <p class="sentence-ar" *ngIf="activeViewTab === 'arabic'">
            {{ sentence.arabic || sentence.text.arabic }}
          </p>
          <p class="sentence-en" *ngIf="activeViewTab === 'translation'">
            {{ sentence.translation || sentence.text.translation || '—' }}
          </p>
        </article>
      </div>
    </article>

    <article class="panel">
      <h2 class="panel-title">Analysis Snapshot</h2>
      <div class="metric-grid">
        <div class="metric">
          <span>Tokens</span>
          <strong>{{ lessonTokens.length }}</strong>
        </div>
        <div class="metric">
          <span>Spans</span>
          <strong>{{ lessonSpans.length }}</strong>
        </div>
        <div class="metric">
          <span>Verbs</span>
          <strong>{{ lessonVerbTokens.length }}</strong>
        </div>
        <div class="metric">
          <span>Nouns</span>
          <strong>{{ lessonNounTokens.length }}</strong>
        </div>
      </div>

      <div class="token-preview" *ngIf="tokenPreview.length">
        <h3>Token preview</h3>
        <div class="table-wrap">
          <table class="mini-table">
            <thead>
              <tr>
                <th>Surface</th>
                <th>Lemma</th>
                <th>POS</th>
                <th>Root ID</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let token of tokenPreview; trackBy: trackByToken">
                <td class="text-ar">{{ token.surface_ar }}</td>
                <td>{{ token.lemma_ar ?? '—' }}</td>
                <td>{{ token.pos ?? '—' }}</td>
                <td>{{ token.u_root_id ?? '—' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="tag-group" *ngIf="lessonSpanBuckets.length">
        <h3>Span buckets</h3>
        <span class="tag" *ngFor="let span of lessonSpanBuckets; trackBy: trackById">
          {{ span.kind || 'span' }} · {{ span.text || span.u_span_id }}
        </span>
      </div>
    </article>
  </div>

  <article class="panel" *ngIf="comprehensionReflective.length || comprehensionAnalytical.length || comprehensionMcqs.length">
    <h2 class="panel-title">Comprehension</h2>
    <div class="comprehension-grid">
      <section *ngIf="comprehensionReflective.length">
        <h3>Reflective</h3>
        <ol>
          <li *ngFor="let item of comprehensionReflective; trackBy: trackById">{{ item.question }}</li>
        </ol>
      </section>
      <section *ngIf="comprehensionAnalytical.length">
        <h3>Analytical</h3>
        <ol>
          <li *ngFor="let item of comprehensionAnalytical; trackBy: trackById">{{ item.question }}</li>
        </ol>
      </section>
      <section *ngIf="comprehensionMcqs.length">
        <h3>MCQs</h3>
        <ol>
          <li *ngFor="let item of comprehensionMcqs; trackBy: trackById">
            {{ item.question }}
          </li>
        </ol>
      </section>
    </div>
  </article>

  <article class="panel" *ngIf="hasExtendedBlocks">
    <h2 class="panel-title">Extended Data</h2>
    <details *ngIf="lessonData.vocab_layer">
      <summary>Vocabulary Layer</summary>
      <pre>{{ lessonData.vocab_layer | json }}</pre>
    </details>
    <details *ngIf="lessonData.passage_layers?.length">
      <summary>Passage Layers</summary>
      <pre>{{ lessonData.passage_layers | json }}</pre>
    </details>
    <details *ngIf="lessonData._notes">
      <summary>Lesson Notes</summary>
      <pre>{{ lessonData._notes | json }}</pre>
    </details>
  </article>
</section>

<ng-template #noAyatTpl>
  <div class="empty-text">No ayat are linked to this lesson yet.</div>
</ng-template>

<ng-template #loadingTpl>
  <div class="loading">Loading Quran lesson…</div>
</ng-template>
