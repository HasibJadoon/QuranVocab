<section class="lesson-builder lesson-builder--workflow">
  <app-lesson-builder-header
    [kicker]="'K-Maps · Literature Lesson Builder'"
    [title]="lesson.title"
    [intent]="activeTabIntent"
    [currentStep]="activeTabIndex + 1"
    [totalSteps]="tabs.length"
    [isSaving]="isSaving"
    [isNew]="isNewLesson"
    (back)="back()"
    (view)="openView()"
    (save)="save()"
  />

  <div class="builder-workspace">
    <aside class="builder-workflow-rail">
      <app-lesson-builder-tabs
        [tabs]="tabs"
        [activeTabId]="activeTabId"
        [lockedTabs]="{}"
        [statuses]="tabStatuses"
        [layout]="'rail'"
        (tabChange)="selectTab($event)"
      />
    </aside>

    <section class="builder-main">
      <p
        class="save-status"
        *ngIf="saveStatusMessage"
        [class.save-status--loading]="isSaving && saveStatusTone === 'info'"
        [class.save-status--success]="saveStatusTone === 'success'"
        [class.save-status--error]="saveStatusTone === 'error'"
      >
        {{ saveStatusMessage }}
      </p>

      <section class="builder-panel" [ngSwitch]="activeTabId">
        <ng-container *ngSwitchCase="'meta'">
          <div class="form-grid form-grid--meta">
            <label>
              <span>Title</span>
              <input type="text" [(ngModel)]="lesson.title" />
            </label>

            <label>
              <span>Arabic title</span>
              <input type="text" dir="rtl" class="text-arabic" [(ngModel)]="lesson.title_ar" />
            </label>

            <label>
              <span>Status</span>
              <input type="text" [(ngModel)]="lesson.status" />
            </label>

            <label>
              <span>Subtype</span>
              <input type="text" [(ngModel)]="lesson.subtype" />
            </label>

            <label>
              <span>Difficulty</span>
              <input type="number" min="1" [(ngModel)]="lesson.difficulty" />
            </label>

            <label>
              <span>Source</span>
              <input type="text" [(ngModel)]="lesson.source" />
            </label>

            <label>
              <span>Reference label</span>
              <input type="text" [(ngModel)]="lesson.reference!.ref_label" />
            </label>

            <label>
              <span>Citation</span>
              <input type="text" [(ngModel)]="lesson.reference!.citation" />
            </label>
          </div>
        </ng-container>

        <ng-container *ngSwitchCase="'container'">
          <div class="form-grid form-grid--selection">
            <label>
              <span>Container key</span>
              <input type="text" [(ngModel)]="containerForm.containerKey" />
            </label>

            <label>
              <span>Container title</span>
              <input type="text" [(ngModel)]="containerForm.title" />
            </label>
          </div>

          <div class="id-preview">
            <div>
              <p>Container ID</p>
              <code>{{ computedContainerId || '—' }}</code>
            </div>
            <div>
              <p>Primary unit ID</p>
              <code>{{ primaryUnitId || '—' }}</code>
            </div>
          </div>
        </ng-container>

        <ng-container *ngSwitchCase="'units'">
          <div class="row-actions">
            <button type="button" class="btn btn-primary" (click)="addUnit()">Add unit</button>
          </div>

          <div class="table-wrap" *ngIf="units.length; else emptyUnits">
            <table class="editor-table">
              <thead>
                <tr>
                  <th>Unit type</th>
                  <th>Unit ID</th>
                  <th>Order</th>
                  <th>Start ref</th>
                  <th>End ref</th>
                  <th>Text cache</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let unit of units; let i = index; trackBy: trackByUnit">
                  <td>
                    <input type="text" [(ngModel)]="unit.unit_type" />
                  </td>
                  <td>
                    <input type="text" [(ngModel)]="unit.id" placeholder="Auto" />
                  </td>
                  <td>
                    <input type="number" min="0" [(ngModel)]="unit.order_index" />
                  </td>
                  <td>
                    <input type="text" [(ngModel)]="unit.start_ref" />
                  </td>
                  <td>
                    <input type="text" [(ngModel)]="unit.end_ref" />
                  </td>
                  <td>
                    <input type="text" [(ngModel)]="unit.text_cache" />
                  </td>
                  <td>
                    <button type="button" class="btn btn-ghost" (click)="removeUnit(i)">Remove</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <ng-template #emptyUnits>
            <p class="empty-state">No units yet. Add a segment to begin.</p>
          </ng-template>
        </ng-container>
      </section>
    </section>
  </div>
</section>
