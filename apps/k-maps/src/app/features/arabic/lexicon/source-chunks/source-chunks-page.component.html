<section class="quran-edit-new source-chunks-workspace">
  <header class="edit-hero">
    <div>
      <p class="hero-kicker">K-Maps Workspace</p>
      <h1>Lexicon Book Reader</h1>
      <p class="hero-intent">
        Read as a book with Pages, Index, and TOC navigation.
      </p>
    </div>
    <div class="hero-actions">
      <span class="panel-chip">{{ scopeLabel }}</span>
      <span class="panel-chip">{{ tableCountLabel }}</span>
    </div>
  </header>

  <nav class="mobile-tabs" *ngIf="isCompact">
    <button type="button" [class.active]="mobileTab === 'books'" (click)="setMobileTab('books')">Navigator</button>
    <button type="button" [class.active]="mobileTab === 'reader'" (click)="setMobileTab('reader')">Reader</button>
  </nav>

  <div class="workspace-grid">
    <aside class="edit-panel workspace-panel panel-books" [class.mobile-active]="panelActive('books')">
      <header class="panel-head panel-head-tight">
        <div>
          <h2>{{ viewMode === 'search' ? 'Search + Navigator' : 'Book Navigator' }}</h2>
          <p *ngIf="viewMode === 'search'">Search pages, then open the matched page in the reader.</p>
          <p *ngIf="viewMode === 'read'">Switch between Pages, Index, and TOC, then jump into the page reader.</p>
        </div>
        <span class="panel-chip">{{ tableCountLabel }}</span>
      </header>

      <div class="panel-body panel-body-tight">
        <label>
          <span>Select Book</span>
          <select [(ngModel)]="selectedSourceCode" (change)="onBookChange()">
            <option *ngFor="let source of books" [value]="source.source_code">
              {{ source.source_code }} — {{ source.title }}
            </option>
          </select>
        </label>

        <div class="toggle-group">
          <span>Mode</span>
          <div class="toggle-buttons toggle-two">
            <button type="button" [class.active]="viewMode === 'search'" (click)="setViewMode('search')">Search</button>
            <button type="button" [class.active]="viewMode === 'read'" (click)="setViewMode('read')">Read</button>
          </div>
        </div>

        <div class="toggle-group" *ngIf="viewMode === 'read'">
          <span>Navigation</span>
          <div class="toggle-buttons toggle-three">
            <button type="button" [class.active]="readTab === 'pages'" (click)="setReadTab('pages')">Pages</button>
            <button type="button" [class.active]="readTab === 'index'" (click)="setReadTab('index')">Index</button>
            <button type="button" [class.active]="readTab === 'toc'" (click)="setReadTab('toc')">TOC</button>
          </div>
        </div>

        <div class="filter-grid">
          <label>
            <span>Page From</span>
            <input type="number" [(ngModel)]="pageFrom" />
          </label>
          <label>
            <span>Page To</span>
            <input type="number" [(ngModel)]="pageTo" />
          </label>
        </div>

        <label>
          <span>Heading contains</span>
          <input type="text" [(ngModel)]="headingFilter" placeholder="e.g. revelation clarity" (keyup.enter)="applyFilters()" />
        </label>

        <label>
          <span>Jump to page</span>
          <div class="jump-controls">
            <input type="number" [(ngModel)]="jumpPageNo" placeholder="Page #" (keyup.enter)="openJumpPage()" />
            <button type="button" class="btn btn-primary btn-sm" (click)="openJumpPage()" [disabled]="!selectedSourceCode">Open</button>
          </div>
        </label>

        <label>
          <span>Jump to term</span>
          <div class="jump-controls">
            <select [(ngModel)]="selectedTermChunkId" [disabled]="termsLoading || !termRows.length">
              <option value="">{{ termsLoading ? 'Loading terms…' : 'Select term' }}</option>
              <option *ngFor="let row of termRows; trackBy: trackByIndexId" [value]="row.index_id">
                {{ termLabel(row) }}
              </option>
            </select>
            <button type="button" class="btn btn-primary btn-sm" (click)="openSelectedTerm()" [disabled]="!selectedTermChunkId">
              Open
            </button>
          </div>
          <span class="feedback muted" *ngIf="!termsLoading && termRows.length">Loaded {{ termRows.length }} terms</span>
          <span class="feedback error" *ngIf="termsError">{{ termsError }}</span>
        </label>

        <div class="panel-actions">
          <button type="button" class="btn btn-primary" (click)="applyFilters()" [disabled]="!selectedSourceCode">
            Apply
          </button>
          <button type="button" class="btn btn-ghost" (click)="clearFilters()">
            Clear filters
          </button>
          <button type="button" class="btn btn-ghost" *ngIf="viewMode === 'read'" (click)="refreshReadRows()" [disabled]="readLoading || !selectedSourceCode">
            {{ readLoading ? 'Loading…' : 'Refresh ' + (readTab === 'pages' ? 'pages' : readTab === 'index' ? 'index' : 'TOC') }}
          </button>
        </div>

        <p class="feedback error" *ngIf="booksError">{{ booksError }}</p>
        <p class="feedback muted" *ngIf="booksLoading">Loading books…</p>
        <p class="feedback error" *ngIf="viewMode === 'search' && searchError">{{ searchError }}</p>
        <p class="feedback error" *ngIf="viewMode === 'read' && readError">{{ readError }}</p>

        <div class="table-shell">
          <table class="workspace-table" *ngIf="viewMode === 'search'; else readModeTable">
            <thead>
              <tr>
                <th>Page</th>
                <th>Heading</th>
                <th>Snippet</th>
                <th>Open</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="searchLoading">
                <td colspan="4" class="state-cell">Loading results…</td>
              </tr>
              <tr *ngIf="!searchLoading && !searchRows.length">
                <td colspan="4" class="state-cell">No results</td>
              </tr>
              <tr
                *ngFor="let row of searchRows; trackBy: trackByChunkId"
                [class.is-active]="row.chunk_id === activeChunkId"
                (click)="openSearchRow(row)"
              >
                <td>{{ row.page_no ?? '—' }}</td>
                <td>{{ row.heading_raw || 'No heading' }}</td>
                <td><span class="snippet" [innerHTML]="row.snippet_html"></span></td>
                <td>
                  <button type="button" class="btn btn-ghost btn-sm" (click)="openSearchRow(row); $event.stopPropagation()">Open</button>
                </td>
              </tr>
            </tbody>
          </table>

          <ng-template #readModeTable>
            <table class="workspace-table" *ngIf="readTab === 'pages'">
              <thead>
                <tr>
                  <th>Page</th>
                  <th>Heading</th>
                  <th>Open</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngIf="readLoading">
                  <td colspan="3" class="state-cell">Loading pages…</td>
                </tr>
                <tr *ngIf="!readLoading && !readRows.length">
                  <td colspan="3" class="state-cell">{{ listEmptyMessage }}</td>
                </tr>
                <tr
                  *ngFor="let row of readRows; trackBy: trackByChunkId"
                  [class.is-active]="row.chunk_id === activeChunkId"
                  (click)="openReadRow(row)"
                >
                  <td>{{ row.page_no ?? '—' }}</td>
                  <td>{{ row.heading_raw || row.locator || 'Page entry' }}</td>
                  <td>
                    <button type="button" class="btn btn-ghost btn-sm" (click)="openReadRow(row); $event.stopPropagation()">Open</button>
                  </td>
                </tr>
              </tbody>
            </table>

            <table class="workspace-table" *ngIf="readTab === 'index'">
              <thead>
                <tr>
                  <th>Term</th>
                  <th>Refs</th>
                  <th>Open</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngIf="readLoading">
                  <td colspan="3" class="state-cell">Loading index…</td>
                </tr>
                <tr *ngIf="!readLoading && !indexRows.length">
                  <td colspan="3" class="state-cell">{{ listEmptyMessage }}</td>
                </tr>
                <tr
                  *ngFor="let row of indexRows; trackBy: trackByIndexId"
                  [class.is-active]="row.target_chunk_id === activeChunkId || row.head_chunk_id === activeChunkId"
                  (click)="openIndexRow(row)"
                >
                  <td>{{ row.term_raw || row.term_norm }}</td>
                  <td>{{ indexRefsLabel(row) }}</td>
                  <td>
                    <button type="button" class="btn btn-ghost btn-sm" (click)="openIndexRow(row); $event.stopPropagation()">Open</button>
                  </td>
                </tr>
              </tbody>
            </table>

            <table class="workspace-table" *ngIf="readTab === 'toc'">
              <thead>
                <tr>
                  <th>TOC</th>
                  <th>Page</th>
                  <th>Open</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngIf="readLoading">
                  <td colspan="3" class="state-cell">Loading TOC…</td>
                </tr>
                <tr *ngIf="!readLoading && !tocRows.length">
                  <td colspan="3" class="state-cell">{{ listEmptyMessage }}</td>
                </tr>
                <tr
                  *ngFor="let row of tocRows; trackBy: trackByTocId"
                  [class.is-active]="row.target_chunk_id === activeChunkId"
                  (click)="openTocRow(row)"
                >
                  <td class="toc-title-cell">
                    <span class="toc-title" [style.padding-left.rem]="row.depth > 1 ? (row.depth - 1) * 0.55 : 0">{{ row.index_path }} {{ row.title_raw }}</span>
                  </td>
                  <td>{{ row.page_no ?? '—' }}</td>
                  <td>
                    <button type="button" class="btn btn-ghost btn-sm" (click)="openTocRow(row); $event.stopPropagation()">Open</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </ng-template>
        </div>
      </div>
    </aside>

    <section class="edit-panel workspace-panel panel-reader" [class.mobile-active]="panelActive('reader')">
      <header class="panel-head panel-head-tight">
        <div>
          <h2>Page Reader</h2>
          <p>Read the selected page and move linearly through the book.</p>
        </div>
      </header>

      <div class="panel-body panel-body-tight">
        <div *ngIf="readerLoading" class="reader-state">Loading chunk…</div>
        <div *ngIf="readerError" class="reader-state error">{{ readerError }}</div>

        <ng-container *ngIf="selectedChunk as chunk; else emptyReader">
          <div class="reader-header">
            <div class="reader-meta-line">
              <strong>{{ chunk.source_code }}</strong>
              <span>Page {{ chunk.page_no ?? '—' }}</span>
              <span>{{ chunk.heading_raw || 'No heading' }}</span>
            </div>
            <div class="reader-id">{{ chunk.chunk_id }}</div>
          </div>

          <div class="reader-controls">
            <button type="button" class="btn btn-ghost btn-sm" (click)="openPrev()" [disabled]="!readerNav.prev_chunk_id">Prev Chunk</button>
            <button type="button" class="btn btn-ghost btn-sm" (click)="openNext()" [disabled]="!readerNav.next_chunk_id">Next Chunk</button>
            <button
              type="button"
              class="btn btn-ghost btn-sm"
              (click)="openLinearPrevPage()"
              [disabled]="chunk.page_no === null || chunk.page_no <= 0"
            >
              Prev Page
            </button>
            <button type="button" class="btn btn-ghost btn-sm" (click)="openLinearNextPage()" [disabled]="chunk.page_no === null">
              Next Page
            </button>
            <button type="button" class="btn btn-ghost btn-sm" (click)="copyChunkText()">Copy</button>
            <button type="button" class="btn btn-ghost btn-sm" (click)="startEdit()" *ngIf="!editorEditing">Edit</button>
            <button type="button" class="btn btn-primary btn-sm" (click)="saveEdit()" [disabled]="editorSaving" *ngIf="editorEditing">
              {{ editorSaving ? 'Saving…' : 'Save' }}
            </button>
            <button type="button" class="btn btn-ghost btn-sm" (click)="cancelEdit()" [disabled]="editorSaving" *ngIf="editorEditing">
              Cancel
            </button>
          </div>

          <div class="reader-controls reader-controls-secondary">
            <label class="inline-control range-control">
              <span>Font {{ fontSize }}px</span>
              <input type="range" min="13" max="30" step="1" [(ngModel)]="fontSize" />
            </label>
            <label class="inline-control">
              <input type="checkbox" [(ngModel)]="arabicFriendlyLineHeight" />
              <span>Arabic line-height</span>
            </label>
            <label class="inline-control">
              <input type="checkbox" [(ngModel)]="monospace" />
              <span>Monospace</span>
            </label>
            <label class="inline-control">
              <input type="checkbox" [(ngModel)]="wrapText" />
              <span>Wrap</span>
            </label>
          </div>

          <div class="editor-panel" *ngIf="editorEditing">
            <div class="editor-grid">
              <label>
                <span>Page</span>
                <input type="number" [(ngModel)]="editPageNo" />
              </label>
              <label>
                <span>Heading</span>
                <input type="text" [(ngModel)]="editHeadingRaw" />
              </label>
              <label>
                <span>Locator</span>
                <input type="text" [(ngModel)]="editLocator" />
              </label>
              <label>
                <span>Type</span>
                <select [(ngModel)]="editChunkType">
                  <option *ngFor="let option of chunkTypeOptions" [value]="option">{{ option }}</option>
                </select>
              </label>
            </div>
            <label>
              <span>Text</span>
              <textarea [(ngModel)]="editText" rows="16"></textarea>
            </label>
          </div>

          <p class="feedback error" *ngIf="editorError">{{ editorError }}</p>
          <p class="feedback muted" *ngIf="editorMessage">{{ editorMessage }}</p>

          <div class="reader-viewport" #readerViewport>
            <pre class="reader-text" [ngStyle]="readerTextStyle()" [innerHTML]="readerTextHtml()"></pre>
          </div>
        </ng-container>

        <ng-template #emptyReader>
          <div class="reader-placeholder">{{ readerEmptyMessage }}</div>
        </ng-template>
      </div>
    </section>
  </div>
</section>
