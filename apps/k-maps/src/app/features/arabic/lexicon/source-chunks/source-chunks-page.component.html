<section class="source-chunks-workspace" [ngStyle]="workspaceCssVars">
  <app-headerbar
    class="books-headerbar"
    [showTitle]="true"
    [title]="'Lexicon Reader'"
    [showSearch]="true"
    [placeholder]="'Search this book (term, phrase, boolean)'"
    [value]="query"
    [primaryLabel]="'Find'"
    [secondaryLabel]="'Clear'"
    (search)="onHeaderSearchInput($event)"
    (primary)="runSearch()"
    (secondary)="clearSearch()"
  />

  <section class="workspace-topbar">
    <label class="book-corner-select">
      <span>Book List</span>
      <select [ngModel]="selectedSourceCode" (ngModelChange)="onBookPickerSelect($event)">
        <option *ngFor="let source of books; trackBy: trackBySourceCode" [value]="source.source_code">
          {{ bookDisplayName(source) }}
        </option>
      </select>
    </label>

    <label class="jump-page-select">
      <span>Jump Page</span>
      <div class="jump-page-row">
        <input type="number" min="1" [(ngModel)]="jumpPageNo" (keyup.enter)="openJumpPage()" />
        <button type="button" class="btn btn-ghost jump-page-btn" (click)="openJumpPage()">Go</button>
      </div>
    </label>

    <button
      type="button"
      class="btn btn-ghost indexes-toggle-btn"
      *ngIf="!isCompact"
      (click)="toggleIndexesPanel()"
    >
      {{ showIndexesPanel ? 'Hide Indexes' : 'Show Indexes' }}
    </button>
  </section>

  <nav class="mobile-switch" *ngIf="isCompact">
    <button type="button" [class.active]="mobileTab === 'reader'" (click)="setMobileTab('reader')">Reader</button>
    <button type="button" [class.active]="mobileTab === 'books'" (click)="setMobileTab('books')">Indexes</button>
  </nav>

  <div class="workspace-grid" [class.indexes-hidden]="!showIndexesPanel && !isCompact">
    <section class="workspace-panel panel-reader" [class.mobile-active]="panelActive('reader')">
      <header class="workspace-head">
        <div class="workspace-head-copy">
          <h2>Book Reader</h2>
          <p>Continuous scroll reader with auto-load on scroll. TOC click jumps to the selected page.</p>
        </div>
      </header>

      <div class="workspace-body reader-body">
        <div class="reader-controls reader-controls-secondary">
          <label class="inline-control range-control">
            <span>Font {{ fontSize }}px</span>
            <input type="range" min="13" max="30" step="1" [(ngModel)]="fontSize" />
          </label>
          <label class="inline-control">
            <input type="checkbox" [(ngModel)]="arabicFriendlyLineHeight" />
            <span>Arabic line-height</span>
          </label>
          <label class="inline-control">
            <input type="checkbox" [(ngModel)]="monospace" />
            <span>Monospace</span>
          </label>
          <label class="inline-control">
            <input type="checkbox" [(ngModel)]="wrapText" />
            <span>Wrap</span>
          </label>
        </div>

        <p class="feedback error" *ngIf="readerError">{{ readerError }}</p>

        <app-book-scroll-reader
          #bookReader
          [sourceCode]="selectedSourceCode"
          [query]="query"
          [indexTerm]="activeIndexTerm"
          [indexTerms]="readerIndexTerms"
          [fontSize]="fontSize"
          [arabicFriendlyLineHeight]="arabicFriendlyLineHeight"
          [monospace]="monospace"
          [wrapText]="wrapText"
          (pageInViewChange)="onReaderPageInView($event)"
        />
      </div>
    </section>

    <aside class="workspace-panel panel-books" [class.mobile-active]="panelActive('books')" *ngIf="showIndexesPanel || isCompact">
      <header class="workspace-head">
        <div class="workspace-head-copy">
          <h2>TOC Indexes</h2>
          <p>Click any TOC index to load and move to that section in the reader.</p>
        </div>
        <span class="panel-chip">{{ tableCountLabel }}</span>
      </header>

      <div class="workspace-body indexes-body">
        <p class="feedback muted" *ngIf="booksLoading">Loading books…</p>
        <p class="feedback error" *ngIf="booksError">{{ booksError }}</p>
        <p class="feedback muted" *ngIf="searchLoading">Searching…</p>
        <p class="feedback error" *ngIf="searchError">{{ searchError }}</p>
        <p class="feedback error" *ngIf="readError">{{ readError }}</p>

        <app-sticky-panel
          class="indexes-sticky-panel"
          [title]="'TOC Directory'"
          [countLabel]="tocRows.length + ' items'"
          [sticky]="!isCompact"
          [stickyTop]="'0.75rem'"
        >
          <section class="toc-catalog" #tocCatalog>
            <div class="toc-catalog-state" *ngIf="readLoading">Loading TOC…</div>
            <div class="toc-catalog-state" *ngIf="!readLoading && !tocRows.length">{{ listEmptyMessage }}</div>

            <button
              type="button"
              class="toc-card"
              *ngFor="let row of tocRows; trackBy: trackByTocId"
              [class.is-active]="row.toc_id === activeTocId || row.target_chunk_id === activeChunkId"
              (click)="openTocRow(row)"
            >
              <span class="toc-card-title" [style.padding-left.rem]="row.depth > 1 ? (row.depth - 1) * 0.5 : 0">
                {{ row.title_norm }}
              </span>
            </button>
          </section>
        </app-sticky-panel>

        <app-sticky-panel
          class="indexes-sticky-panel"
          [title]="'Main Index in Selected TOC'"
          [countLabel]="tocMainIndexHits.length + ' items'"
          [sticky]="!isCompact"
          [stickyTop]="'calc(0.75rem + min(40vh, 360px) + 0.72rem)'"
        >
          <section class="toc-catalog">
            <div class="toc-catalog-state" *ngIf="indexLoading">Loading main index…</div>
            <div class="toc-catalog-state" *ngIf="!indexLoading && indexError">{{ indexError }}</div>
            <div class="toc-catalog-state" *ngIf="!indexLoading && !indexError && !tocMainIndexHits.length">
              No is_main index entries for {{ tocMainIndexRangeLabel }}.
            </div>

            <button
              type="button"
              class="toc-card toc-index-card"
              *ngFor="let hit of tocMainIndexHits; trackBy: trackByTocMainIndexId"
              [class.is-active]="hit.index_id === activeIndexId"
              (click)="openTocMainIndexHit(hit)"
            >
              <span class="toc-card-title">{{ hit.term }}</span>
              <span class="toc-card-meta">{{ hit.refs_label }}</span>
            </button>
          </section>
        </app-sticky-panel>

        <app-sticky-panel
          class="indexes-sticky-panel"
          [title]="'All Indexes for Current Page'"
          [countLabel]="pageIndexHits.length + ' items'"
          [sticky]="false"
        >
          <section class="toc-catalog">
            <div class="toc-catalog-state" *ngIf="indexLoading">Loading page indexes…</div>
            <div class="toc-catalog-state" *ngIf="!indexLoading && indexError">{{ indexError }}</div>
            <div class="toc-catalog-state" *ngIf="!indexLoading && !indexError && !pageIndexHits.length">
              No index entries found for {{ currentPageIndexLabel }}.
            </div>

            <button
              type="button"
              class="toc-card toc-index-card toc-index-card-page"
              *ngFor="let hit of pageIndexHits; trackBy: trackByTocMainIndexId"
              [class.is-active]="hit.index_id === activeIndexId"
              (click)="openTocMainIndexHit(hit)"
            >
              <span class="toc-card-title">{{ hit.term }}</span>
              <span class="toc-card-meta">{{ hit.refs_label }}</span>
            </button>
          </section>
        </app-sticky-panel>
      </div>
    </aside>
  </div>
</section>
