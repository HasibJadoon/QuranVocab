<section class="quran-edit-new lexicon-desk">
  <header class="edit-hero lexicon-hero">
    <div>
      <p class="hero-kicker">K-Maps Lexicon Desk</p>
      <h1><span class="lexicon-word-ar">{{ entryArabic }}</span> {{ entryTitle }}</h1>
      <p class="hero-intent">{{ entryGloss }}</p>
    </div>
    <div class="hero-actions">
      <span class="panel-chip">{{ sourceCountLabel() }}</span>
      <button type="button" class="btn btn-ghost" (click)="loadSources()" [disabled]="sourcesLoading">
        {{ sourcesLoading ? 'Loading…' : 'Refresh Sources' }}
      </button>
    </div>
  </header>

  <section class="sentence-tabs lexicon-tabs-wrap">
    <div class="nav">
      <button
        type="button"
        class="nav-link"
        *ngFor="let tab of tabs"
        [class.active]="activeTab === tab.id"
        (click)="setTab(tab.id)"
      >
        {{ tab.label }}
      </button>
    </div>
  </section>

  <div class="edit-grid lexicon-grid">
    <section class="edit-panel lexicon-panel">
      <header class="panel-head">
        <div>
          <h2>Source Overview</h2>
          <p>Select the book and update source scope.</p>
        </div>
        <span class="panel-chip">{{ sourceCountLabel() }}</span>
      </header>

      <div class="panel-body">
        <div class="source-search-row">
          <label>
            <span>Find source</span>
            <input
              type="text"
              [(ngModel)]="sourceQuery"
              placeholder="Sinai, HDO, Lane..."
              (keyup.enter)="loadSources()"
            />
          </label>
        </div>

        <p class="feedback error" *ngIf="sourcesError">{{ sourcesError }}</p>

        <div class="badge-row source-pill-row" *ngIf="sources.length">
          <button
            type="button"
            class="panel-chip source-pill"
            *ngFor="let source of sources"
            [class.panel-chip--locked]="source.source_code === selectedSourceCode"
            (click)="selectSource(source.source_code)"
          >
            {{ source.title }}
          </button>
        </div>

        <div class="source-meta" *ngIf="selectedSource">
          <strong>{{ selectedSource.title }}</strong>
          <span>· {{ selectedSource.author || 'Unknown author' }}</span>
          <span>· {{ selectedSource.chunk_count }} chunks indexed</span>
        </div>
      </div>
    </section>

    <section class="edit-panel lexicon-panel">
      <header class="panel-head">
        <div>
          <h2>Search Book Chunks</h2>
          <p>Raw OCR full-text search by book, page range, and heading.</p>
        </div>
        <span class="panel-chip" *ngIf="selectedSourceCode">{{ selectedSourceCode }}</span>
      </header>

      <div class="panel-body">
        <div class="chunk-filter-grid">
          <label>
            <span>Query (FTS)</span>
            <input
              type="text"
              [(ngModel)]="chunkQuery"
              placeholder="mubin OR مبين"
              (keyup.enter)="runChunkSearch()"
            />
          </label>
          <label>
            <span>Page from</span>
            <input type="number" [(ngModel)]="pageFrom" />
          </label>
          <label>
            <span>Page to</span>
            <input type="number" [(ngModel)]="pageTo" />
          </label>
          <label>
            <span>Heading norm</span>
            <input
              type="text"
              [(ngModel)]="headingNorm"
              placeholder="page 188"
              (keyup.enter)="runChunkSearch()"
            />
          </label>
        </div>

        <div class="action-row">
          <button
            type="button"
            class="btn btn-primary"
            (click)="runChunkSearch()"
            [disabled]="chunksLoading || !selectedSourceCode"
          >
            {{ chunksLoading ? 'Searching…' : 'Search Book' }}
          </button>
          <button type="button" class="btn btn-ghost" (click)="clearHeadingFilter()" [disabled]="chunksLoading">
            Clear Heading
          </button>
          <span class="panel-chip result-count">{{ chunksTotal }} hits</span>
        </div>

        <p class="feedback error" *ngIf="chunksError">{{ chunksError }}</p>

        <div class="lesson-grid chunk-grid" *ngIf="chunkResults.length">
          <article class="lesson-card chunk-card" *ngFor="let row of chunkResults">
            <div class="chunk-card-head">
              <div>
                <div class="chunk-page">p. {{ row.page_no ?? '—' }}</div>
                <div class="chunk-heading">{{ row.heading_raw || row.chunk_id }}</div>
              </div>
              <div class="chunk-rank" *ngIf="row.rank !== null">{{ row.rank | number: '1.0-3' }}</div>
            </div>
            <p class="chunk-hit">{{ stripHit(row.hit) || 'No snippet available.' }}</p>
          </article>
        </div>

        <p class="feedback muted" *ngIf="!chunksLoading && !chunksError && !chunkResults.length">
          No chunk hits yet. Choose a source and run search.
        </p>
      </div>
    </section>

    <section class="edit-panel lexicon-panel">
      <header class="panel-head">
        <div>
          <h2>Lexicon Sub Menu</h2>
          <p>Open Evidence, ar_u_lexicon list, or Surah + Lexicon view.</p>
        </div>
      </header>

      <div class="panel-body">
        <div class="lesson-grid lexicon-submenu-grid">
          <article
            class="lesson-card lexicon-menu-card"
            *ngFor="let card of subMenuCards"
            [class.active]="activeSubMenu === card.id"
          >
            <h4>{{ card.title }}</h4>
            <p>{{ card.description }}</p>
            <div class="action-row">
              <button type="button" class="btn btn-ghost" (click)="setSubMenu(card.id)">
                {{ activeSubMenu === card.id ? 'Opened' : 'Open' }}
              </button>
            </div>
          </article>
        </div>
      </div>
    </section>

    <section class="edit-panel lexicon-panel" *ngIf="activeSubMenu === 'evidence'">
      <header class="panel-head">
        <div>
          <h2>Curated Evidence Search</h2>
          <p>Search notes and extracted snippets linked to lexicon rows.</p>
        </div>
      </header>

      <div class="panel-body">
        <div class="source-search-row">
          <label>
            <span>Evidence query</span>
            <input
              type="text"
              [(ngModel)]="evidenceQuery"
              placeholder="clear OR mubin OR مبين"
              (keyup.enter)="runEvidenceSearch()"
            />
          </label>
          <button
            type="button"
            class="btn btn-primary"
            (click)="runEvidenceSearch()"
            [disabled]="evidenceLoading || !selectedSourceCode"
          >
            {{ evidenceLoading ? 'Searching…' : 'Search Evidence' }}
          </button>
        </div>

        <p class="feedback error" *ngIf="evidenceError">{{ evidenceError }}</p>
        <p class="feedback muted" *ngIf="!evidenceLoading && !evidenceError">
          {{ evidenceTotal }} evidence hits
        </p>

        <div class="lesson-grid evidence-grid" *ngIf="evidenceResults.length">
          <article class="lesson-card evidence-card" *ngFor="let row of evidenceResults">
            <header>
              <div>{{ row.chunk_id }}</div>
              <div>p. {{ row.page_no ?? '—' }}</div>
            </header>
            <p>{{ stripHit(row.extract_hit) || 'No extract snippet.' }}</p>
            <small>{{ stripHit(row.notes_hit) }}</small>
          </article>
        </div>
      </div>
    </section>

    <section class="edit-panel lexicon-panel" *ngIf="activeSubMenu === 'evidence'">
      <header class="panel-head">
        <div>
          <h2>Lexicon Evidence by ID</h2>
          <p>Load grouped evidence for one <code>ar_u_lexicon</code>.</p>
        </div>
      </header>

      <div class="panel-body">
        <div class="source-search-row">
          <label>
            <span>ar_u_lexicon</span>
            <input
              type="text"
              [(ngModel)]="lexiconId"
              placeholder="Paste lexicon id"
              (keyup.enter)="runLexiconEvidence()"
            />
          </label>
          <button type="button" class="btn btn-primary" (click)="runLexiconEvidence()" [disabled]="lexiconEvidenceLoading">
            {{ lexiconEvidenceLoading ? 'Loading…' : 'Load Evidence' }}
          </button>
        </div>

        <p class="feedback error" *ngIf="lexiconEvidenceError">{{ lexiconEvidenceError }}</p>
        <p class="feedback muted" *ngIf="!lexiconEvidenceLoading && !lexiconEvidenceError">
          {{ lexiconEvidenceTotal }} grouped rows
        </p>

        <div class="table-wrap" *ngIf="lexiconEvidenceResults.length">
          <app-crud-table
            [columns]="lexiconEvidenceColumns"
            [rows]="lexiconEvidenceResults"
            [showActions]="false"
            [emptyMessage]="'No lexicon evidence rows.'"
          ></app-crud-table>
        </div>
      </div>
    </section>

    <section class="edit-panel lexicon-panel" *ngIf="activeSubMenu === 'entries'">
      <header class="panel-head">
        <div>
          <h2>ar_u_lexicon List</h2>
          <p>All lexicon IDs found from evidence for this source.</p>
        </div>
        <span class="panel-chip">{{ entriesTotal }} rows</span>
      </header>

      <div class="panel-body">
        <div class="action-row">
          <button
            type="button"
            class="btn btn-primary"
            (click)="refreshDerivedViews()"
            [disabled]="entriesLoading || !selectedSourceCode"
          >
            {{ entriesLoading ? 'Loading…' : 'Refresh ar_u_lexicon' }}
          </button>
        </div>

        <p class="feedback error" *ngIf="entriesError">{{ entriesError }}</p>
        <p class="feedback muted" *ngIf="entriesLoading">Building lexicon index from evidence…</p>

        <div class="table-wrap" *ngIf="entryRows.length">
          <app-crud-table
            [columns]="entryColumns"
            [rows]="entryRows"
            [showActions]="false"
            [emptyMessage]="'No ar_u_lexicon rows found.'"
          ></app-crud-table>
        </div>

        <p class="feedback muted" *ngIf="!entriesLoading && !entriesError && !entryRows.length">
          No lexicon rows found for this filter.
        </p>
      </div>
    </section>

    <section class="edit-panel lexicon-panel" *ngIf="activeSubMenu === 'surah'">
      <header class="panel-head">
        <div>
          <h2>Surah + Lexicon</h2>
          <p>Evidence grouped per surah with linked <code>ar_u_lexicon</code>.</p>
        </div>
        <span class="panel-chip">{{ surahTotal }} rows</span>
      </header>

      <div class="panel-body">
        <div class="action-row">
          <button
            type="button"
            class="btn btn-primary"
            (click)="refreshDerivedViews()"
            [disabled]="surahLoading || !selectedSourceCode"
          >
            {{ surahLoading ? 'Loading…' : 'Refresh Surah + Lexicon' }}
          </button>
        </div>

        <p class="feedback error" *ngIf="surahError">{{ surahError }}</p>
        <p class="feedback muted" *ngIf="surahLoading">Mapping evidence into surah groups…</p>

        <div class="table-wrap" *ngIf="surahRows.length">
          <app-crud-table
            [columns]="surahColumns"
            [rows]="surahRows"
            [showActions]="false"
            [emptyMessage]="'No surah + lexicon rows found.'"
          ></app-crud-table>
        </div>

        <p class="feedback muted" *ngIf="!surahLoading && !surahError && !surahRows.length">
          No surah-linked rows found for this source/filter.
        </p>
      </div>
    </section>
  </div>
</section>
