<section class="review-page">
  <header class="review-header">
    <div>
      <p class="kicker">Sprint Review</p>
      <h1>{{ reviewDraft.title }}</h1>
      <p>{{ weekRangeLabel() }}</p>
    </div>
    <button class="primary-btn" type="button" (click)="submit()" [disabled]="saving()">
      {{ saving() ? 'Saving...' : 'Submit Review' }}
    </button>
  </header>

  @if (error()) {
    <p class="error-msg">{{ error() }}</p>
  }

  @if (saved()) {
    <p class="saved-msg">Review saved.</p>
  }

  @if (loading()) {
    <div class="loading">Loading review...</div>
  } @else {
    <section class="metrics-grid">
      <article>
        <h3>Tasks</h3>
        <p>{{ reviewDraft.metrics.tasks_done }} / {{ reviewDraft.metrics.tasks_total }}</p>
      </article>
      <article>
        <h3>Minutes</h3>
        <p>{{ reviewDraft.metrics.minutes_spent }}</p>
      </article>
      <article>
        <h3>Capture Notes</h3>
        <p>{{ reviewDraft.metrics.capture_notes }}</p>
      </article>
      <article>
        <h3>Promoted Notes</h3>
        <p>{{ reviewDraft.metrics.promoted_notes }}</p>
      </article>
    </section>

    <section class="form-grid">
      <article class="form-card">
        <h2>Outcomes</h2>
        <div class="add-row">
          <input [(ngModel)]="outcomeLabel" placeholder="Outcome label" name="outcome-input" />
          <button type="button" class="ghost-btn" (click)="addOutcome()">Add</button>
        </div>

        @for (outcome of reviewDraft.outcomes; track outcome.label; let idx = $index) {
          <div class="outcome-row">
            <input [(ngModel)]="outcome.label" [name]="'outcome-label-' + idx" />
            <select [(ngModel)]="outcome.status" [name]="'outcome-status-' + idx">
              <option value="done">done</option>
              <option value="partial">partial</option>
              <option value="missed">missed</option>
            </select>
            <button type="button" class="ghost-btn" (click)="removeOutcome(idx)">Remove</button>
          </div>
        }
      </article>

      <article class="form-card">
        <h2>What Worked</h2>
        <textarea
          [ngModel]="workedText()"
          (ngModelChange)="onWorkedChanged($event)"
          name="worked-text"
          rows="7"
          placeholder="One item per line"
        ></textarea>
      </article>

      <article class="form-card">
        <h2>What Blocked</h2>
        <textarea
          [ngModel]="blockedText()"
          (ngModelChange)="onBlockedChanged($event)"
          name="blocked-text"
          rows="7"
          placeholder="One item per line"
        ></textarea>
      </article>

      <article class="form-card">
        <h2>Carry Over</h2>
        <textarea
          [ngModel]="carryOverText()"
          (ngModelChange)="onCarryOverChanged($event)"
          name="carry-over-text"
          rows="5"
          placeholder="Task IDs, one per line"
        ></textarea>

        <h3 class="sub">Incomplete Tasks</h3>
        @for (task of tasks(); track task.id) {
          @if (task.item_json.status !== 'done') {
            <button type="button" class="task-chip" (click)="markCarryOver(task)">
              {{ task.item_json.title }}
            </button>
          }
        }
      </article>

      <article class="form-card">
        <h2>Next Week Focus</h2>
        <textarea
          [ngModel]="nextFocusText()"
          (ngModelChange)="onNextFocusChanged($event)"
          name="next-focus-text"
          rows="5"
          placeholder="Focus points, one per line"
        ></textarea>
      </article>
    </section>
  }
</section>
