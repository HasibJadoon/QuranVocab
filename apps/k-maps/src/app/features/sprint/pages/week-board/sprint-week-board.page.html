<section class="sprint-week-page sp-shell">
  <header class="week-header sp-glass">
    <div>
      <h1>{{ weekRangeLabel() }}</h1>
    </div>

    <div class="header-actions">
      <button type="button" class="sp-btn" (click)="startCreateTask()">+ Add Task</button>
      <button type="button" class="sp-btn" (click)="goToReview()">Review</button>
    </div>
  </header>

  <section class="week-metrics sp-glass">
    <div class="metrics-line">
      <span class="metric-pill">Lessons {{ lessonAnchorDone() }}/2</span>
      <span class="metric-pill">Podcasts {{ podcastAnchorDone() }}/3</span>
      <span class="metric-pill">Minutes {{ summary().minutes_spent }}/{{ targetMinutes() }}</span>
    </div>
    <div class="meter meter-track">
      <span class="meter-done" [style.width.%]="completionPct()"></span>
      <span class="meter-time" [style.width.%]="minutesPct()"></span>
    </div>
  </section>

  <section class="task-strip sp-glass">
    <label class="task-field">
      <span>Add New Task</span>
      <input [formControl]="quickTaskControl" placeholder="Task title" (keydown.enter)="startCreateTask()" />
    </label>
    <button class="sp-btn sp-btn-primary" type="button" (click)="startCreateTask()">Add</button>
  </section>

  @if (error()) {
    <p class="error-msg">{{ error() }}</p>
  }

  @if (loading()) {
    <div class="loading">Loading weekly sprint...</div>
  } @else {
    <section class="board-layout">
      <main class="kanban-grid">
        @for (column of boardColumns; track column.key) {
          <article class="status-column sp-glass">
            <header class="status-header">
              <h3>{{ column.label }}</h3>
              <span>{{ columnCount(column.key) }}</span>
            </header>

            <div class="status-body">
              @for (lane of lanes; track lane) {
                <section class="lane-section">
                  <header class="lane-header">
                    <h4>{{ lane | titlecase }}</h4>
                    <span>{{ laneCount(column.key, lane) }}</span>
                  </header>

                  <div
                    class="lane-drop"
                    cdkDropList
                    [id]="boardDropListId(column.key, lane)"
                    [cdkDropListConnectedTo]="connectedDropListsForLane(lane)"
                    [cdkDropListData]="tasksFor(column.key, lane)"
                    (cdkDropListDropped)="onTaskDrop($event, column.key, lane)"
                  >
                    @for (task of tasksFor(column.key, lane); track task.id) {
                      <section class="task-card" cdkDrag>
                        <div class="task-top">
                          <button type="button" class="task-title" (click)="openTask(task)">
                            {{ task.item_json.title }}
                          </button>
                          @if (task.item_json.anchor) {
                            <span class="anchor-chip">Anchor</span>
                          }
                        </div>

                        <div class="task-meta-row">
                          <span class="sp-chip">{{ task.item_json.priority }}</span>
                          <span class="sp-chip">{{ task.item_json.estimate_min }} min</span>
                          <span class="sp-chip">{{ task.item_json.status | titlecase }}</span>
                        </div>

                        <p class="assignment-line">{{ assignmentSummary(task) }}</p>

                        <footer class="task-card-actions">
                          @if (task.item_json.status !== 'doing' && task.item_json.status !== 'done') {
                            <button type="button" class="mini-btn" (click)="startTask(task)">Start</button>
                          }
                          @if (task.item_json.status !== 'done') {
                            <button type="button" class="mini-btn" (click)="markDone(task)">Done</button>
                          }
                          <button type="button" class="mini-btn" (click)="openTask(task)">Edit</button>
                          @if (task.related_type && task.related_id) {
                            <button type="button" class="mini-btn" (click)="openRelated(task)">Open</button>
                          }
                        </footer>
                      </section>
                    }

                    @if (tasksFor(column.key, lane).length === 0) {
                      <p class="lane-empty">No tasks</p>
                    }
                  </div>
                </section>
              }
            </div>
          </article>
        }
      </main>

      <aside class="right-panel">
        <section class="panel-card sp-glass">
          <h3>Today's Focus</h3>

          <div class="focus-row">
            <div>
              <p class="focus-kicker">Lesson</p>
              <p class="focus-target">{{ nextLessonAnchor()?.item_json?.title || 'No pending lesson anchor' }}</p>
            </div>
            @if (nextLessonAnchor(); as lessonTarget) {
              <button type="button" class="mini-btn" (click)="startFocus(lessonTarget)">Start</button>
            }
          </div>

          <div class="focus-row">
            <div>
              <p class="focus-kicker">Podcast</p>
              <p class="focus-target">{{ nextPodcastAnchor()?.item_json?.title || 'No pending podcast anchor' }}</p>
            </div>
            @if (nextPodcastAnchor(); as podcastTarget) {
              <button type="button" class="mini-btn" (click)="startFocus(podcastTarget)">Start</button>
            }
          </div>

          <p class="mini">
            {{ focusState()?.focus_mode || 'planning' }}
            @if (focusState()?.current_type) {
              â€¢ {{ focusState()?.current_type }}
            }
          </p>
        </section>

        <section class="panel-card sp-glass">
          <h3>Quick Capture</h3>
          <label class="capture-field">
            <input
              [formControl]="quickCaptureControl"
              placeholder="Take quick note..."
              (keydown.enter)="captureQuickNote()"
            />
          </label>
          <button class="sp-btn sp-btn-primary" type="button" (click)="captureQuickNote()" [disabled]="saving()">Add</button>
        </section>

        <section class="panel-card sp-glass">
          <h3>Inbox</h3>
          @for (note of inboxNotes(); track note.id) {
            <article class="inbox-item">
              <h4>{{ note.title || 'Capture note' }}</h4>
              <p>{{ note.text }}</p>
              <p class="mini">{{ note.updated_at | date:'EEE h:mm a' }}</p>

              <div class="inbox-promote-row">
                <select
                  [ngModel]="promoteTypeFor(note)"
                  (ngModelChange)="setPromoteType(note.id, $event)"
                  [name]="'note-type-' + note.id"
                >
                  @for (type of noteTypes; track type) {
                    <option [value]="type">{{ type }}</option>
                  }
                </select>
              </div>

              <div class="inbox-actions">
                <button type="button" class="mini-btn" (click)="promoteNote(note)">Promote</button>
                <button type="button" class="mini-btn" (click)="archiveNote(note)">Archive</button>
              </div>
            </article>
          }

          @if (inboxNotes().length === 0) {
            <p class="mini">No inbox notes.</p>
          }
        </section>
      </aside>
    </section>
  }

  <footer class="week-footer sp-glass">
    <span class="mini">{{ summary().tasks_done }}/{{ summary().tasks_total }} tasks done</span>
    <span class="mini">{{ summary().minutes_spent }} min logged</span>
    <span class="mini">Target {{ targetMinutes() }} min</span>
  </footer>
</section>

@if (drawerOpen()) {
  <aside class="task-drawer-backdrop" (click)="closeDrawer()">
    <section class="task-drawer sp-panel" (click)="$event.stopPropagation()">
      <header class="drawer-head">
        <h3>{{ taskSource ? 'Task Detail' : 'New Task' }}</h3>
        <button type="button" class="sp-btn" (click)="closeDrawer()">Close</button>
      </header>

      @if (taskDraft) {
        <div class="drawer-body">
          <label>
            <span>Title</span>
            <input [(ngModel)]="taskDraft.title" name="task-title" />
          </label>

          <div class="row-3">
            <label>
              <span>Lane</span>
              <select [(ngModel)]="taskDraft.lane" name="task-lane">
                @for (lane of lanes; track lane) {
                  <option [value]="lane">{{ lane | titlecase }}</option>
                }
              </select>
            </label>

            <label>
              <span>Priority</span>
              <select [(ngModel)]="taskDraft.priority" name="task-priority">
                @for (priority of priorities; track priority) {
                  <option [value]="priority">{{ priority }}</option>
                }
              </select>
            </label>

            <label>
              <span>Status</span>
              <select [(ngModel)]="taskDraft.status" name="task-status">
                @for (status of statuses; track status) {
                  <option [value]="status">{{ status }}</option>
                }
              </select>
            </label>
          </div>

          <div class="row-2">
            <label>
              <span>Estimate (min)</span>
              <input type="number" [(ngModel)]="taskDraft.estimate_min" name="task-estimate" />
            </label>

            <label>
              <span>Actual (min)</span>
              <input type="number" [(ngModel)]="taskDraft.actual_min" name="task-actual" />
            </label>
          </div>

          <label>
            <span>Assignment Kind</span>
            <select [(ngModel)]="taskDraft.assignment.kind" name="task-assignment-kind">
              <option value="none">None</option>
              <option value="lesson">Lesson</option>
              <option value="podcast">Podcast</option>
            </select>
          </label>

          @if (taskDraft.assignment.kind === 'lesson') {
            <div class="row-2">
              <label>
                <span>Lesson</span>
                <select [(ngModel)]="taskDraft.assignment.ar_lesson_id" name="task-assignment-lesson">
                  <option [ngValue]="null">Select lesson</option>
                  @for (lesson of lessonOptions(); track lesson.id) {
                    <option [ngValue]="lesson.id">{{ lesson.title }}</option>
                  }
                </select>
              </label>

              <label>
                <span>Unit Id</span>
                <input [(ngModel)]="taskDraft.assignment.unit_id" name="task-assignment-unit" />
              </label>
            </div>
          }

          @if (taskDraft.assignment.kind === 'podcast') {
            <div class="row-3">
              <label>
                <span>Topic</span>
                <input [(ngModel)]="taskDraft.assignment.topic" name="task-assignment-topic" />
              </label>
              <label>
                <span>Episode #</span>
                <input type="number" [(ngModel)]="taskDraft.assignment.episode_no" name="task-assignment-episode" />
              </label>
              <label>
                <span>Recording</span>
                <input type="datetime-local" [(ngModel)]="taskDraft.assignment.recording_at" name="task-assignment-recording" />
              </label>
            </div>
          }

          <div class="row-2">
            <label>
              <span>Related Type</span>
              <input [(ngModel)]="taskRelatedType" name="task-related-type" placeholder="ar_lesson | wv_content_item" />
            </label>

            <label>
              <span>Related Id</span>
              <input [(ngModel)]="taskRelatedId" name="task-related-id" />
            </label>
          </div>

          <label>
            <span>Task Note</span>
            <textarea [(ngModel)]="taskDraft.note" name="task-note" rows="3"></textarea>
          </label>

          <div class="checklist-block">
            <h4>Checklist</h4>
            <div class="checklist-add-row">
              <input [formControl]="checklistInputControl" placeholder="Add checklist item" (keydown.enter)="addChecklistItem()" />
              <button type="button" class="mini-btn" (click)="addChecklistItem()">Add</button>
            </div>

            @for (item of taskDraft.checklist; track item.id) {
              <label class="check-item">
                <input type="checkbox" [(ngModel)]="item.done" [name]="'check-' + item.id" />
                <span>{{ item.label }}</span>
                <button type="button" class="mini-btn" (click)="removeChecklistItem(item.id)">Remove</button>
              </label>
            }
          </div>

          <footer class="drawer-footer">
            <button type="button" class="sp-btn" (click)="saveDraft()" [disabled]="saving()">Save</button>
            @if (taskSource) {
              <button type="button" class="sp-btn sp-btn-primary" (click)="markDone(taskSource)" [disabled]="saving()">Mark Done</button>
            }
          </footer>
        </div>
      }
    </section>
  </aside>
}

@if (planningModalOpen()) {
  <aside class="planning-backdrop">
    <section class="planning-modal sp-panel">
      <header class="planning-header">
        <h3>Plan This Week</h3>
        <p>Assign 2 lesson anchors and 3 podcast anchors before work starts.</p>
      </header>

      <div class="planning-body">
        <div class="planning-group">
          <h4>Lesson 1</h4>
          <select [(ngModel)]="planDraft.lesson_1.ar_lesson_id" name="plan-lesson-1">
            <option [ngValue]="null">Continue last / not assigned</option>
            @for (lesson of lessonOptions(); track lesson.id) {
              <option [ngValue]="lesson.id">{{ lesson.title }}</option>
            }
          </select>
        </div>

        <div class="planning-group">
          <h4>Lesson 2</h4>
          <select [(ngModel)]="planDraft.lesson_2.ar_lesson_id" name="plan-lesson-2">
            <option [ngValue]="null">Continue last / not assigned</option>
            @for (lesson of lessonOptions(); track lesson.id) {
              <option [ngValue]="lesson.id">{{ lesson.title }}</option>
            }
          </select>
        </div>

        <div class="planning-group">
          <h4>Podcast 1</h4>
          <input [(ngModel)]="planDraft.podcast_1.topic" name="plan-podcast-1-topic" placeholder="Topic" />
          <div class="row-2">
            <input type="number" [(ngModel)]="planDraft.podcast_1.episode_no" name="plan-podcast-1-episode" placeholder="Episode #" />
            <input type="datetime-local" [(ngModel)]="planDraft.podcast_1.recording_at" name="plan-podcast-1-recording" />
          </div>
        </div>

        <div class="planning-group">
          <h4>Podcast 2</h4>
          <input [(ngModel)]="planDraft.podcast_2.topic" name="plan-podcast-2-topic" placeholder="Topic" />
          <div class="row-2">
            <input type="number" [(ngModel)]="planDraft.podcast_2.episode_no" name="plan-podcast-2-episode" placeholder="Episode #" />
            <input type="datetime-local" [(ngModel)]="planDraft.podcast_2.recording_at" name="plan-podcast-2-recording" />
          </div>
        </div>

        <div class="planning-group">
          <h4>Podcast 3</h4>
          <input [(ngModel)]="planDraft.podcast_3.topic" name="plan-podcast-3-topic" placeholder="Topic" />
          <div class="row-2">
            <input type="number" [(ngModel)]="planDraft.podcast_3.episode_no" name="plan-podcast-3-episode" placeholder="Episode #" />
            <input type="datetime-local" [(ngModel)]="planDraft.podcast_3.recording_at" name="plan-podcast-3-recording" />
          </div>
        </div>
      </div>

      <footer class="planning-footer">
        <button type="button" class="sp-btn" (click)="deferPlanToLater()" [disabled]="saving()">Later Today</button>
        <button type="button" class="sp-btn sp-btn-primary" (click)="saveWeekPlan()" [disabled]="saving()">Save Plan</button>
      </footer>
    </section>
  </aside>
}
