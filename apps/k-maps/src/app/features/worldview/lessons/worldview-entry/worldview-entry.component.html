<div class="entry-shell">
  <div class="entry-header">
    <div>
      <h5 class="mb-1">{{ entry?.source?.title || 'Worldview Entry' }}</h5>
      <div class="text-medium-emphasis" *ngIf="entry">
        {{ entry.source.creator }} â€¢ {{ entry.source.kind }}
      </div>
      <div class="text-medium-emphasis" *ngIf="!entry">Capture a new source quickly.</div>
    </div>
    <div class="mode-toggle">
      <button class="btn btn-sm" [class.btn-secondary]="mode === 'view'" [class.btn-outline-secondary]="mode !== 'view'" (click)="setMode('view')" [disabled]="!entry">View</button>
      <button class="btn btn-sm" [class.btn-secondary]="mode === 'edit'" [class.btn-outline-secondary]="mode !== 'edit'" (click)="setMode('edit')" [disabled]="!entry">Edit</button>
      <button class="btn btn-sm" [class.btn-secondary]="mode === 'capture'" [class.btn-outline-secondary]="mode !== 'capture'" (click)="setMode('capture')">Capture</button>
    </div>
  </div>

  <div class="entry-body" *ngIf="mode === 'view' && entry as e">
    <div class="card entry-card">
      <div class="card-body">
        <h6 class="section-title">Source</h6>
        <div class="text-medium-emphasis">{{ e.source.publisher || 'Unknown publisher' }}</div>
        <div class="text-medium-emphasis">{{ e.source.url }}</div>
      </div>
    </div>

    <div class="card entry-card">
      <div class="card-body">
        <h6 class="section-title">Summary</h6>
        <div class="fw-semibold">{{ e.summary.one_line }}</div>
        <p class="text-medium-emphasis mb-2">{{ e.summary.short }}</p>
        <div class="tag-row">
          <span class="badge tag-badge" *ngFor="let tag of e.summary.tags">{{ tag }}</span>
        </div>
      </div>
    </div>

    <div class="card entry-card">
      <div class="card-body">
        <h6 class="section-title">Key Units</h6>
        <div class="unit-row" *ngFor="let unit of e.units">
          <div class="unit-type">{{ unit.type }}</div>
          <div class="unit-text">{{ unit.text }}</div>
        </div>
      </div>
    </div>

    <div class="card entry-card">
      <div class="card-body">
        <h6 class="section-title">Questions</h6>
        <ul class="mb-0">
          <li *ngFor="let q of e.questions.key_questions">{{ q.q }}</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="entry-body" *ngIf="mode === 'edit' && entry as e">
    <div class="card entry-card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <h6 class="section-title mb-0">Source</h6>
          <button class="btn btn-sm btn-outline-secondary" type="button" (click)="openLibraryLink()">Link Library</button>
        </div>
        <div class="row g-3 mt-1">
          <div class="col-md-6">
            <label class="form-label">Title</label>
            <input class="form-control form-control-sm" [value]="e.source.title" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Creator</label>
            <input class="form-control form-control-sm" [value]="e.source.creator" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Kind</label>
            <input class="form-control form-control-sm" [value]="e.source.kind" />
          </div>
          <div class="col-md-6">
            <label class="form-label">URL</label>
            <input class="form-control form-control-sm" [value]="e.source.url" />
          </div>
        </div>
      </div>
    </div>

    <div class="card entry-card">
      <div class="card-body">
        <h6 class="section-title">Summary</h6>
        <input class="form-control form-control-sm mb-2" [value]="e.summary.one_line" />
        <textarea class="form-control form-control-sm" rows="3">{{ e.summary.short }}</textarea>
        <div class="tag-row mt-2">
          <span class="badge tag-badge" *ngFor="let tag of e.summary.tags">{{ tag }}</span>
          <button class="btn btn-sm btn-outline-secondary" type="button">+ Tag</button>
        </div>
      </div>
    </div>

    <div class="card entry-card">
      <div class="card-body">
        <h6 class="section-title">Units</h6>
        <app-unit-editor
          *ngFor="let unit of e.units"
          [unit]="unit"
          (linkConcept)="openConceptPicker()"
        ></app-unit-editor>
        <button class="btn btn-sm btn-outline-secondary" type="button">+ Add Unit</button>
      </div>
    </div>

    <div class="card entry-card">
      <div class="card-body">
        <h6 class="section-title">Flow</h6>
        <div class="flow-row" *ngFor="let edge of e.flow.argument_edges">
          {{ edge.from }} {{ edge.relation }} {{ edge.to }}
        </div>
      </div>
    </div>

    <div class="card entry-card">
      <div class="card-body">
        <h6 class="section-title">Questions</h6>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Key questions</label>
            <textarea class="form-control form-control-sm" rows="3"></textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label">My questions</label>
            <textarea class="form-control form-control-sm" rows="3"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="entry-body" *ngIf="mode === 'capture'">
    <div class="card entry-card">
      <div class="card-body">
        <h6 class="section-title">Quick Capture</h6>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Kind</label>
            <select class="form-select form-select-sm" [(ngModel)]="captureDraft.kind">
              <option value="debate">debate</option>
              <option value="book">book</option>
              <option value="paper">paper</option>
              <option value="podcast">podcast</option>
              <option value="movie">movie</option>
              <option value="video">video</option>
              <option value="article">article</option>
              <option value="tweet">tweet</option>
              <option value="tiktok">tiktok</option>
              <option value="org">org</option>
              <option value="thinktank">thinktank</option>
              <option value="website">website</option>
              <option value="course">course</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Title</label>
            <input class="form-control form-control-sm" [(ngModel)]="captureDraft.title" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Creator</label>
            <input class="form-control form-control-sm" [(ngModel)]="captureDraft.creator" />
          </div>
          <div class="col-md-6">
            <label class="form-label">URL</label>
            <input class="form-control form-control-sm" [(ngModel)]="captureDraft.url" />
          </div>
          <div class="col-12">
            <label class="form-label">One-line summary</label>
            <input class="form-control form-control-sm" [(ngModel)]="captureDraft.oneLine" />
          </div>
          <div class="col-12">
            <label class="form-label">First unit</label>
            <div class="row g-2">
              <div class="col-md-3">
                <select class="form-select form-select-sm" [(ngModel)]="captureDraft.unitType">
                  <option value="claim">claim</option>
                  <option value="argument">argument</option>
                  <option value="definition">definition</option>
                  <option value="scene">scene</option>
                  <option value="theme">theme</option>
                </select>
              </div>
              <div class="col-md-9">
                <input class="form-control form-control-sm" [(ngModel)]="captureDraft.unitText" />
              </div>
            </div>
          </div>
        </div>
        <button class="btn btn-primary btn-sm mt-3" type="button" (click)="saveDraft()">Save Draft</button>
      </div>
    </div>
  </div>
</div>

<app-concept-picker-modal *ngIf="showConceptPicker" (close)="closeModals()"></app-concept-picker-modal>
<app-library-link-modal *ngIf="showLibraryLink" (close)="closeModals()"></app-library-link-modal>
