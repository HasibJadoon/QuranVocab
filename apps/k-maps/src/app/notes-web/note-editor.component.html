<section class="note-editor">
  @if (!currentNoteId()) {
    <div class="empty-state">
      <h3>Select a note</h3>
      <p>Create a quick draft and attach it later.</p>
    </div>
  } @else if (loading()) {
    <div class="loading-state">
      <span class="sk sk-title"></span>
      <span class="sk sk-line"></span>
      <span class="sk sk-line"></span>
      <span class="sk sk-line"></span>
      <span class="sk sk-line short"></span>
    </div>
  } @else {
    <header class="editor-toolbar">
      <div class="toolbar-headings">
        <h2>{{ title }}</h2>
        <p class="save-indicator">{{ saveLabel }}</p>
      </div>

      <div class="toolbar-actions">
        <button type="button" class="action-btn" (click)="openAttachDialog()" [disabled]="!activeNote()">
          Attach
        </button>
        <button
          type="button"
          class="action-btn"
          (click)="toggleArchive()"
          [disabled]="archivePending() || !activeNote()"
        >
          {{ isArchived ? 'Unarchive' : 'Archive' }}
        </button>
      </div>
    </header>

    @if (links().length > 0) {
      <div class="chips-row">
        @for (link of links(); track trackLink($index, link)) {
          <div class="chip">
            <span class="chip-icon">{{ chipIcon(link.target_type) }}</span>
            <span class="chip-label">{{ link.ref || link.target_id }}</span>
            <button type="button" class="chip-remove" (click)="removeLink(link)" aria-label="Remove link">
              Ã—
            </button>
          </div>
        }
      </div>
    }

    <textarea
      [formControl]="bodyControl"
      class="editor-area"
      placeholder="Write in Markdown..."
      spellcheck="true"
    ></textarea>

    <section class="comments-panel">
      <header class="comments-head">
        <h3>Comments</h3>
        <button
          type="button"
          class="action-btn"
          (click)="refreshComments()"
          [disabled]="!activeNote() || commentsLoading()"
        >
          Refresh
        </button>
      </header>

      @if (commentsLoading()) {
        <p class="comments-state">Loading comments...</p>
      } @else if (comments().length > 0) {
        <ul class="comments-list">
          @for (comment of comments(); track trackComment($index, comment)) {
            <li class="comment-item">
              <p class="comment-body">{{ comment.body_md }}</p>
              <p class="comment-time">{{ comment.created_at | date: 'MMM d, h:mm a' }}</p>
            </li>
          }
        </ul>
      } @else {
        <p class="comments-state">No comments yet.</p>
      }

      <div class="comment-compose">
        <textarea
          [formControl]="commentControl"
          class="comment-input"
          placeholder="Add a comment..."
          rows="2"
        ></textarea>
        <button
          type="button"
          class="action-btn"
          (click)="submitComment()"
          [disabled]="commentsSubmitting() || !commentControl.value.trim()"
        >
          {{ commentsSubmitting() ? 'Posting...' : 'Comment' }}
        </button>
      </div>
    </section>

    @if (commentsError()) {
      <p class="error-text">{{ commentsError() }}</p>
    }

    @if (error()) {
      <p class="error-text">{{ error() }}</p>
    }

    <app-attach-dialog
      [open]="attachDialogOpen()"
      [noteId]="activeNote()?.id ?? null"
      (closed)="closeAttachDialog()"
      (attached)="onLinkAttached($event)"
    ></app-attach-dialog>
  }
</section>
